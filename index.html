<!DOCTYPE html>
<html lang="es">
<head>
          <!-- Favicon para navegadores -->
<link rel="icon" type="image/png" sizes="32x32" href="icon.png">
<link rel="icon" type="image/png" sizes="16x16" href="icon.png">

<!-- Para compatibilidad con algunos navegadores antiguos -->
<link rel="shortcut icon" href="icon.png" type="image/png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de An√°lisis Operativo</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #0f1419;
            color: #e5e7eb;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Navigation */
        .sidebar {
            width: 250px;
            background: #1a1f2e;
            border-right: 1px solid #2d3748;
            padding: 0;
            position: fixed;
            height: 100vh;
            z-index: 1000;
            transition: width 0.3s ease;
            overflow: hidden;
        }

        .sidebar.collapsed {
            width: 70px;
        }

        .sidebar-header {
            padding: 1.25rem;
            border-bottom: 1px solid #2d3748;
            white-space: nowrap;
            display: flex;
            justify-content: flex-start;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.625rem;
            font-size: 1.125rem;
            font-weight: 600;
            color: #3b82f6;
        }

        .logo i {
            font-size: 1.375rem;
            min-width: 1.375rem;
            flex-shrink: 0;
            display: inline-block;
        }

        .logo-text {
            transition: opacity 0.3s ease, width 0.3s ease;
            overflow: hidden;
        }

        .sidebar.collapsed .logo-text {
            opacity: 0;
            width: 0;
        }

        .sidebar.collapsed .sidebar-header {
            justify-content: center;
            padding: 1.25rem 0;
        }

        .nav-menu {
            padding: 0.875rem 0;
        }

        .nav-item {
            margin: 0.25rem 0.875rem;
            padding: 0.625rem 0.875rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.625rem;
            color: #9ca3af;
            text-decoration: none;
            font-size: 0.875rem;
            white-space: nowrap;
            position: relative;
        }

        .nav-item:hover {
            background: #2d3748;
            color: #e5e7eb;
        }

        .nav-item.active {
            background: #1e40af;
            color: white;
        }

        .nav-item i {
            min-width: 1.125rem;
            text-align: center;
            flex-shrink: 0;
            display: inline-block;
        }

        .nav-item-text {
            transition: opacity 0.3s ease, width 0.3s ease;
            overflow: hidden;
        }

        .sidebar.collapsed .nav-item-text {
            opacity: 0;
            width: 0;
        }

        .sidebar.collapsed .nav-item {
            justify-content: center;
            padding: 0.625rem 0;
            margin: 0.25rem auto;
            width: 50px;
        }

        /* Tooltip para iconos cuando el sidebar est√° colapsado */
        .sidebar.collapsed .nav-item:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 100%;
            margin-left: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: #374151;
            color: #f9fafb;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            white-space: nowrap;
            z-index: 1001;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 250px;
            background: #0f1419;
            transition: margin-left 0.3s ease;
        }

        .main-content.sidebar-collapsed {
            margin-left: 70px;
        }

        .header {
            background: #1a1f2e;
            border-bottom: 1px solid #2d3748;
            padding: 0.875rem 1.75rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* Bot√≥n para toggle del sidebar */
        .sidebar-toggle {
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-toggle:hover {
            background: #374151;
            color: #e5e7eb;
        }

        .page-title {
            font-size: 1.375rem;
            font-weight: 600;
            color: #f9fafb;
        }

        .breadcrumb {
            font-size: 0.8125rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .breadcrumb span {
            color: #3b82f6;
        }

        /* Content Area */
        .content-area {
            padding: 1.25rem;
            max-width: none;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards */
        .card {
            background: #1a1f2e;
            border: 1px solid #2d3748;
            border-radius: 0.625rem;
            padding: 1.25rem;
            margin-bottom: 1.25rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
            border-bottom: 1px solid #2d3748;
            padding-bottom: 0.875rem;
        }

        .card-title {
            font-size: 1.0625rem;
            font-weight: 600;
            color: #f9fafb;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-title i {
            color: #3b82f6;
        }

        /* Buttons */
        .btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 0.4375rem;
            font-size: 0.8125rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.4375rem;
            text-decoration: none;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #374151;
            color: #e5e7eb;
            border: 1px solid #4b5563;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-success {
            background: #059669;
            color: white;
        }

        .btn-success:hover {
            background: #047857;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* File Upload */
        .file-upload-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .file-upload-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8125rem;
            color: #e5e7eb;
        }

        .file-status {
            font-size: 0.6875rem;
            color: #9ca3af;
        }

        .file-status.success {
            color: #10b981;
        }

        /* Dataset Tabs */
        .dataset-tabs {
            display: flex;
            background: #111827;
            border-radius: 0.5rem;
            padding: 0.25rem;
            gap: 0.25rem;
        }

        .dataset-tab {
            flex: 1;
            padding: 0.5rem 0.75rem;
            border: none;
            background: transparent;
            color: #9ca3af;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .dataset-tab:hover {
            background: #374151;
            color: #e5e7eb;
        }

        .dataset-tab.active {
            background: #3b82f6;
            color: white;
        }

        .dataset-tab.has-results {
            border: 2px solid #10b981;
        }

        .dataset-tab .tab-text {
            display: block;
        }

        .file-upload-area {
            border: 2px dashed #4b5563;
            border-radius: 0.5rem;
            padding: 1.25rem;
            text-align: center;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .file-upload-area:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.05);
        }

        .upload-icon {
            font-size: 2rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .upload-text {
            font-size: 0.875rem;
            color: #e5e7eb;
            margin-bottom: 0.25rem;
        }

        .upload-subtext {
            font-size: 0.75rem;
            color: #9ca3af;
        }

        .file-input {
            display: none;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 0.875rem;
        }

        .form-label {
            display: block;
            font-size: 0.8125rem;
            font-weight: 600;
            color: #e5e7eb;
            margin-bottom: 0.4375rem;
        }

        .form-control {
            width: 100%;
            padding: 0.625rem;
            background: #111827;
            border: 1px solid #374151;
            border-radius: 0.4375rem;
            color: #e5e7eb;
            font-size: 0.8125rem;
        }

        .form-control:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Operatives */
        .controls-bar {
            display: flex;
            gap: 0.875rem;
            align-items: center;
            margin-bottom: 1.125rem;
            flex-wrap: wrap;
        }

        .search-box {
            position: relative;
            flex: 1;
            min-width: 275px;
        }

        .search-input {
            width: 100%;
            padding: 0.625rem 0.875rem 0.625rem 2.25rem;
            background: #111827;
            border: 1px solid #374151;
            border-radius: 0.4375rem;
            color: #e5e7eb;
            font-size: 0.8125rem;
        }

        .search-icon {
            position: absolute;
            left: 0.625rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
        }

        .operatives-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 0.875rem;
        }

        .operative-card {
            background: #111827;
            border: 1px solid #374151;
            border-radius: 0.625rem;
            padding: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .operative-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
        }

        .operative-card.selected {
            border-color: #059669;
            background: rgba(5, 150, 105, 0.1);
        }

        .operative-header {
            display: flex;
            align-items: center;
            gap: 0.625rem;
            margin-bottom: 0.625rem;
        }

        .operative-checkbox {
            width: 1.125rem;
            height: 1.125rem;
            accent-color: #3b82f6;
        }

        .operative-name {
            font-weight: 600;
            color: #f9fafb;
            font-size: 0.875rem;
        }

        .operative-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.4375rem;
            font-size: 0.6875rem;
            color: #9ca3af;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
        }

        .detail-value {
            color: #e5e7eb;
            font-weight: 500;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
            gap: 1rem;
            margin-bottom: 1.25rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            border-radius: 0.625rem;
            padding: 1rem;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .stat-card.danger { background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); }
        .stat-card.warning { background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%); }
        .stat-card.success { background: linear-gradient(135deg, #059669 0%, #10b981 100%); }
        .stat-card.info { background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%); }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .stat-title {
            font-size: 0.75rem;
            opacity: 0.9;
            font-weight: 500;
        }

        .stat-icon {
            font-size: 1.25rem;
            opacity: 0.8;
        }

        .stat-number {
            font-size: 2.125rem;
            font-weight: 700;
            line-height: 1;
        }

        /* Filters */
        .filters-section {
            background: #111827;
            border: 1px solid #374151;
            border-radius: 0.625rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .filters-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #f9fafb;
        }

        .filters-row {
            display: grid;
            grid-template-columns: auto auto auto auto 1fr;
            gap: 0.75rem;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .filter-label {
            font-weight: 600;
            color: #e5e7eb;
            white-space: nowrap;
            font-size: 0.75rem;
        }

        .filter-select {
            padding: 0.375rem;
            background: #0f1419;
            border: 1px solid #374151;
            border-radius: 0.3125rem;
            color: #e5e7eb;
            font-size: 0.75rem;
            min-width: 125px;
        }

        /* Multi-select filters */
        .multi-select-container {
            position: relative;
            display: inline-block;
            min-width: 160px;
        }

        .multi-select-trigger {
            padding: 0.375rem 0.75rem;
            background: #0f1419;
            border: 1px solid #374151;
            border-radius: 0.3125rem;
            color: #e5e7eb;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            min-height: 32px;
        }

        .multi-select-trigger:hover {
            border-color: #4b5563;
        }

        .multi-select-trigger.active {
            border-color: #3b82f6;
        }

        .multi-select-arrow {
            transition: transform 0.2s ease;
            color: #9ca3af;
        }

        .multi-select-trigger.active .multi-select-arrow {
            transform: rotate(180deg);
        }

        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 0.375rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            margin-top: 2px;
        }

        .multi-select-dropdown.show {
            display: block;
        }

        .multi-select-clear {
            padding: 0.5rem 0.75rem;
            background: #374151;
            color: #e5e7eb;
            font-size: 0.6875rem;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            border-bottom: 1px solid #4b5563;
            transition: background 0.2s ease;
        }

        .multi-select-clear:hover {
            background: #4b5563;
        }

        .multi-select-option {
            padding: 0.5rem 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-size: 0.75rem;
            color: #e5e7eb;
            border-bottom: 1px solid #374151;
        }

        .multi-select-option:last-child {
            border-bottom: none;
        }

        .multi-select-option:hover {
            background: #374151;
        }

        .multi-select-option input[type="checkbox"] {
            width: 14px;
            height: 14px;
            accent-color: #3b82f6;
        }

        .multi-select-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .multi-select-count {
            background: #3b82f6;
            color: white;
            font-size: 0.625rem;
            font-weight: 600;
            padding: 0.125rem 0.375rem;
            border-radius: 9999px;
            margin-left: 0.25rem;
        }

        .percentage-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #374151;
        }

        .percentage-filter {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
        }

        .percentage-filter label {
            font-size: 0.6875rem;
            color: #9ca3af;
            font-weight: 500;
        }

        .filter-row {
            display: flex;
            gap: 0.375rem;
            align-items: center;
        }

        .comparison-select {
            flex: 0 0 50px;
            padding: 0.375rem;
            background: #0f1419;
            border: 1px solid #374151;
            border-radius: 0.3125rem;
            color: #e5e7eb;
            font-size: 0.6875rem;
        }

        .filter-input {
            flex: 1;
            padding: 0.375rem;
            background: #0f1419;
            border: 1px solid #374151;
            border-radius: 0.3125rem;
            color: #e5e7eb;
            font-size: 0.6875rem;
        }

        .threshold-section {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #374151;
        }

        .threshold-filter {
            max-width: 275px;
        }

        .filter-info {
            margin-top: 0.375rem;
            font-size: 0.6875rem;
            color: #9ca3af;
            font-style: italic;
        }

        /* Table */
        .results-container {
            background: #1a1f2e;
            border: 1px solid #2d3748;
            border-radius: 0.625rem;
            overflow: hidden;
        }

        .table-header {
            background: #111827;
            padding: 0.75rem 1.125rem;
            border-bottom: 1px solid #2d3748;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 1rem;
            font-weight: 600;
            color: #f9fafb;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #111827;
            color: #f9fafb;
            padding: 0.625rem 0.4375rem;
            font-weight: 600;
            text-align: left;
            font-size: 0.75rem;
            border-bottom: 1px solid #2d3748;
        }

        td {
            padding: 0.5rem 0.4375rem;
            border-bottom: 1px solid #2d3748;
            font-size: 0.75rem;
        }

        tr:hover {
            background: rgba(59, 130, 246, 0.05);
        }

        /* Progress bars */
        .progress-cell {
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .progress-bar {
            flex: 1;
            height: 0.4375rem;
            background: #374151;
            border-radius: 9999px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.6875rem;
            font-weight: 500;
            min-width: 2.75rem;
            text-align: right;
        }

        /* Percentage badges */
        .percentage-badge {
            padding: 0.3125rem 0.625rem;
            border-radius: 0.3125rem;
            font-size: 0.6875rem;
            font-weight: 600;
            text-align: center;
            color: white;
            min-width: 3rem;
            display: inline-block;
        }

        /* Asegurar subrayado en enlaces de badges */
        a .percentage-badge {
            text-decoration: underline !important;
        }

        .percentage-excellent {
            background: #059669;
        }

        .percentage-very-good {
            background: #10b981;
        }

        .percentage-good {
            background: #84cc16;
        }

        .percentage-fair {
            background: #f59e0b;
        }

        .percentage-poor {
            background: #ef4444;
        }

        .percentage-very-poor {
            background: #dc2626;
        }

        /* Status badges */
        .status-badge {
            padding: 0.25rem 0.625rem;
            border-radius: 9999px;
            font-size: 0.6875rem;
            font-weight: 500;
            text-align: center;
            white-space: nowrap;
        }

        .status-danger {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .status-warning {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .status-success {
            background: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status-info {
            background: rgba(6, 182, 212, 0.2);
            color: #67e8f9;
            border: 1px solid rgba(6, 182, 212, 0.3);
        }

        /* Summary table */
        .summary-table-container {
            background: #1a1f2e;
            border: 1px solid #2d3748;
            border-radius: 0.625rem;
            overflow: hidden;
            position: relative;
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
        }

        .summary-table th {
            padding: 0.875rem;
            text-align: center;
            font-weight: 600;
            color: #1f2937;
            font-size: 0.8125rem;
        }

        .summary-table td {
            padding: 0.875rem;
            text-align: center;
            border-bottom: 1px solid #2d3748;
            font-size: 0.8125rem;
        }

        /* Tooltip para operativas */
        .tooltip-cell {
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .tooltip-cell:hover {
            background: rgba(59, 130, 246, 0.1);
        }

        .tooltip {
            position: fixed;
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 0.5rem;
            padding: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            z-index: 1001;
            min-width: 200px;
            max-width: 300px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
            font-size: 0.75rem;
            line-height: 1.4;
            pointer-events: none;
        }

        .tooltip.visible {
            opacity: 1;
            visibility: visible;
        }

        .tooltip-title {
            font-weight: 600;
            color: #e5e7eb;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid #374151;
            padding-bottom: 0.25rem;
        }

        .tooltip-content {
            color: #d1d5db;
        }

        .tooltip-operativa {
            padding: 0.125rem 0;
            font-size: 0.6875rem;
        }

        /* Settings */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(275px, 1fr));
            gap: 1.25rem;
            margin-bottom: 1.75rem;
        }

        .setting-card {
            background: #111827;
            border: 1px solid #374151;
            border-radius: 0.625rem;
            padding: 1.25rem;
        }

        .setting-label {
            display: block;
            font-weight: 600;
            color: #f9fafb;
            margin-bottom: 0.625rem;
            font-size: 0.8125rem;
        }

        .setting-input {
            width: 100%;
            padding: 0.625rem;
            background: #0f1419;
            border: 1px solid #374151;
            border-radius: 0.4375rem;
            color: #e5e7eb;
            font-size: 0.9375rem;
            font-weight: 600;
            text-align: center;
        }

        .setting-description {
            font-size: 0.6875rem;
            color: #9ca3af;
            margin-top: 0.4375rem;
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }

        /* Estilos para columna de comentarios */
        .comments-column {
            min-width: 200px;
            max-width: 300px;
        }

        .comments-hidden .comments-column {
            display: none !important;
        }

        .comment-input {
            width: 100%;
            min-height: 60px;
            padding: 0.5rem;
            background: #0f1419;
            border: 1px solid #374151;
            border-radius: 0.375rem;
            color: #e5e7eb;
            font-size: 0.6875rem;
            resize: vertical;
        }

        .comment-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .comments-toggle-btn {
            margin-left: 0.5rem;
        }

        /* Bot√≥n icono para eliminar */
        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
            font-size: 1rem;
        }

        .icon-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            transform: scale(1.1);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-250px);
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .content-area {
                padding: 0.875rem;
            }

            .filters-row {
                grid-template-columns: 1fr;
                gap: 0.625rem;
            }

            .percentage-filters {
                grid-template-columns: 1fr;
            }

            .header-left {
                gap: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <div class="sidebar collapsed">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-chart-line"></i>
                    <span class="logo-text">An√°lisis Operativo</span>
                </div>
            </div>
            <nav class="nav-menu">
                <a href="#" class="nav-item active" data-tab="analysis" data-tooltip="An√°lisis">
                    <i class="fas fa-chart-line"></i>
                    <span class="nav-item-text">An√°lisis</span>
                </a>
                <a href="#" class="nav-item" data-tab="summary" data-tooltip="Resumen">
                    <i class="fas fa-chart-bar"></i>
                    <span class="nav-item-text">Resumen</span>
                </a>
                <a href="#" class="nav-item" data-tab="settings" data-tooltip="Configuraci√≥n">
                    <i class="fas fa-cogs"></i>
                    <span class="nav-item-text">Configuraci√≥n</span>
                </a>
                <a href="#" class="nav-item" data-tab="registro" data-tooltip="Registro">
                    <i class="fas fa-clipboard-list"></i>
                    <span class="nav-item-text">Registro</span>
                </a>
                <a href="#" class="nav-item" data-tab="informe" data-tooltip="Informe Mensual">
                    <i class="fas fa-file-alt"></i>
                    <span class="nav-item-text">Informe Mensual</span>
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content sidebar-collapsed">
            <!-- Header -->
            <div class="header">
                <div class="header-content">
                    <div class="header-left">
                        <button id="sidebarToggle" class="sidebar-toggle" title="Ocultar/Mostrar men√∫">
                            <i class="fas fa-bars"></i>
                        </button>
                        <div>
                            <h1 class="page-title" id="pageTitle">Dashboard de An√°lisis</h1>
                            <div class="breadcrumb">
                                
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Analysis Tab -->
                <div id="analysisTab" class="tab-content active">
                    <!-- File Upload Card -->
                    <div class="card">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                            <h2 class="card-title" style="margin: 0;">
                                <i class="fas fa-upload"></i>
                                Cargar Datos (hasta 4 archivos)
                            </h2>
                            
                            <!-- Selector de fechas para Metabase -->
                            <div style="display: flex; align-items: center; gap: 0.75rem; background: #374151; padding: 0.75rem 1rem; border-radius: 0.5rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <label style="font-size: 0.875rem; color: #d1d5db; white-space: nowrap;">Desde:</label>
                                    <input type="date" id="metabaseFechaInicio" style="padding: 0.375rem 0.5rem; background: #1a1f2e; border: 1px solid #4b5563; border-radius: 0.375rem; color: #e5e7eb; font-size: 0.875rem;" />
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <label style="font-size: 0.875rem; color: #d1d5db; white-space: nowrap;">Hasta:</label>
                                    <input type="date" id="metabaseFechaFin" style="padding: 0.375rem 0.5rem; background: #1a1f2e; border: 1px solid #4b5563; border-radius: 0.375rem; color: #e5e7eb; font-size: 0.875rem;" />
                                </div>
                                <a id="metabaseLink" href="#" target="_blank" class="btn btn-primary" style="white-space: nowrap; text-decoration: none;">
                                    <i class="fas fa-external-link-alt"></i>
                                    Abrir en Metabase
                                </a>
                            </div>
                        </div>
                        
                        <!-- File Upload Grid -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                            <!-- Archivo 1 -->
                            <div class="file-upload-container">
                                <div class="file-upload-header">
                                    <strong>Archivo 1</strong>
                                    <span id="fileName1" class="file-status"></span>
                                </div>
                                <div class="file-upload-area" onclick="document.getElementById('csvFile1').click()">
                                    <div class="upload-icon">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                    </div>
                                    <div class="upload-text" style="font-size: 0.875rem;">Semana 1</div>
                                    <div class="upload-subtext">CSV archivo</div>
                                    <input type="file" id="csvFile1" class="file-input" accept=".csv" />
                                </div>
                            </div>

                            <!-- Archivo 2 -->
                            <div class="file-upload-container">
                                <div class="file-upload-header">
                                    <strong>Archivo 2</strong>
                                    <span id="fileName2" class="file-status"></span>
                                </div>
                                <div class="file-upload-area" onclick="document.getElementById('csvFile2').click()">
                                    <div class="upload-icon">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                    </div>
                                    <div class="upload-text" style="font-size: 0.875rem;">Semana 2</div>
                                    <div class="upload-subtext">CSV archivo (opcional)</div>
                                    <input type="file" id="csvFile2" class="file-input" accept=".csv" />
                                </div>
                            </div>

                            <!-- Archivo 3 -->
                            <div class="file-upload-container">
                                <div class="file-upload-header">
                                    <strong>Archivo 3</strong>
                                    <span id="fileName3" class="file-status"></span>
                                </div>
                                <div class="file-upload-area" onclick="document.getElementById('csvFile3').click()">
                                    <div class="upload-icon">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                    </div>
                                    <div class="upload-text" style="font-size: 0.875rem;">Semana 3</div>
                                    <div class="upload-subtext">CSV archivo (opcional)</div>
                                    <input type="file" id="csvFile3" class="file-input" accept=".csv" />
                                </div>
                            </div>

                            <!-- Archivo 4 -->
                            <div class="file-upload-container">
                                <div class="file-upload-header">
                                    <strong>Archivo 4</strong>
                                    <span id="fileName4" class="file-status"></span>
                                </div>
                                <div class="file-upload-area" onclick="document.getElementById('csvFile4').click()">
                                    <div class="upload-icon">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                    </div>
                                    <div class="upload-text" style="font-size: 0.875rem;">Semana 4</div>
                                    <div class="upload-subtext">CSV archivo (opcional)</div>
                                    <input type="file" id="csvFile4" class="file-input" accept=".csv" />
                                </div>
                            </div>
                        </div>

                        <!-- Dataset Selection Tabs -->
                        <div id="datasetTabs" class="hidden" style="margin-top: 1.5rem;">
                            <div class="dataset-tabs">
                                <button id="datasetTab0" class="dataset-tab active" onclick="switchDataset(0)">
                                    <span class="tab-text">Archivo 1</span>
                                </button>
                                <button id="datasetTab1" class="dataset-tab hidden" onclick="switchDataset(1)">
                                    <span class="tab-text">Archivo 2</span>
                                </button>
                                <button id="datasetTab2" class="dataset-tab hidden" onclick="switchDataset(2)">
                                    <span class="tab-text">Archivo 3</span>
                                </button>
                                <button id="datasetTab3" class="dataset-tab hidden" onclick="switchDataset(3)">
                                    <span class="tab-text">Archivo 4</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Operatives Selection -->
                    <div id="operativesCard" class="card hidden" style="display: none !important;">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-tasks"></i>
                                Seleccionar Operativas
                            </h2>
                        </div>

                        <div class="controls-bar">
                            <div class="search-box">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" id="searchInput" class="search-input" placeholder="Buscar operativas...">
                            </div>
                            <select id="colmenaFilter" class="form-control" style="max-width: 170px;">
                                <option value="">Todas las Colmenas</option>
                            </select>
                            <button id="selectAllBtn" class="btn btn-secondary">
                                <i class="fas fa-check-square"></i>
                                Seleccionar Todas
                            </button>
                            <button id="analyzeBtn" class="btn btn-primary" disabled>
                                <i class="fas fa-play"></i>
                                Analizar
                            </button>
                            <button id="toggleSelectionBtn" class="btn btn-secondary">
                                <i class="fas fa-chevron-up"></i>
                                Ocultar
                            </button>
                        </div>

                        <div class="operatives-container">
                            <div id="selectionInfo" style="margin-bottom: 0.875rem; color: #9ca3af; font-size: 0.8125rem;">0 operativas seleccionadas</div>
                            <div id="operativesGrid" class="operatives-grid"></div>
                        </div>
                    </div>

                    <!-- Results -->
                    <div id="resultsSection" class="hidden">
                        <!-- Stats Grid -->
                        <div id="statsGrid" class="stats-grid"></div>

                        <!-- Filters Section -->
                        <div class="filters-section">
                            <div class="filters-header">
                                <h3 class="filters-title">
                                    <i class="fas fa-filter"></i>
                                    Filtros Avanzados
                                </h3>
                                <button id="clearFiltersBtn" class="btn btn-secondary">
                                    <i class="fas fa-times"></i>
                                    Limpiar Filtros
                                </button>
                            </div>
                            
                            <div class="filters-row">
                                <div class="filter-group">
                                    <label class="filter-label">üè¢ Colmena:</label>
                                    <div class="multi-select-container" id="colmenaMultiSelect">
                                        <div class="multi-select-trigger" onclick="toggleMultiSelect('colmena')">
                                            <span class="multi-select-text" id="colmenaSelectedText">Todas</span>
                                            <span class="multi-select-arrow"><i class="fas fa-chevron-down"></i></span>
                                        </div>
                                        <div class="multi-select-dropdown" id="colmenaDropdown">
                                            <!-- Options will be populated dynamically -->
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="filter-group">
                                    <label class="filter-label">üìç √Årea:</label>
                                    <div class="multi-select-container" id="areaMultiSelect">
                                        <div class="multi-select-trigger" onclick="toggleMultiSelect('area')">
                                            <span class="multi-select-text" id="areaSelectedText">Todas</span>
                                            <span class="multi-select-arrow"><i class="fas fa-chevron-down"></i></span>
                                        </div>
                                        <div class="multi-select-dropdown" id="areaDropdown">
                                            <!-- Options will be populated dynamically -->
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="filter-group">
                                    <label class="filter-label">üïí Turno:</label>
                                    <div class="multi-select-container" id="turnoMultiSelect">
                                        <div class="multi-select-trigger" onclick="toggleMultiSelect('turno')">
                                            <span class="multi-select-text" id="turnoSelectedText">Todos</span>
                                            <span class="multi-select-arrow"><i class="fas fa-chevron-down"></i></span>
                                        </div>
                                        <div class="multi-select-dropdown" id="turnoDropdown">
                                            <!-- Options will be populated dynamically -->
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="filter-group">
                                    <label class="filter-label">üéØ Clasificaci√≥n:</label>
                                    <div class="multi-select-container" id="clasificacionMultiSelect">
                                        <div class="multi-select-trigger" onclick="toggleMultiSelect('clasificacion')">
                                            <span class="multi-select-text" id="clasificacionSelectedText">Todas</span>
                                            <span class="multi-select-arrow"><i class="fas fa-chevron-down"></i></span>
                                        </div>
                                        <div class="multi-select-dropdown" id="clasificacionDropdown">
                                            <!-- Options will be populated dynamically -->
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="filter-group">
                                    <span id="resultsFilterInfo" style="color: #9ca3af; font-style: italic; font-size: 0.6875rem;"></span>
                                </div>
                            </div>
                            
                            <div class="percentage-filters">
                                <div class="percentage-filter">
                                    <label>üìä % Salida en Hora</label>
                                    <div class="filter-row">
                                        <select id="salidaComparison" class="comparison-select">
                                            <option value="">-</option>
                                            <option value="gte">‚â•</option>
                                            <option value="lt"><</option>
                                        </select>
                                        <input type="number" id="salidaValue" class="filter-input" placeholder="%" min="0" max="100" step="0.1">
                                    </div>
                                </div>
                                
                                <div class="percentage-filter">
                                    <label>üìä % Llegada √Årea</label>
                                    <div class="filter-row">
                                        <select id="llegadaAreaComparison" class="comparison-select">
                                            <option value="">-</option>
                                            <option value="gte">‚â•</option>
                                            <option value="lt"><</option>
                                        </select>
                                        <input type="number" id="llegadaAreaValue" class="filter-input" placeholder="%" min="0" max="100" step="0.1">
                                    </div>
                                </div>
                                
                                <div class="percentage-filter">
                                    <label>üìä % Retraso en √Årea</label>
                                    <div class="filter-row">
                                        <select id="retrasoAreaComparison" class="comparison-select">
                                            <option value="">-</option>
                                            <option value="gte">‚â•</option>
                                            <option value="lt"><</option>
                                        </select>
                                        <input type="number" id="retrasoAreaValue" class="filter-input" placeholder="%" min="0" max="100" step="0.1">
                                    </div>
                                </div>
                                
                                <div class="percentage-filter">
                                    <label>üìä % Llegada en Hora</label>
                                    <div class="filter-row">
                                        <select id="llegadaHoraComparison" class="comparison-select">
                                            <option value="">-</option>
                                            <option value="gte">‚â•</option>
                                            <option value="lt"><</option>
                                        </select>
                                        <input type="number" id="llegadaHoraValue" class="filter-input" placeholder="%" min="0" max="100" step="0.1">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="threshold-section">
                                <div class="percentage-filter threshold-filter">
                                    <label>üî¢ Mostrar operativas con % retrasos</label>
                                    <div class="filter-row">
                                        <select id="retrasosComparisonFilter" class="comparison-select" style="flex: 0 0 50px;">
                                            <option value="">-</option>
                                            <option value="gte">‚â•</option>
                                            <option value="lt"><</option>
                                        </select>
                                        <input type="number" id="retrasosThresholdFilter" class="filter-input" 
                                               placeholder="Ej: 15" min="0" max="100" step="0.1">
                                    </div>
                                </div>
                                
                                <!-- Filtro por diferencias de tiempo mejorado -->
                                <div class="percentage-filter threshold-filter">
                                    <label>‚è±Ô∏è Mostrar operativas con diferencia de tiempo ‚â•</label>
                                    <div class="filter-row">
                                        <select id="tiempoDireccionFilter" class="comparison-select" style="flex: 0 0 120px;">
                                            <option value="any">Cualquier</option>
                                            <option value="more">M√°s tiempo que Objetivo</option>
                                            <option value="less">Menos tiempo que Objetivo</option>
                                        </select>
                                        <input type="number" id="tiempoDiferenciaFilter" class="filter-input" 
                                               placeholder="Ej: 5" min="0" step="0.1">
                                        <select id="tiempoTipoFilter" class="comparison-select" style="flex: 0 0 80px;">
                                            <option value="any">Ambos</option>
                                            <option value="ida">Ida</option>
                                            <option value="vuelta">Vuelta</option>
                                        </select>
                                    </div>
                                    <div class="filter-info">
                                        <small>Diferencia entre hist√≥rico/te√≥rico y Tempus</small>
                                    </div>
                                </div>
                                
                                <div class="filter-info">
                                    <span id="retrasosFilterInfo"></span>
                                    <span id="accionFilterInfo" style="margin-left: 1rem;"></span>
                                    <span id="tiempoFilterInfo" style="margin-left: 1rem;"></span>
                                    <span id="currentThresholdInfo" style="margin-left: 1rem;">TR‚â§60%, TL‚â§60%, H‚â•90%</span>
                                </div>
                            </div>
                        </div>

                        <!-- Results Table -->
                        <div class="results-container">
                            <div class="table-header">
                                <h3 class="table-title">
                                    <i class="fas fa-table"></i>
                                    <span id="currentResultsTitle">Resultados del An√°lisis</span>
                                </h3>
                                <div>
                                    <button id="toggleCommentsBtn" class="btn btn-secondary comments-toggle-btn" onclick="toggleCommentsColumn()">
                                        <i class="fas fa-comment-alt"></i>
                                        Mostrar Comentarios
                                    </button>
                                    <button id="downloadExcelBtn" class="btn btn-success" style="margin-left: 0.5rem;">
                                        <i class="fas fa-file-excel"></i>
                                        Descargar Excel
                                    </button>
                                    <button id="saveRegistroBtn" class="btn btn-success" style="margin-left: 0.5rem;">
                                        <i class="fas fa-save"></i>
                                        Guardar Registro
                                    </button>
                                </div>
                            </div>
                            <div class="table-container">
                                <table id="resultsTable" class="comments-hidden">
                                    <thead>
                                        <tr>
                                            <th>Operativa</th>
                                            <th>Repetida</th>
                                            <th>Rutas/D√≠a</th>
                                            <th>D√≠as</th>
                                            <th>Col/Ruta</th>
                                            <th>% Retrasos</th>
                                            <th>% Salida en Hora</th>
                                            <th>% Llegada √Årea</th>
                                            <th>% Retraso en √Årea</th>
                                            <th>% Llegada en Hora</th>
                                            <th>Clasificaci√≥n</th>
                                            <th>Problemas Volumen</th>
                                            <th>Posibles Acciones</th>
                                            <th>Acci√≥n</th>
                                            <th class="comments-column">Comentarios</th>
                                        </tr>
                                    </thead>
                                    <tbody id="resultsTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Summary Tab -->
                <div id="summaryTab" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-chart-pie"></i>
                                Resumen por Colmena
                            </h2>
                            <!-- Selector de semanas -->
                            <select id="summaryWeekSelector" class="form-control" style="max-width: 200px;" onchange="updateSummaryView()">
                                <option value="all">Todas las semanas</option>
                            </select>
                        </div>
                        <div id="summaryContent" class="hidden">
                            <div id="summaryTable"></div>
                        </div>
                        <div id="noSummaryData" style="text-align: center; padding: 2.5rem; color: #6b7280;">
                            <i class="fas fa-chart-bar" style="font-size: 2.75rem; margin-bottom: 0.875rem; color: #374151;"></i>
                            <h4 style="margin-bottom: 0.625rem; color: #9ca3af;">No hay datos disponibles</h4>
                            <p style="margin-bottom: 1.25rem;">Ejecuta un an√°lisis para ver el resumen por colmena</p>
                            <button onclick="switchTab('analysis')" class="btn btn-primary">
                                <i class="fas fa-play"></i>
                                Ir a An√°lisis
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="settingsTab" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-sliders-h"></i>
                                Configuraci√≥n de Umbrales
                            </h2>
                        </div>

                        <div class="settings-grid">
                            <div class="setting-card">
                                <label class="setting-label">
                                    <i class="fas fa-exclamation-triangle" style="color: #ef4444; margin-right: 0.5rem;"></i>
                                    Umbral Tensionada Retrasos (%)
                                </label>
                                <input type="number" id="tensionadaRetrasosInput" class="setting-input" value="60" min="0" max="100" step="1">
                                <div class="setting-description">M√°ximo % Retraso en √Årea para clasificaci√≥n cr√≠tica</div>
                            </div>

                            <div class="setting-card">
                                <label class="setting-label">
                                    <i class="fas fa-clock" style="color: #f59e0b; margin-right: 0.5rem;"></i>
                                    Umbral Tensionada Llegada (%)
                                </label>
                                <input type="number" id="tensionadaLlegadaInput" class="setting-input" value="60" min="0" max="100" step="1">
                                <div class="setting-description">M√°ximo % Llegada en Hora para clasificaci√≥n de atenci√≥n</div>
                            </div>

                            <div class="setting-card">
                                <label class="setting-label">
                                    <i class="fas fa-check-circle" style="color: #10b981; margin-right: 0.5rem;"></i>
                                    Umbral Holguras (%)
                                </label>
                                <input type="number" id="holguraInput" class="setting-input" value="90" min="0" max="100" step="1">
                                <div class="setting-description">M√≠nimo % para ambas m√©tricas de rendimiento √≥ptimo</div>
                            </div>
                        </div>

                        <div style="display: flex; justify-content: center;">
                            <button id="applyThreshold" class="btn btn-primary" disabled>
                                <i class="fas fa-save"></i>
                                Aplicar Configuraci√≥n
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Registro Tab -->
                <div id="registroTab" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-clipboard-list"></i>
                                Registro de Operativas
                            </h2>
                            <div>
                                <button class="btn btn-success" id="downloadRegistroExcelBtn" style="margin-right: 0.5rem;">
                                    <i class="fas fa-file-excel"></i>
                                    Descargar Excel
                                </button>
                                <button class="btn btn-secondary" id="reloadRegistroBtn">
                                    <i class="fas fa-sync-alt"></i>
                                    Actualizar
                                </button>
                            </div>
                        </div>
                        
                        <!-- Filtros -->
                        <div style="background: #374151; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                            <div style="flex: 1; min-width: 200px;">
                                <label style="display: block; font-size: 0.875rem; color: #d1d5db; margin-bottom: 0.375rem;">Filtrar por Semana</label>
                                <select id="filtroSemana" style="width: 100%; padding: 0.5rem; background: #1a1f2e; border: 1px solid #4b5563; border-radius: 0.375rem; color: #e5e7eb; font-size: 0.875rem;">
                                    <option value="">Todas las semanas</option>
                                </select>
                            </div>
                            <div style="flex: 1; min-width: 200px;">
                                <label style="display: block; font-size: 0.875rem; color: #d1d5db; margin-bottom: 0.375rem;">Filtrar por Colmena</label>
                                <select id="filtroColmena" style="width: 100%; padding: 0.5rem; background: #1a1f2e; border: 1px solid #4b5563; border-radius: 0.375rem; color: #e5e7eb; font-size: 0.875rem;">
                                    <option value="">Todas las colmenas</option>
                                </select>
                            </div>
                            <div style="flex: 1; min-width: 200px;">
                                <label style="display: block; font-size: 0.875rem; color: #d1d5db; margin-bottom: 0.375rem;">Filtrar por √Årea</label>
                                <select id="filtroArea" style="width: 100%; padding: 0.5rem; background: #1a1f2e; border: 1px solid #4b5563; border-radius: 0.375rem; color: #e5e7eb; font-size: 0.875rem;">
                                    <option value="">Todas las √°reas</option>
                                </select>
                            </div>
                            <div style="display: flex; gap: 0.5rem; align-items: flex-end;">
                                <button class="btn btn-secondary" id="limpiarFiltrosBtn" style="margin-top: 1.5rem;">
                                    <i class="fas fa-times"></i>
                                    Limpiar
                                </button>
                            </div>
                        </div>
                        
                        <div id="registroContainer">
                            <div style="text-align: center; padding: 3rem; color: #6b7280;">
                                <i class="fas fa-clipboard-list" style="font-size: 3rem; color: #374151; margin-bottom: 1rem;"></i>
                                <h3>Sin registros</h3>
                                <p>Los registros guardados aparecer√°n aqu√≠</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informe Mensual Tab -->
                <div id="informeTab" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-file-chart-line"></i>
                                Informe Mensual
                            </h2>
                            <div>
                                <button class="btn btn-primary" id="generarInformeBtn">
                                    <i class="fas fa-chart-pie"></i>
                                    Generar Informe
                                </button>
                                <button class="btn btn-success" id="downloadInformeExcelBtn" style="margin-left: 0.5rem;">
                                    <i class="fas fa-file-excel"></i>
                                    Descargar Excel
                                </button>
                            </div>
                        </div>
                        
                        <!-- Selector de Semanas -->
                        <div style="background: #374151; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                            <h3 style="color: #f9fafb; font-size: 1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-calendar-week"></i>
                                Seleccionar Semanas para el Informe
                            </h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
                                <div>
                                    <label style="display: block; font-size: 0.875rem; color: #d1d5db; margin-bottom: 0.5rem;">Desde Semana:</label>
                                    <select id="informeSemanaDesde" style="width: 100%; padding: 0.5rem; background: #1a1f2e; border: 1px solid #4b5563; border-radius: 0.375rem; color: #e5e7eb; font-size: 0.875rem;">
                                        <option value="">Seleccionar...</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.875rem; color: #d1d5db; margin-bottom: 0.5rem;">Hasta Semana:</label>
                                    <select id="informeSemanaHasta" style="width: 100%; padding: 0.5rem; background: #1a1f2e; border: 1px solid #4b5563; border-radius: 0.375rem; color: #e5e7eb; font-size: 0.875rem;">
                                        <option value="">Seleccionar...</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Contenedor del Informe -->
                        <div id="informeContainer">
                            <div style="text-align: center; padding: 3rem; color: #6b7280;">
                                <i class="fas fa-chart-line" style="font-size: 3rem; color: #374151; margin-bottom: 1rem;"></i>
                                <h3>Selecciona las semanas y genera el informe</h3>
                                <p>An√°lisis estad√≠stico de las operativas del per√≠odo seleccionado</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Variables globales
        let tensionadaRetrasosThreshold = 60;
        let tensionadaLlegadaThreshold = 60;
        let holguraThreshold = 90;
        let sidebarCollapsed = false;
        let commentsVisible = false;
        let operativeComments = {};
        let operativeActions = {}; // Guardar las acciones seleccionadas por operativa
        
        // Arrays para manejar m√∫ltiples datasets
        let datasets = [null, null, null, null];
        let datasetNames = ['', '', '', ''];
        let selectedOperativesByDataset = [new Set(), new Set(), new Set(), new Set()];
        let filteredOperativesByDataset = [[], [], [], []];
        let analysisResultsByDataset = [[], [], [], []];
        let availableColmenasByDataset = [new Set(), new Set(), new Set(), new Set()];
        
        let currentActiveDataset = 0;
        let isSelectionCollapsed = false;
        let filteredResults = [];
        let activeFilters = {
            colmena: [],
            area: [],
            turno: [],
            salidaComparison: '',
            salidaValue: '',
            llegadaAreaComparison: '',
            llegadaAreaValue: '',
            retrasoAreaComparison: '',
            retrasoAreaValue: '',
            llegadaHoraComparison: '',
            llegadaHoraValue: '',
            retrasosComparison: '',
            retrasosThreshold: '',
            tiempoDiferencia: '',
            tiempoDireccion: 'any',
            tiempoTipo: 'any',
            accionRecomendada: []
        };

        // Funci√≥n para inicializar el estado del sidebar al cargar la p√°gina
        function initializeSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            const toggleButton = document.getElementById('sidebarToggle');
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                sidebar.classList.remove('collapsed');
                mainContent.classList.remove('sidebar-collapsed');
                
                const icon = toggleButton.querySelector('i');
                icon.className = 'fas fa-chevron-right';
                toggleButton.title = 'Desplegar men√∫';
            } else {
                // En escritorio, mantener el estado collapsed inicial
                sidebar.classList.add('collapsed');
                mainContent.classList.add('sidebar-collapsed');
                sidebarCollapsed = true;
                
                const icon = toggleButton.querySelector('i');
                icon.className = 'fas fa-chevron-right';
                toggleButton.title = 'Desplegar men√∫';
            }
        }

        // Funci√≥n para toggle del sidebar
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            const toggleButton = document.getElementById('sidebarToggle');
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                sidebar.classList.toggle('mobile-open');
                const icon = toggleButton.querySelector('i');
                if (sidebar.classList.contains('mobile-open')) {
                    icon.className = 'fas fa-times';
                    toggleButton.title = 'Cerrar men√∫';
                } else {
                    icon.className = 'fas fa-chevron-right';
                    toggleButton.title = 'Desplegar men√∫';
                }
            } else {
                sidebarCollapsed = !sidebarCollapsed;
                sidebar.classList.toggle('collapsed', sidebarCollapsed);
                mainContent.classList.toggle('sidebar-collapsed', sidebarCollapsed);
                
                const icon = toggleButton.querySelector('i');
                if (sidebarCollapsed) {
                    icon.className = 'fas fa-chevron-right';
                    toggleButton.title = 'Desplegar men√∫';
                } else {
                    icon.className = 'fas fa-chevron-left';
                    toggleButton.title = 'Plegar men√∫';
                }
            }
        }

        // Funci√≥n para cerrar sidebar en m√≥vil al hacer clic fuera
        function handleOutsideClick(event) {
            const sidebar = document.querySelector('.sidebar');
            const toggleButton = document.getElementById('sidebarToggle');
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile && sidebar.classList.contains('mobile-open')) {
                if (!sidebar.contains(event.target) && !toggleButton.contains(event.target)) {
                    sidebar.classList.remove('mobile-open');
                    const icon = toggleButton.querySelector('i');
                    icon.className = 'fas fa-chevron-right';
                    toggleButton.title = 'Desplegar men√∫';
                }
            }
        }

        // Funci√≥n para manejar redimensionado de ventana
        function handleResize() {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            const toggleButton = document.getElementById('sidebarToggle');
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                sidebar.classList.remove('collapsed');
                mainContent.classList.remove('sidebar-collapsed');
                
                const icon = toggleButton.querySelector('i');
                if (sidebar.classList.contains('mobile-open')) {
                    icon.className = 'fas fa-times';
                    toggleButton.title = 'Cerrar men√∫';
                } else {
                    icon.className = 'fas fa-chevron-right';
                    toggleButton.title = 'Desplegar men√∫';
                }
            } else {
                sidebar.classList.remove('mobile-open');
                
                sidebar.classList.toggle('collapsed', sidebarCollapsed);
                mainContent.classList.toggle('sidebar-collapsed', sidebarCollapsed);
                
                const icon = toggleButton.querySelector('i');
                if (sidebarCollapsed) {
                    icon.className = 'fas fa-chevron-right';
                    toggleButton.title = 'Desplegar men√∫';
                } else {
                    icon.className = 'fas fa-chevron-left';
                    toggleButton.title = 'Plegar men√∫';
                }
            }
        }

        // Funci√≥n para toggle de columna de comentarios
        function toggleCommentsColumn() {
            const table = document.getElementById('resultsTable');
            const btn = document.getElementById('toggleCommentsBtn');
            
            commentsVisible = !commentsVisible;
            
            if (commentsVisible) {
                table.classList.remove('comments-hidden');
                btn.innerHTML = '<i class="fas fa-comment-alt"></i> Ocultar Comentarios';
            } else {
                table.classList.add('comments-hidden');
                btn.innerHTML = '<i class="fas fa-comment-alt"></i> Mostrar Comentarios';
            }
        }

        // Funci√≥n para guardar comentario
        function saveComment(operativa, comment) {
            operativeComments[operativa] = comment;
        }

        // Funci√≥n para obtener comentario
        function getComment(operativa) {
            return operativeComments[operativa] || '';
        }

        // Funci√≥n para guardar acci√≥n seleccionada
        function saveAction(operativa, action) {
            operativeActions[operativa] = action;
        }

        // Funci√≥n para obtener acci√≥n seleccionada
        function getAction(operativa) {
            return operativeActions[operativa] || '';
        }

        // Funci√≥n para limpiar comentarios al cargar nuevos datos
        function clearCommentsForDataset(datasetIndex) {
            if (analysisResultsByDataset[datasetIndex]) {
                const operativasToRemove = analysisResultsByDataset[datasetIndex].map(result => result.operativa);
                operativasToRemove.forEach(operativa => {
                    const existsInOtherDatasets = analysisResultsByDataset.some((results, index) => 
                        index !== datasetIndex && 
                        results && 
                        results.some(result => result.operativa === operativa)
                    );
                    
                    if (!existsInOtherDatasets) {
                        delete operativeComments[operativa];
                    }
                });
            }
        }

        // Tab switching functionality
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-item').forEach(nav => {
                nav.classList.remove('active');
            });
            
            document.getElementById(tabName + 'Tab').classList.add('active');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            const titles = {
                'analysis': 'Dashboard de An√°lisis',
                'summary': 'Resumen por Colmena',
                'settings': 'Configuraci√≥n de Umbrales',
                'registro': 'Registro de Operativas',
                'informe': 'Informe Mensual'
            };
            document.getElementById('pageTitle').textContent = titles[tabName];
            
            if (tabName === 'summary') {
                showSummaryTab();
            }
            
            if (tabName === 'informe') {
                inicializarInforme();
            }
        }

        // Analysis functions
        function analyzeDelay(data) {
            const parseValue = (value) => {
                if (value === '' || value === undefined || value === null) return 0;
                return parseFloat(value.toString().replace(',', '.')) || 0;
            };

            const porcRetrasoEnArea = parseValue(data.porc_retraso_en_area);
            const porcLlegadaEnHora = parseValue(data.porc_llegada_en_hora);
            const colVolumen = parseValue(data.col_volumen);
            const colTempus = parseValue(data.col_tempus);

            let accionRecomendada = '';

            if (porcRetrasoEnArea <= tensionadaRetrasosThreshold) {
                accionRecomendada = 'Tensionada Retrasos';
            } else if (porcLlegadaEnHora <= tensionadaLlegadaThreshold) {
                accionRecomendada = 'Tensionada Llegada';
            } else if (porcRetrasoEnArea >= holguraThreshold && porcLlegadaEnHora >= holguraThreshold) {
                if (colVolumen > colTempus) {
                    accionRecomendada = 'Holgura Tiempo-Volumen';
                } else {
                    accionRecomendada = 'Holgura Tiempo';
                }
            } else {
                accionRecomendada = 'Sin Clasificar';
            }

            const volumeAnalysis = analyzeVolumeProblems(data.col_tempus, data.col_volumen);

            return {
                operativa: data.operativa || '',
                rutasDia: data.rutas_dia !== undefined ? data.rutas_dia : '',
                dias: data.dias !== undefined ? data.dias : '',
                colPorRuta: data.col_por_ruta !== undefined ? data.col_por_ruta : '',
                porcRetrasos: data.porc_retrasos !== undefined ? data.porc_retrasos : '',
                porcSinRetraso: data.porc_sin_retraso !== undefined ? data.porc_sin_retraso : '',
                porcSalidaEnHora: data.porc_salida_en_hora !== undefined ? data.porc_salida_en_hora : '',
                porcLlegadaArea: data.porc_llegada_area !== undefined ? data.porc_llegada_area : '',
                porcRetrasoEnArea: data.porc_retraso_en_area !== undefined ? data.porc_retraso_en_area : '',
                porcLlegadaEnHora: data.porc_llegada_en_hora !== undefined ? data.porc_llegada_en_hora : '',
                colTeorica: data.col_teoricas !== undefined ? data.col_teoricas : '',
                pdTeorico: data.pd_teorico !== undefined ? data.pd_teorico : '',
                udTeorico: data.ud_teorico !== undefined ? data.ud_teorico : '',
                colTempus: data.col_tempus !== undefined ? data.col_tempus : '',
                pdTempus: data.pd_tempus !== undefined ? data.pd_tempus : '',
                udTempus: data.ud_tempus !== undefined ? data.ud_tempus : '',
                colVolumen: data.col_volumen !== undefined ? data.col_volumen : '',
                accion: accionRecomendada,
                volumeProblems: volumeAnalysis
            };
        }

        function analyzeVolumeProblems(colTempus, colVolumen) {
            const parseValue = (value) => {
                if (value === '' || value === undefined || value === null) return 0;
                return parseFloat(value.toString().replace(',', '.')) || 0;
            };
            
            const tempusValue = parseValue(colTempus);
            const volumenValue = parseValue(colVolumen);
            
            if (tempusValue > volumenValue) {
                const diferencia = tempusValue - volumenValue;
                return {
                    hasProblems: true,
                    status: 'Exceso',
                    difference: diferencia.toFixed(2),
                    message: `Exceso: ${diferencia.toFixed(2)}`
                };
            } else if (volumenValue > tempusValue) {
                const holgura = volumenValue - tempusValue;
                return {
                    hasProblems: false,
                    status: 'Holgura',
                    difference: holgura.toFixed(2),
                    message: `Holgura: ${holgura.toFixed(2)}`
                };
            } else {
                return {
                    hasProblems: false,
                    status: 'Equilibrio',
                    difference: '0',
                    message: 'Equilibrio'
                };
            }
        }

        function formatValue(value) {
            if (value !== undefined && value !== null && value !== '') {
                const valueStr = value.toString();
                if (valueStr.includes(',')) {
                    const parts = valueStr.split(',');
                    if (parts[1] && parts[1].length > 2) {
                        return parts[0] + ',' + parts[1].substring(0, 2);
                    }
                }
                else if (valueStr.includes('.')) {
                    const parts = valueStr.split('.');
                    if (parts[1] && parts[1].length > 2) {
                        return parts[0] + '.' + parts[1].substring(0, 2);
                    }
                }
                return valueStr;
            }
            return '';
        }

        function createRecommendations(result) {
            let recommendations = [];
            
            const parseValue = (value) => {
                if (value === '' || value === undefined || value === null) return 0;
                return parseFloat(value.toString().replace(',', '.')) || 0;
            };
            
            // Extraer par√°metros para la URL de Metabase
            const colmena = extractColmena(result.operativa);
            const turno = extractTurno(result.operativa);
            const area = extractArea(result.operativa);
            
            // Reemplazar espacios con guiones en el √°rea para la URL
            const areaForUrl = area.replace(/\s+/g, '-');
            
            // Construir URL de Metabase con par√°metros espec√≠ficos
            const metabaseUrl = `https://metabase.prod.monline/question/29582-productividad-teorica-diaria?colmena=${colmena}&shift=${turno}&area=${encodeURIComponent(areaForUrl.toLowerCase())}`;
            
            // Construir URL de Tempus con la colmena
            const tempusUrl = `https://tempus.prod.monline/centers/${colmena.toLowerCase()}/operatives`;
            
            const colTeorica = parseValue(result.colTeorica);
            const colTempus = parseValue(result.colTempus);
            const diferenciaCol = colTeorica - colTempus;
            
            // Formato con enlace en Productividad
            if (diferenciaCol !== 0) {
                const accionProductividad = diferenciaCol < 0 ? "Reducir productividad" : "Aumentar productividad";
                recommendations.push(`<strong><a href="${metabaseUrl}" target="_blank" style="color: #3b82f6; text-decoration: underline;">Productividad</a></strong>: Te√≥rico: ${colTeorica.toFixed(2)}, Tempus: ${colTempus.toFixed(2)} (${accionProductividad}: ${Math.abs(diferenciaCol).toFixed(2)})`);
            } else {
                recommendations.push(`<strong><a href="${metabaseUrl}" target="_blank" style="color: #3b82f6; text-decoration: underline;">Productividad</a></strong>: Te√≥rico: ${colTeorica.toFixed(2)}, Tempus: ${colTempus.toFixed(2)} (Equilibrada)`);
            }
            
            const pdTeorico = parseValue(result.pdTeorico);
            const pdTempus = parseValue(result.pdTempus);
            const ajusteTiemposIda = pdTeorico - pdTempus;
            
            if (ajusteTiemposIda !== 0) {
                const accionTiempoIda = ajusteTiemposIda < 0 ? "Reducir tiempo ida" : "Aumentar tiempo ida";
                recommendations.push(`<strong>Tiempo de ida</strong>: Hist√≥rico: ${pdTeorico.toFixed(2)}, Tempus: ${pdTempus.toFixed(2)} (${accionTiempoIda}: ${Math.abs(ajusteTiemposIda).toFixed(2)})`);
            } else {
                recommendations.push(`<strong>Tiempo de ida</strong>: Hist√≥rico: ${pdTeorico.toFixed(2)}, Tempus: ${pdTempus.toFixed(2)} (Equilibrado)`);
            }
            
            const udTeorico = parseValue(result.udTeorico);
            const udTempus = parseValue(result.udTempus);
            const ajusteTiemposVuelta = udTeorico - udTempus;
            
            if (ajusteTiemposVuelta !== 0) {
                const accionTiempoVuelta = ajusteTiemposVuelta < 0 ? "Reducir tiempo vuelta" : "Aumentar tiempo vuelta";
                recommendations.push(`<strong>Tiempo de vuelta</strong>: Hist√≥rico: ${udTeorico.toFixed(2)}, Tempus: ${udTempus.toFixed(2)} (${accionTiempoVuelta}: ${Math.abs(ajusteTiemposVuelta).toFixed(2)})`);
            } else {
                recommendations.push(`<strong>Tiempo de vuelta</strong>: Hist√≥rico: ${udTeorico.toFixed(2)}, Tempus: ${udTempus.toFixed(2)} (Equilibrado)`);
            }
            
            // Agregar enlace a Tempus al final
            recommendations.push(`<strong><a href="${tempusUrl}" target="_blank" style="color: #3b82f6; text-decoration: underline;">Ir a Configuraci√≥n</a></strong>`);
            
            return recommendations.join('<br>');
        }

        // Funci√≥n para crear recomendaciones sin HTML (para CSV)
        function createPlainTextRecommendations(result) {
            let recommendations = [];
            
            const parseValue = (value) => {
                if (value === '' || value === undefined || value === null) return 0;
                return parseFloat(value.toString().replace(',', '.')) || 0;
            };
            
            const colTeorica = parseValue(result.colTeorica);
            const colTempus = parseValue(result.colTempus);
            const diferenciaCol = colTeorica - colTempus;
            
            if (diferenciaCol !== 0) {
                const accionProductividad = diferenciaCol < 0 ? "Reducir productividad" : "Aumentar productividad";
                recommendations.push(`Productividad: Te√≥rico: ${colTeorica.toFixed(2)}, Tempus: ${colTempus.toFixed(2)} (${accionProductividad}: ${Math.abs(diferenciaCol).toFixed(2)})`);
            } else {
                recommendations.push(`Productividad: Te√≥rico: ${colTeorica.toFixed(2)}, Tempus: ${colTempus.toFixed(2)} (Equilibrada)`);
            }
            
            const pdTeorico = parseValue(result.pdTeorico);
            const pdTempus = parseValue(result.pdTempus);
            const ajusteTiemposIda = pdTeorico - pdTempus;
            
            if (ajusteTiemposIda !== 0) {
                const accionTiempoIda = ajusteTiemposIda < 0 ? "Reducir tiempo ida" : "Aumentar tiempo ida";
                recommendations.push(`Tiempo de ida: Hist√≥rico: ${pdTeorico.toFixed(2)}, Tempus: ${pdTempus.toFixed(2)} (${accionTiempoIda}: ${Math.abs(ajusteTiemposIda).toFixed(2)})`);
            } else {
                recommendations.push(`Tiempo de ida: Hist√≥rico: ${pdTeorico.toFixed(2)}, Tempus: ${pdTempus.toFixed(2)} (Equilibrado)`);
            }
            
            const udTeorico = parseValue(result.udTeorico);
            const udTempus = parseValue(result.udTempus);
            const ajusteTiemposVuelta = udTeorico - udTempus;
            
            if (ajusteTiemposVuelta !== 0) {
                const accionTiempoVuelta = ajusteTiemposVuelta < 0 ? "Reducir tiempo vuelta" : "Aumentar tiempo vuelta";
                recommendations.push(`Tiempo de vuelta: Hist√≥rico: ${udTeorico.toFixed(2)}, Tempus: ${udTempus.toFixed(2)} (${accionTiempoVuelta}: ${Math.abs(ajusteTiemposVuelta).toFixed(2)})`);
            } else {
                recommendations.push(`Tiempo de vuelta: Hist√≥rico: ${udTeorico.toFixed(2)}, Tempus: ${udTempus.toFixed(2)} (Equilibrado)`);
            }
            
            return recommendations.join(' | ');
        }

        function getProgressColor(percentage) {
            const value = parseFloat(percentage) || 0;
            if (value >= 85) return '#059669';
            if (value >= 70) return '#10b981';
            if (value >= 55) return '#84cc16';
            if (value >= 40) return '#f59e0b';
            if (value >= 25) return '#ef4444';
            return '#dc2626';
        }

        function getPercentageBadgeClass(percentage, isRetrasoEnArea = false) {
            const value = parseFloat(percentage) || 0;
            
            if (value >= 85) return 'percentage-excellent';
            if (value >= 70) return 'percentage-very-good';
            if (value >= 55) return 'percentage-good';
            if (value >= 40) return 'percentage-fair';
            if (value >= 25) return 'percentage-poor';
            return 'percentage-very-poor';
        }

        function getStatusClass(action) {
            if (action.includes('Tensionada Retrasos')) return 'status-danger';
            if (action.includes('Tensionada Llegada')) return 'status-warning';
            if (action.includes('Holgura Tiempo')) return 'status-success';
            return 'status-info';
        }

        // Funciones para manejar m√∫ltiples datasets
        function switchDataset(index) {
            console.log(`Cambiando a dataset ${index}`);
            currentActiveDataset = index;
            
            document.querySelectorAll('.dataset-tab').forEach((tab, i) => {
                if (i === index) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            if (datasets[index]) {
                showOperativeSelection(datasets[index], index);
                updateSelectAllButton(index);
                
                if (analysisResultsByDataset[index] && analysisResultsByDataset[index].length > 0) {
                    displayResults(analysisResultsByDataset[index], index);
                } else {
                    document.getElementById('resultsSection').classList.add('hidden');
                }
            } else {
                document.getElementById('operativesCard').classList.add('hidden');
                document.getElementById('resultsSection').classList.add('hidden');
            }
        }
        
        function updateSelectAllButton(datasetIndex) {
            const currentData = datasets[datasetIndex];
            const selectAllBtn = document.getElementById('selectAllBtn');
            
            if (!currentData) {
                selectAllBtn.innerHTML = '<i class="fas fa-check-square"></i> Seleccionar Todas';
                return;
            }
            
            const currentSelections = selectedOperativesByDataset[datasetIndex];
            const isAllSelected = currentSelections.size === currentData.length && currentData.length > 0;
            
            if (isAllSelected) {
                selectAllBtn.innerHTML = '<i class="fas fa-square"></i> Deseleccionar Todas';
            } else {
                selectAllBtn.innerHTML = '<i class="fas fa-check-square"></i> Seleccionar Todas';
            }
        }

        function hasAnyDatasets() {
            return datasets.some(data => data !== null);
        }

        function getLoadedDatasetsCount() {
            return datasets.filter(data => data !== null).length;
        }

        function hasAnyAnalysisResults() {
            return analysisResultsByDataset.some(results => results && results.length > 0);
        }

        // CSV Processing
        function processCSV(csvData, datasetIndex, fileName) {
            Papa.parse(csvData, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.errors.length > 0) {
                        alert(`Error al procesar ${fileName}: ` + results.errors[0].message);
                        return;
                    }

                    datasets[datasetIndex] = results.data;
                    datasetNames[datasetIndex] = fileName;
                    selectedOperativesByDataset[datasetIndex] = new Set();
                    analysisResultsByDataset[datasetIndex] = [];
                    availableColmenasByDataset[datasetIndex] = new Set();
                    
                    clearCommentsForDataset(datasetIndex);
                    
                    const statusElement = document.getElementById(`fileName${datasetIndex + 1}`);
                    statusElement.textContent = `‚úì ${fileName}`;
                    statusElement.className = 'file-status success';
                    
                    showDatasetTabs();
                    
                    currentActiveDataset = datasetIndex;
                    switchDataset(datasetIndex);
                    
                    console.log(`Archivo ${datasetIndex + 1} procesado: ${results.data.length} filas`);
                    
                    // AN√ÅLISIS AUTOM√ÅTICO: Analizar todas las operativas inmediatamente
                    setTimeout(() => {
                        const analysisResults = results.data.map(row => analyzeDelay(row));
                        analysisResultsByDataset[datasetIndex] = analysisResults;
                        displayResults(analysisResults, datasetIndex);
                        console.log(`An√°lisis autom√°tico completado para ${fileName} con umbrales: TR‚â§${tensionadaRetrasosThreshold}%, TL‚â§${tensionadaLlegadaThreshold}%, H‚â•${holguraThreshold}%`);
                    }, 100);
                }
            });
        }

        function showDatasetTabs() {
            const tabsContainer = document.getElementById('datasetTabs');
            const loadedCount = getLoadedDatasetsCount();
            
            if (loadedCount > 0) {
                tabsContainer.classList.remove('hidden');
                
                datasets.forEach((data, index) => {
                    const tab = document.getElementById(`datasetTab${index}`);
                    const tabText = tab.querySelector('.tab-text');
                    
                    if (data) {
                        tab.classList.remove('hidden');
                        if (analysisResultsByDataset[index] && analysisResultsByDataset[index].length > 0) {
                            tab.classList.add('has-results');
                        } else {
                            tab.classList.remove('has-results');
                        }
                        
                        const shortName = datasetNames[index] ? 
                            (datasetNames[index].length > 15 ? datasetNames[index].substring(0, 12) + '...' : datasetNames[index]) 
                            : `Archivo ${index + 1}`;
                        tabText.textContent = shortName;
                    } else {
                        tab.classList.add('hidden');
                        tab.classList.remove('has-results');
                    }
                });
            } else {
                tabsContainer.classList.add('hidden');
            }
        }

        function extractColmena(operativa) {
            if (!operativa) return '';
            const match = operativa.match(/^([a-zA-Z]{3}\d+)/);
            return match ? match[1] : '';
        }

        function extractTurno(operativa) {
            if (!operativa) return '';
            
            const operativaLower = operativa.toLowerCase();
            const turnos = ['morning', 'bridge', 'afternoon'];
            
            for (const turno of turnos) {
                if (operativaLower.includes(turno)) {
                    return turno;
                }
            }
            
            return '';
        }

        function extractArea(operativa) {
            if (!operativa) return '';
            
            const colmenaMatch = operativa.match(/^([a-zA-Z]{3}\d+)/);
            if (!colmenaMatch) return '';
            
            const colmena = colmenaMatch[1];
            const turno = extractTurno(operativa);
            
            if (!turno) {
                const withoutColmena = operativa.substring(colmena.length);
                return withoutColmena.startsWith('-') ? withoutColmena.substring(1) : withoutColmena;
            }
            
            let area = operativa.substring(colmena.length);
            
            if (area.startsWith('-')) {
                area = area.substring(1);
            }
            
            const turnoLower = turno.toLowerCase();
            const areaLower = area.toLowerCase();
            
            if (areaLower.endsWith('-' + turnoLower)) {
                area = area.substring(0, area.length - turnoLower.length - 1);
            } else if (areaLower.endsWith(turnoLower)) {
                area = area.substring(0, area.length - turnoLower.length);
            }
            
            if (area.endsWith('-')) {
                area = area.substring(0, area.length - 1);
            }
            
            return area;
        }

        function showOperativeSelection(data, datasetIndex) {
            const operativesCard = document.getElementById('operativesCard');
            
            availableColmenasByDataset[datasetIndex].clear();
            data.forEach(row => {
                const colmena = extractColmena(row.operativa);
                if (colmena) availableColmenasByDataset[datasetIndex].add(colmena);
            });
            
            populateColmenaFilter(datasetIndex);
            filteredOperativesByDataset[datasetIndex] = data.map((row, index) => ({ ...row, originalIndex: index }));
            renderOperatives(datasetIndex);
            
            operativesCard.classList.remove('hidden');
            updateSelectionInfo(datasetIndex);
        }

        function populateColmenaFilter(datasetIndex) {
            const colmenaFilter = document.getElementById('colmenaFilter');
            const sortedColmenas = Array.from(availableColmenasByDataset[datasetIndex]).sort();
            
            colmenaFilter.innerHTML = '<option value="">Todas las Colmenas</option>';
            
            sortedColmenas.forEach(colmena => {
                const option = document.createElement('option');
                option.value = colmena;
                option.textContent = colmena.toUpperCase();
                colmenaFilter.appendChild(option);
            });
        }

        function renderOperatives(datasetIndex) {
            const operativesGrid = document.getElementById('operativesGrid');
            
            operativesGrid.innerHTML = filteredOperativesByDataset[datasetIndex].map((row) => {
                const colmena = extractColmena(row.operativa);
                const isSelected = selectedOperativesByDataset[datasetIndex].has(row.originalIndex);
                const uniqueId = `op_${datasetIndex}_${row.originalIndex}`;
                
                return `
                <div class="operative-card ${isSelected ? 'selected' : ''}" onclick="toggleOperative(${row.originalIndex}, ${datasetIndex})">
                    <div class="operative-header">
                        <input type="checkbox" class="operative-checkbox" id="${uniqueId}" 
                               ${isSelected ? 'checked' : ''} onchange="toggleOperative(${row.originalIndex}, ${datasetIndex})">
                        <div class="operative-name">${row.operativa || 'Sin nombre'}</div>
                    </div>
                    <div class="operative-details">
                        <div class="detail-item">
                            <span>Colmena:</span>
                            <span class="detail-value">${colmena.toUpperCase()}</span>
                        </div>
                        <div class="detail-item">
                            <span>Rutas/d√≠a:</span>
                            <span class="detail-value">${row.rutas_dia || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span>D√≠as:</span>
                            <span class="detail-value">${row.dias || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span>Col/Ruta:</span>
                            <span class="detail-value">${row.col_por_ruta || 'N/A'}</span>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function toggleOperative(index, datasetIndex = null) {
            const targetDataset = datasetIndex !== null ? datasetIndex : currentActiveDataset;
            const uniqueId = `op_${targetDataset}_${index}`;
            const checkbox = document.getElementById(uniqueId);
            const card = checkbox.closest('.operative-card');
            
            if (selectedOperativesByDataset[targetDataset].has(index)) {
                selectedOperativesByDataset[targetDataset].delete(index);
                checkbox.checked = false;
                card.classList.remove('selected');
            } else {
                selectedOperativesByDataset[targetDataset].add(index);
                checkbox.checked = true;
                card.classList.add('selected');
            }
            
            updateSelectionInfo(targetDataset);
        }

        function updateSelectionInfo(datasetIndex) {
            const info = document.getElementById('selectionInfo');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const count = selectedOperativesByDataset[datasetIndex].size;
            
            info.textContent = `${count} operativa${count !== 1 ? 's' : ''} seleccionada${count !== 1 ? 's' : ''} (${datasetNames[datasetIndex] || `Archivo ${datasetIndex + 1}`})`;
            analyzeBtn.disabled = count === 0;
        }

        function toggleSelectionView() {
            const container = document.querySelector('.operatives-container');
            const btn = document.getElementById('toggleSelectionBtn');
            
            isSelectionCollapsed = !isSelectionCollapsed;
            
            if (isSelectionCollapsed) {
                container.style.display = 'none';
                btn.innerHTML = '<i class="fas fa-chevron-down"></i> Mostrar';
            } else {
                container.style.display = 'block';
                btn.innerHTML = '<i class="fas fa-chevron-up"></i> Ocultar';
            }
        }

        // Multi-select functions
        function toggleMultiSelect(type) {
            const dropdown = document.getElementById(`${type}Dropdown`);
            const trigger = dropdown.previousElementSibling;
            
            document.querySelectorAll('.multi-select-dropdown.show').forEach(dd => {
                if (dd !== dropdown) {
                    dd.classList.remove('show');
                    dd.previousElementSibling.classList.remove('active');
                }
            });
            
            dropdown.classList.toggle('show');
            trigger.classList.toggle('active');
        }

        function toggleMultiSelectOption(type, value, checkbox) {
            let filterKey;
            if (type === 'colmena') {
                filterKey = 'colmena';
            } else if (type === 'area') {
                filterKey = 'area';
            } else if (type === 'turno') { 
                filterKey = 'turno';
            } else if (type === 'clasificacion') {
                filterKey = 'accionRecomendada';
            }
            
            if (checkbox.checked) {
                if (!activeFilters[filterKey].includes(value)) {
                    activeFilters[filterKey].push(value);
                }
            } else {
                activeFilters[filterKey] = activeFilters[filterKey].filter(v => v !== value);
            }
            
            updateMultiSelectDisplay(type);
            applyAllFilters();
        }

        function updateMultiSelectDisplay(type) {
            let filterKey, defaultText;
            
            if (type === 'colmena') {
                filterKey = 'colmena';
                defaultText = 'Todas';
            } else if (type === 'area') {
                filterKey = 'area';
                defaultText = 'Todas';
            } else if (type === 'turno') {
                filterKey = 'turno'; 
                defaultText = 'Todos';
            } else if (type === 'clasificacion') {
                filterKey = 'accionRecomendada';
                defaultText = 'Todas';
            }
            
            const selectedValues = activeFilters[filterKey];
            const textElement = document.getElementById(`${type}SelectedText`);
            
            if (selectedValues.length === 0) {
                textElement.textContent = defaultText;
                textElement.parentElement.querySelector('.multi-select-count')?.remove();
            } else if (selectedValues.length === 1) {
                let displayValue = selectedValues[0];
                if (type === 'colmena') {
                    displayValue = displayValue.toUpperCase();
                } else if (type === 'area' || type === 'turno') {
                    displayValue = displayValue.charAt(0).toUpperCase() + displayValue.slice(1);
                }
                textElement.textContent = displayValue;
                textElement.parentElement.querySelector('.multi-select-count')?.remove();
            } else {
                textElement.textContent = `${selectedValues.length} seleccionadas`;
                
                let countElement = textElement.parentElement.querySelector('.multi-select-count');
                if (!countElement) {
                    countElement = document.createElement('span');
                    countElement.className = 'multi-select-count';
                    textElement.parentElement.insertBefore(countElement, textElement.nextSibling);
                }
                countElement.textContent = selectedValues.length;
            }
        }

        // Cerrar dropdowns al hacer clic fuera
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.multi-select-container')) {
                document.querySelectorAll('.multi-select-dropdown.show').forEach(dropdown => {
                    dropdown.classList.remove('show');
                    dropdown.previousElementSibling.classList.remove('active');
                });
            }
        });

        function displayResults(results, datasetIndex) {
            analysisResultsByDataset[datasetIndex] = results;
            showDatasetTabs();
            filteredResults = [...results];
            
            activeFilters = {
                colmena: [],
                area: [],
                turno: [],
                salidaComparison: '',
                salidaValue: '',
                llegadaAreaComparison: '',
                llegadaAreaValue: '',
                retrasoAreaComparison: '',
                retrasoAreaValue: '',
                llegadaHoraComparison: '',
                llegadaHoraValue: '',
                retrasosComparison: '',
                retrasosThreshold: '',
                tiempoDiferencia: '',
                tiempoDireccion: 'any',
                tiempoTipo: 'any',
                accionRecomendada: []
            };
            
            document.getElementById('salidaComparison').value = '';
            document.getElementById('salidaValue').value = '';
            document.getElementById('llegadaAreaComparison').value = '';
            document.getElementById('llegadaAreaValue').value = '';
            document.getElementById('retrasoAreaComparison').value = '';
            document.getElementById('retrasoAreaValue').value = '';
            document.getElementById('llegadaHoraComparison').value = '';
            document.getElementById('llegadaHoraValue').value = '';
            document.getElementById('retrasosComparisonFilter').value = '';
            document.getElementById('retrasosThresholdFilter').value = '';
            document.getElementById('tiempoDiferenciaFilter').value = '';
            document.getElementById('tiempoDireccionFilter').value = 'any';
            document.getElementById('tiempoTipoFilter').value = 'any';
            
            populateResultsFilters();
            
            updateMultiSelectDisplay('colmena');
            updateMultiSelectDisplay('area');
            updateMultiSelectDisplay('turno');
            updateMultiSelectDisplay('clasificacion');
            
            updateResultsDisplay();
            updateThresholdInfo();
            
            const resultsTitle = document.getElementById('currentResultsTitle');
            resultsTitle.textContent = `Resultados - ${datasetNames[datasetIndex] || `Archivo ${datasetIndex + 1}`}`;
            
            document.getElementById('resultsSection').classList.remove('hidden');
        }

        function populateResultsFilters() {
            const currentResults = analysisResultsByDataset[currentActiveDataset] || [];
            
            if (currentResults.length === 0) return;
            
            const colmenasInResults = new Set();
            const areasInResults = new Set();
            const turnosInResults = new Set();
            
            // Crear mapa de √°reas por colmena
            const areasByColmena = {};
            
            currentResults.forEach(result => {
                const colmena = extractColmena(result.operativa);
                const area = extractArea(result.operativa);
                const turno = extractTurno(result.operativa);
                
                if (colmena) colmenasInResults.add(colmena);
                if (area) areasInResults.add(area);
                if (turno) turnosInResults.add(turno);
                
                // Mapear √°reas a colmenas
                if (colmena && area) {
                    if (!areasByColmena[area]) {
                        areasByColmena[area] = new Set();
                    }
                    areasByColmena[area].add(colmena);
                }
            });
            
            const sortedColmenas = Array.from(colmenasInResults).sort();
            const colmenaDropdown = document.getElementById('colmenaDropdown');
            
            colmenaDropdown.innerHTML = `
                <div class="multi-select-clear" onclick="clearMultiSelectFilter('colmena'); event.stopPropagation();">
                    <i class="fas fa-times"></i> Desmarcar todos
                </div>
            ` + sortedColmenas.map(colmena => `
                <div class="multi-select-option" onclick="event.stopPropagation()">
                    <input type="checkbox" id="colmena_${colmena}" value="${colmena}" 
                           onchange="toggleMultiSelectOption('colmena', '${colmena}', this); updateAreaFilterByColmena();">
                    <label for="colmena_${colmena}" class="multi-select-text">${colmena.toUpperCase()}</label>
                </div>
            `).join('');

            const sortedAreas = Array.from(areasInResults).sort();
            const areaDropdown = document.getElementById('areaDropdown');
            
            areaDropdown.innerHTML = `
                <div class="multi-select-clear" onclick="clearMultiSelectFilter('area'); event.stopPropagation();">
                    <i class="fas fa-times"></i> Desmarcar todos
                </div>
            ` + sortedAreas.map(area => {
                const colmenas = areasByColmena[area] ? Array.from(areasByColmena[area]).join(',') : '';
                return `
                    <div class="multi-select-option area-option" data-colmenas="${colmenas}" onclick="event.stopPropagation()">
                        <input type="checkbox" id="area_${area}" value="${area}" 
                               onchange="toggleMultiSelectOption('area', '${area}', this)">
                        <label for="area_${area}" class="multi-select-text">${area.charAt(0).toUpperCase() + area.slice(1)}</label>
                    </div>
                `;
            }).join('');

            const sortedTurnos = Array.from(turnosInResults).sort();
            const turnoDropdown = document.getElementById('turnoDropdown');
            
            turnoDropdown.innerHTML = `
                <div class="multi-select-clear" onclick="clearMultiSelectFilter('turno'); event.stopPropagation();">
                    <i class="fas fa-times"></i> Desmarcar todos
                </div>
            ` + sortedTurnos.map(turno => `
                <div class="multi-select-option" onclick="event.stopPropagation()">
                    <input type="checkbox" id="turno_${turno}" value="${turno}" 
                           onchange="toggleMultiSelectOption('turno', '${turno}', this)">
                    <label for="turno_${turno}" class="multi-select-text">${turno.charAt(0).toUpperCase() + turno.slice(1)}</label>
                </div>
            `).join('');

            const accionesInResults = new Set();
            currentResults.forEach(result => {
                if (result.accion) accionesInResults.add(result.accion);
            });
            
            const sortedAcciones = Array.from(accionesInResults).sort();
            const clasificacionDropdown = document.getElementById('clasificacionDropdown');
            
            clasificacionDropdown.innerHTML = `
                <div class="multi-select-clear" onclick="clearMultiSelectFilter('clasificacion'); event.stopPropagation();">
                    <i class="fas fa-times"></i> Desmarcar todos
                </div>
            ` + sortedAcciones.map(accion => `
                <div class="multi-select-option" onclick="event.stopPropagation()">
                    <input type="checkbox" id="accion_${accion.replace(/\s+/g, '_')}" value="${accion}" 
                           onchange="toggleMultiSelectOption('clasificacion', '${accion}', this)">
                    <label for="accion_${accion.replace(/\s+/g, '_')}" class="multi-select-text">${accion}</label>
                </div>
            `).join('');
        }

        function updateAreaFilterByColmena() {
            const selectedColmenas = activeFilters.colmena;
            const areaOptions = document.querySelectorAll('.area-option');
            
            if (selectedColmenas.length === 0) {
                // Si no hay colmenas seleccionadas, mostrar todas las √°reas
                areaOptions.forEach(option => {
                    option.style.display = '';
                });
            } else {
                // Mostrar solo las √°reas que pertenecen a las colmenas seleccionadas
                areaOptions.forEach(option => {
                    const colmenasAttr = option.getAttribute('data-colmenas');
                    if (colmenasAttr) {
                        const colmenas = colmenasAttr.split(',');
                        const hasMatch = selectedColmenas.some(selected => colmenas.includes(selected));
                        option.style.display = hasMatch ? '' : 'none';
                    } else {
                        option.style.display = 'none';
                    }
                });
            }
        }

        function clearMultiSelectFilter(type) {
            let filterKey;
            let dropdownId;
            
            if (type === 'colmena') {
                filterKey = 'colmena';
                dropdownId = 'colmenaDropdown';
            } else if (type === 'area') {
                filterKey = 'area';
                dropdownId = 'areaDropdown';
            } else if (type === 'turno') {
                filterKey = 'turno';
                dropdownId = 'turnoDropdown';
            } else if (type === 'clasificacion') {
                filterKey = 'accionRecomendada';
                dropdownId = 'clasificacionDropdown';
            }
            
            // Limpiar el array de filtros activos
            activeFilters[filterKey] = [];
            
            // Desmarcar todos los checkboxes
            const dropdown = document.getElementById(dropdownId);
            dropdown.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Actualizar display
            updateMultiSelectDisplay(type);
            
            // Si es colmena, actualizar el filtro de √°reas
            if (type === 'colmena') {
                updateAreaFilterByColmena();
            }
            
            // Aplicar filtros
            applyAllFilters();
        }

        function applyAllFilters() {
            const currentResults = analysisResultsByDataset[currentActiveDataset] || [];
            
            if (currentResults.length === 0) {
                filteredResults = [];
                updateResultsDisplay();
                updateFilterInfo();
                return;
            }
            
            filteredResults = currentResults.filter(result => {
                const colmena = extractColmena(result.operativa);
                const area = extractArea(result.operativa);
                const turno = extractTurno(result.operativa);
                
                const matchesColmena = activeFilters.colmena.length === 0 || activeFilters.colmena.includes(colmena);
                const matchesArea = activeFilters.area.length === 0 || activeFilters.area.includes(area);
                const matchesTurno = activeFilters.turno.length === 0 || activeFilters.turno.includes(turno);
                
                const evaluatePercentageCriteria = (value, comparison, filterValue) => {
                    if (comparison === '' || filterValue === '') return true;
                    
                    const numValue = parseFloat((value || '0').toString().replace(',', '.')) || 0;
                    const thresholdValue = parseFloat(filterValue) || 0;
                    
                    return comparison === 'gte' ? numValue >= thresholdValue : numValue < thresholdValue;
                };
                
                const matchesSalida = evaluatePercentageCriteria(
                    result.porcSalidaEnHora, 
                    activeFilters.salidaComparison, 
                    activeFilters.salidaValue
                );
                const matchesLlegadaArea = evaluatePercentageCriteria(
                    result.porcLlegadaArea, 
                    activeFilters.llegadaAreaComparison, 
                    activeFilters.llegadaAreaValue
                );
                const matchesRetrasoArea = evaluatePercentageCriteria(
                    result.porcRetrasoEnArea, 
                    activeFilters.retrasoAreaComparison, 
                    activeFilters.retrasoAreaValue
                );
                const matchesLlegadaHora = evaluatePercentageCriteria(
                    result.porcLlegadaEnHora, 
                    activeFilters.llegadaHoraComparison, 
                    activeFilters.llegadaHoraValue
                );
                
                const matchesRetrasosThreshold = (() => {
                    if (activeFilters.retrasosThreshold === '' || activeFilters.retrasosComparison === '') return true;
                    
                    const threshold = parseFloat(activeFilters.retrasosThreshold);
                    if (isNaN(threshold)) return true;
                    
                    const retrasosValue = parseFloat((result.porcRetrasos || '0').toString().replace(',', '.')) || 0;
                    
                    return activeFilters.retrasosComparison === 'gte' ? retrasosValue >= threshold : retrasosValue < threshold;
                })();
                
                const matchesTiempoDiferencia = (() => {
                    if (activeFilters.tiempoDiferencia === '') return true;
                    
                    const threshold = parseFloat(activeFilters.tiempoDiferencia);
                    if (isNaN(threshold)) return true;
                    
                    const parseValue = (value) => {
                        if (value === '' || value === undefined || value === null) return 0;
                        return parseFloat(value.toString().replace(',', '.')) || 0;
                    };
                    
                    const pdTeorico = parseValue(result.pdTeorico);
                    const pdTempus = parseValue(result.pdTempus);
                    const udTeorico = parseValue(result.udTeorico);
                    const udTempus = parseValue(result.udTempus);
                    
                    const diferenciaPD = pdTempus - pdTeorico;
                    const diferenciaUD = udTempus - udTeorico;
                    
                    const cumpleDireccion = (diferencia) => {
                        switch (activeFilters.tiempoDireccion) {
                            case 'more': return diferencia >= threshold;
                            case 'less': return diferencia <= -threshold;
                            case 'any': return Math.abs(diferencia) >= threshold;
                            default: return Math.abs(diferencia) >= threshold;
                        }
                    };
                    
                    switch (activeFilters.tiempoTipo) {
                        case 'ida': return cumpleDireccion(diferenciaPD);
                        case 'vuelta': return cumpleDireccion(diferenciaUD);
                        case 'any': return cumpleDireccion(diferenciaPD) || cumpleDireccion(diferenciaUD);
                        default: return cumpleDireccion(diferenciaPD) || cumpleDireccion(diferenciaUD);
                    }
                })();
                
                const matchesAccionRecomendada = activeFilters.accionRecomendada.length === 0 || 
                                               activeFilters.accionRecomendada.includes(result.accion);
                
                return matchesColmena && matchesArea && matchesTurno && matchesSalida && matchesLlegadaArea && 
                       matchesRetrasoArea && matchesLlegadaHora && matchesRetrasosThreshold && 
                       matchesTiempoDiferencia && matchesAccionRecomendada;
            });
            
            updateResultsDisplay();
            updateFilterInfo();
        }

        function updateFilterInfo() {
            const resultsFilterInfo = document.getElementById('resultsFilterInfo');
            const retrasosFilterInfo = document.getElementById('retrasosFilterInfo');
            const accionFilterInfo = document.getElementById('accionFilterInfo');
            const tiempoFilterInfo = document.getElementById('tiempoFilterInfo');
            
            const total = analysisResultsByDataset[currentActiveDataset] ? analysisResultsByDataset[currentActiveDataset].length : 0;
            const filtered = filteredResults.length;
            
            if (total === 0) {
                resultsFilterInfo.textContent = '';
                retrasosFilterInfo.textContent = '';
                accionFilterInfo.textContent = '';
                tiempoFilterInfo.textContent = '';
                return;
            }
            
            if (filtered === total) {
                resultsFilterInfo.textContent = '';
            } else {
                resultsFilterInfo.textContent = `Mostrando ${filtered} de ${total} operativas`;
            }
            
            const threshold = activeFilters.retrasosThreshold;
            const comparison = activeFilters.retrasosComparison;
            
            if (threshold === '' || comparison === '' || isNaN(parseFloat(threshold))) {
                retrasosFilterInfo.textContent = '';
            } else {
                const operatorText = comparison === 'gte' ? '‚â•' : '<';
                retrasosFilterInfo.textContent = `${filtered} operativas con ${operatorText} ${threshold}% retrasos`;
            }
            
            const tiempoThreshold = activeFilters.tiempoDiferencia;
            if (tiempoThreshold === '' || isNaN(parseFloat(tiempoThreshold))) {
                tiempoFilterInfo.textContent = '';
            } else {
                const direccionText = {
                    'more': 'm√°s tiempo',
                    'less': 'menos tiempo', 
                    'any': 'diferencia'
                }[activeFilters.tiempoDireccion] || 'diferencia';
                
                const tipoText = {
                    'ida': 'en ida',
                    'vuelta': 'en vuelta',
                    'any': ''
                }[activeFilters.tiempoTipo] || '';
                
                tiempoFilterInfo.textContent = `${filtered} operativas con ${direccionText} ‚â• ${tiempoThreshold} min ${tipoText}`.trim();
            }
            
            let filterInfoParts = [];
            
            if (activeFilters.colmena.length > 0) {
                const colmenaText = activeFilters.colmena.length === 1 
                    ? `Colmena: ${activeFilters.colmena[0].toUpperCase()}`
                    : `${activeFilters.colmena.length} colmenas`;
                filterInfoParts.push(colmenaText);
            }
            
            if (activeFilters.area.length > 0) {
                const areaText = activeFilters.area.length === 1 
                    ? `√Årea: ${activeFilters.area[0].charAt(0).toUpperCase() + activeFilters.area[0].slice(1)}`
                    : `${activeFilters.area.length} √°reas`;
                filterInfoParts.push(areaText);
            }
            
            if (activeFilters.turno.length > 0) {
                const turnoText = activeFilters.turno.length === 1 
                    ? `Turno: ${activeFilters.turno[0].charAt(0).toUpperCase() + activeFilters.turno[0].slice(1)}`
                    : `${activeFilters.turno.length} turnos`;
                filterInfoParts.push(turnoText);
            }
            
            if (activeFilters.accionRecomendada.length > 0) {
                const accionText = activeFilters.accionRecomendada.length === 1 
                    ? activeFilters.accionRecomendada[0]
                    : `${activeFilters.accionRecomendada.length} clasificaciones`;
                filterInfoParts.push(accionText);
            }
            
            if (filterInfoParts.length > 0) {
                accionFilterInfo.textContent = `${filtered} operativas - ${filterInfoParts.join(', ')}`;
            } else {
                accionFilterInfo.textContent = '';
            }
        }

        function clearAllFilters() {
            activeFilters = {
                colmena: [],
                area: [],
                turno: [],
                salidaComparison: '',
                salidaValue: '',
                llegadaAreaComparison: '',
                llegadaAreaValue: '',
                retrasoAreaComparison: '',
                retrasoAreaValue: '',
                llegadaHoraComparison: '',
                llegadaHoraValue: '',
                retrasosThreshold: '',
                tiempoDiferencia: '',
                tiempoDireccion: 'any',
                tiempoTipo: 'any',
                accionRecomendada: []
            };
            
            document.querySelectorAll('#colmenaDropdown input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.querySelectorAll('#areaDropdown input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.querySelectorAll('#turnoDropdown input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.querySelectorAll('#clasificacionDropdown input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            updateMultiSelectDisplay('colmena');
            updateMultiSelectDisplay('area');
            updateMultiSelectDisplay('turno');
            updateMultiSelectDisplay('clasificacion');
            
            document.getElementById('salidaComparison').value = '';
            document.getElementById('salidaValue').value = '';
            document.getElementById('llegadaAreaComparison').value = '';
            document.getElementById('llegadaAreaValue').value = '';
            document.getElementById('retrasoAreaComparison').value = '';
            document.getElementById('retrasoAreaValue').value = '';
            document.getElementById('llegadaHoraComparison').value = '';
            document.getElementById('llegadaHoraValue').value = '';
            document.getElementById('retrasosComparisonFilter').value = '';
            document.getElementById('retrasosThresholdFilter').value = '';
            document.getElementById('tiempoDiferenciaFilter').value = '';
            document.getElementById('tiempoDireccionFilter').value = 'any';
            document.getElementById('tiempoTipoFilter').value = 'any';
            
            applyAllFilters();
        }

        function updateThresholdInfo() {
            const thresholdInfo = document.getElementById('currentThresholdInfo');
            if (thresholdInfo) {
                thresholdInfo.textContent = `TR‚â§${tensionadaRetrasosThreshold}%, TL‚â§${tensionadaLlegadaThreshold}%, H‚â•${holguraThreshold}%`;
            }
        }

        function updateResultsDisplay() {
            const total = filteredResults.length;
            
            const stats = {
                total: total,
                tensionadaRetrasos: 0,
                tensionadaLlegada: 0,
                holguraTiempo: 0,
                holguraTiempoVolumen: 0
            };

            filteredResults.forEach(result => {
                switch(result.accion) {
                    case 'Tensionada Retrasos': stats.tensionadaRetrasos++; break;
                    case 'Tensionada Llegada': stats.tensionadaLlegada++; break;
                    case 'Holgura Tiempo': stats.holguraTiempo++; break;
                    case 'Holgura Tiempo-Volumen': stats.holguraTiempoVolumen++; break;
                }
            });

            const statsGrid = document.getElementById('statsGrid');
            if (total > 0) {
                statsGrid.innerHTML = `
                    <div class="stat-card danger">
                        <div class="stat-header">
                            <div class="stat-title">Tensionadas Retrasos</div>
                            <i class="fas fa-exclamation-triangle stat-icon"></i>
                        </div>
                        <div class="stat-number">${stats.tensionadaRetrasos}</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-header">
                            <div class="stat-title">Tensionadas Llegada</div>
                            <i class="fas fa-clock stat-icon"></i>
                        </div>
                        <div class="stat-number">${stats.tensionadaLlegada}</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-header">
                            <div class="stat-title">Holgura Tiempo</div>
                            <i class="fas fa-check-circle stat-icon"></i>
                        </div>
                        <div class="stat-number">${stats.holguraTiempo}</div>
                    </div>
                    <div class="stat-card info">
                        <div class="stat-header">
                            <div class="stat-title">Holgura Tiempo-Volumen</div>
                            <i class="fas fa-chart-line stat-icon"></i>
                        </div>
                        <div class="stat-number">${stats.holguraTiempoVolumen}</div>
                    </div>
                `;
            } else {
                statsGrid.innerHTML = '<div style="text-align: center; color: #6b7280;">No hay operativas para mostrar</div>';
            }

            const tbody = document.getElementById('resultsTableBody');
            
            // Calcular semana actual
            const semanaActual = getWeekNumber(new Date());
            
            // Verificar operativas repetidas (hacer solo una llamada para todas)
            verificarTodasOperativasRepetidas(filteredResults, semanaActual).then(repetidas => {
                operativasRepetidas = repetidas;
                
                tbody.innerHTML = filteredResults.map(result => {
                    const salidaValue = parseFloat(formatValue(result.porcSalidaEnHora)) || 0;
                    const llegadaAreaValue = parseFloat(formatValue(result.porcLlegadaArea)) || 0;
                    const retrasoAreaValue = parseFloat(formatValue(result.porcRetrasoEnArea)) || 0;
                    const llegadaHoraValue = parseFloat(formatValue(result.porcLlegadaEnHora)) || 0;
                    const retrasosValue = parseFloat(formatValue(result.porcRetrasos)) || 0;
                    
                    const colTempus = formatValue(result.colTempus) || '0';
                    const colTeorica = formatValue(result.colTeorica) || '0'; 
                    const colVolumen = formatValue(result.colVolumen) || '0';
                    const tooltipData = `Tempus: ${colTempus}|Te√≥rico: ${colTeorica}|Volumen: ${colVolumen}`;
                    
                    // Construir URLs de Metabase con par√°metros espec√≠ficos
                    const colmena = extractColmena(result.operativa);
                    const turno = extractTurno(result.operativa);
                    const area = extractArea(result.operativa);
                    
                    // URL para seguimiento de retrasos (respeta may√∫sculas/min√∫sculas)
                    const retrasosUrl = `https://metabase.prod.monline/question/28532-seguimiento-retrasos-por-tramo-u7d?area=${encodeURIComponent(area)}&hive_code=${colmena}&shift=${turno}`;
                    
                    // URL para salidas tarde por loading order
                    const salidasTardeUrl = `https://metabase.prod.monline/question/29927-salidas-tarde-por-loading-order-7d?hive_code=${colmena}&shift=${turno}&area=${encodeURIComponent(area)}`;
                    
                    // URL para simulaci√≥n de rutas (fecha de hoy y hive_code)
                    const fechaHoy = new Date().toISOString().split('T')[0]; // Formato YYYY-MM-DD
                    const simulacionUrl = `https://metabase.prod.monline/question/21898-new-slot-machine-routes-simulation-plan?configuration_id=&area_name=${encodeURIComponent(area)}&shift=${turno}&route_tpe=&Fecha=${fechaHoy}&hive_code=${colmena}`;
                    
                    // Verificar si est√° repetida
                    const infoRepetida = operativasRepetidas[result.operativa] || { esRepetida: false };
                    const esRepetida = infoRepetida.esRepetida;
                    
                    return `
                    <tr>
                        <td><strong><a href="${simulacionUrl}" target="_blank" style="color: #f9fafb; text-decoration: underline;">${result.operativa}</a></strong></td>
                        <td style="text-align: center;">
                            ${esRepetida ? 
                                `<span class="repetida-badge" 
                                      data-comentario="${(infoRepetida.comentario || 'Sin comentario').replace(/"/g, '&quot;')}"
                                      data-fecha="${infoRepetida.fecha}"
                                      data-semana="${infoRepetida.semana}"
                                      data-accion="${infoRepetida.accion || 'Sin acci√≥n'}"
                                      data-salida="${infoRepetida.metricas?.porcSalidaEnHora || 'N/A'}"
                                      data-llegada-area="${infoRepetida.metricas?.porcLlegadaArea || 'N/A'}"
                                      data-retraso-area="${infoRepetida.metricas?.porcRetrasoEnArea || 'N/A'}"
                                      data-llegada-hora="${infoRepetida.metricas?.porcLlegadaEnHora || 'N/A'}"
                                      style="display: inline-flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: #000; padding: 6px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3); cursor: help;">
                                    <i class="fas fa-history"></i>
                                </span>` 
                                : '<span style="color: #6b7280; font-size: 0.75rem;">‚Äî</span>'}
                        </td>
                        <td>${formatValue(result.rutasDia)}</td>
                        <td>${formatValue(result.dias)}</td>
                        <td>${formatValue(result.colPorRuta)}</td>
                        <td><a href="${retrasosUrl}" target="_blank" style="color: #3b82f6; text-decoration: underline; font-weight: 600;">${formatValue(result.porcRetrasos)}%</a></td>
                        <td>
                            <a href="${salidasTardeUrl}" target="_blank" style="text-decoration: underline !important;">
                                <span class="percentage-badge ${getPercentageBadgeClass(salidaValue)}" style="text-decoration: underline !important;">${formatValue(result.porcSalidaEnHora)}%</span>
                            </a>
                        </td>
                        <td>
                            <span class="percentage-badge ${getPercentageBadgeClass(llegadaAreaValue)}">${formatValue(result.porcLlegadaArea)}%</span>
                        </td>
                        <td>
                            <span class="percentage-badge ${getPercentageBadgeClass(retrasoAreaValue, true)}">${formatValue(result.porcRetrasoEnArea)}%</span>
                        </td>
                        <td>
                            <span class="percentage-badge ${getPercentageBadgeClass(llegadaHoraValue)}">${formatValue(result.porcLlegadaEnHora)}%</span>
                        </td>
                        <td><span class="status-badge ${getStatusClass(result.accion)}">${result.accion}</span></td>
                        <td class="volume-tooltip-cell" data-volume-info="${tooltipData}" data-title="Detalles de Volumen - ${result.operativa}">
                            <span class="status-badge ${result.volumeProblems.hasProblems ? 'status-warning' : 'status-success'}">${result.volumeProblems.message}</span>
                        </td>
                        <td style="font-size: 0.6875rem;">${createRecommendations(result)}</td>
                        <td style="padding: 0.5rem;">
                            <select class="action-select" 
                                    onchange="saveAction('${result.operativa.replace(/'/g, "\\'")}', this.value)"
                                    style="width: 100%; padding: 0.375rem 0.5rem; background: #1a1f2e; border: 1px solid #4b5563; border-radius: 0.375rem; color: #e5e7eb; font-size: 0.8125rem; cursor: pointer;">
                                <option value="">Seleccionar...</option>
                                <option value="Ajuste tiempo" ${getAction(result.operativa) === 'Ajuste tiempo' ? 'selected' : ''}>Ajuste tiempo</option>
                                <option value="Ajuste productividad" ${getAction(result.operativa) === 'Ajuste productividad' ? 'selected' : ''}>Ajuste productividad</option>
                                <option value="Ajuste productividad/tiempo" ${getAction(result.operativa) === 'Ajuste productividad/tiempo' ? 'selected' : ''}>Ajuste productividad/tiempo</option>
                                <option value="Sin acci√≥n" ${getAction(result.operativa) === 'Sin acci√≥n' ? 'selected' : ''}>Sin acci√≥n</option>
                            </select>
                        </td>
                        <td class="comments-column">
                            <textarea class="comment-input" 
                                      placeholder="A√±adir comentario..." 
                                      onchange="saveComment('${result.operativa.replace(/'/g, "\\'")}', this.value)"
                                      oninput="saveComment('${result.operativa.replace(/'/g, "\\'")}', this.value)">${getComment(result.operativa)}</textarea>
                        </td>
                    </tr>
                    `;
                }).join('');
                
                addVolumeTooltipListeners();
                addRepetidaTooltipListeners();
            });
        }

        // Summary functions
        function showSummaryTab() {
            let hasResults = false;
            for (let i = 0; i < analysisResultsByDataset.length; i++) {
                if (analysisResultsByDataset[i] && analysisResultsByDataset[i].length > 0) {
                    hasResults = true;
                    break;
                }
            }
            
            if (!hasResults) {
                document.getElementById('summaryContent').classList.add('hidden');
                document.getElementById('noSummaryData').style.display = 'block';
                return;
            }

            populateWeekSelector();
            updateSummaryView();
            
            document.getElementById('summaryContent').classList.remove('hidden');
            document.getElementById('noSummaryData').style.display = 'none';
        }

        function populateWeekSelector() {
            const selector = document.getElementById('summaryWeekSelector');
            
            selector.innerHTML = '<option value="all">Todas las semanas</option>';
            
            datasets.forEach((data, index) => {
                if (data && analysisResultsByDataset[index] && analysisResultsByDataset[index].length > 0) {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = datasetNames[index] || `Archivo ${index + 1}`;
                    selector.appendChild(option);
                }
            });
        }

        function updateSummaryView() {
            const selector = document.getElementById('summaryWeekSelector');
            const selectedValue = selector.value;
            
            let allSummaryData = [];
            
            if (selectedValue === 'all') {
                datasets.forEach((data, index) => {
                    if (data && analysisResultsByDataset[index] && analysisResultsByDataset[index].length > 0) {
                        const datasetResults = analysisResultsByDataset[index].map(result => ({
                            ...result,
                            datasetName: datasetNames[index] || `Archivo ${index + 1}`,
                            datasetIndex: index
                        }));
                        allSummaryData.push(...datasetResults);
                    }
                });
            } else {
                const datasetIndex = parseInt(selectedValue);
                if (datasets[datasetIndex] && analysisResultsByDataset[datasetIndex] && analysisResultsByDataset[datasetIndex].length > 0) {
                    allSummaryData = analysisResultsByDataset[datasetIndex].map(result => ({
                        ...result,
                        datasetName: datasetNames[datasetIndex] || `Archivo ${datasetIndex + 1}`,
                        datasetIndex: datasetIndex
                    }));
                }
            }

            if (allSummaryData.length === 0) {
                document.getElementById('summaryContent').classList.add('hidden');
                document.getElementById('noSummaryData').style.display = 'block';
                return;
            }

            function addToConsolidatedTooltip(tooltipMap, operativa, datasetName, isConsolidatedView) {
                if (!tooltipMap.has(operativa)) {
                    tooltipMap.set(operativa, new Set());
                }
                if (isConsolidatedView === 'all' && datasetName) {
                    tooltipMap.get(operativa).add(datasetName);
                }
            }
            
            function mapToTooltipArray(tooltipMap, isConsolidatedView) {
                const result = [];
                for (const [operativa, datasets] of tooltipMap.entries()) {
                    if (isConsolidatedView === 'all' && datasets.size > 0) {
                        const datasetsList = Array.from(datasets).sort().join(', ');
                        result.push(`${operativa} (${datasetsList})`);
                    } else {
                        result.push(operativa);
                    }
                }
                return result.sort();
            }

            const colmenaGroups = {};
            const operativesByColmenaAndAction = {};
            const rutasDiaByOperativa = {};
            
            const allColmenas = new Set();
            allSummaryData.forEach(result => {
                const colmena = extractColmena(result.operativa);
                if (colmena) allColmenas.add(colmena);
            });
            
            allColmenas.forEach(colmena => {
                colmenaGroups[colmena] = {
                    tensionadaRetrasos: new Set(),
                    tensionadaLlegada: new Set(),
                    holguraTiempo: new Set(),
                    holguraTiempoVolumen: new Set(),
                    todasOperativas: new Set()
                };
                
                operativesByColmenaAndAction[colmena] = {
                    tensionadaRetrasos: [],
                    tensionadaLlegada: [],
                    holguraTiempo: [],
                    holguraTiempoVolumen: []
                };
            });
            
            allSummaryData.forEach(result => {
                const operativa = result.operativa;
                const colmena = extractColmena(operativa);
                if (!colmena || !operativa) return;
                
                if (result.accion === 'Holgura Tiempo-Volumen') {
                    const rutasDia = parseFloat((result.rutasDia || '0').toString().replace(',', '.')) || 0;
                    
                    if (rutasDia > 0) {
                        if (!rutasDiaByOperativa[operativa]) {
                            rutasDiaByOperativa[operativa] = {
                                colmena: colmena,
                                valores: []
                            };
                        }
                        rutasDiaByOperativa[operativa].valores.push(rutasDia);
                    }
                }
            });
            
            const consolidatedTooltips = {};
            allColmenas.forEach(colmena => {
                consolidatedTooltips[colmena] = {
                    tensionadaRetrasos: new Map(),
                    tensionadaLlegada: new Map(),
                    holguraTiempo: new Map(),
                    holguraTiempoVolumen: new Map()
                };
            });
            
            allSummaryData.forEach(result => {
                const operativa = result.operativa;
                const colmena = extractColmena(operativa);
                if (!colmena || !operativa) return;
                
                const group = colmenaGroups[colmena];
                
                group.todasOperativas.add(operativa);
                
                const datasetName = result.datasetName || '';
                
                switch(result.accion) {
                    case 'Tensionada Retrasos':
                        group.tensionadaRetrasos.add(operativa);
                        addToConsolidatedTooltip(consolidatedTooltips[colmena].tensionadaRetrasos, operativa, datasetName, selectedValue);
                        break;
                    case 'Tensionada Llegada':
                        group.tensionadaLlegada.add(operativa);
                        addToConsolidatedTooltip(consolidatedTooltips[colmena].tensionadaLlegada, operativa, datasetName, selectedValue);
                        break;
                    case 'Holgura Tiempo':
                        group.holguraTiempo.add(operativa);
                        addToConsolidatedTooltip(consolidatedTooltips[colmena].holguraTiempo, operativa, datasetName, selectedValue);
                        break;
                    case 'Holgura Tiempo-Volumen':
                        group.holguraTiempoVolumen.add(operativa);
                        addToConsolidatedTooltip(consolidatedTooltips[colmena].holguraTiempoVolumen, operativa, datasetName, selectedValue);
                        break;
                }
            });
            
            allColmenas.forEach(colmena => {
                operativesByColmenaAndAction[colmena] = {
                    tensionadaRetrasos: mapToTooltipArray(consolidatedTooltips[colmena].tensionadaRetrasos, selectedValue),
                    tensionadaLlegada: mapToTooltipArray(consolidatedTooltips[colmena].tensionadaLlegada, selectedValue),
                    holguraTiempo: mapToTooltipArray(consolidatedTooltips[colmena].holguraTiempo, selectedValue),
                    holguraTiempoVolumen: mapToTooltipArray(consolidatedTooltips[colmena].holguraTiempoVolumen, selectedValue)
                };
            });
            
            const rutasDiaTotalByColmena = {};
            allColmenas.forEach(colmena => {
                rutasDiaTotalByColmena[colmena] = 0;
            });
            
            Object.keys(rutasDiaByOperativa).forEach(operativa => {
                const data = rutasDiaByOperativa[operativa];
                const colmena = data.colmena;
                
                const valorFinal = data.valores.length > 0 ? 
                    data.valores.reduce((sum, val) => sum + val, 0) / data.valores.length : 0;
                
                rutasDiaTotalByColmena[colmena] += valorFinal;
            });
            
            const finalColmenaGroups = {};
            Object.keys(colmenaGroups).forEach(colmena => {
                const group = colmenaGroups[colmena];
                finalColmenaGroups[colmena] = {
                    total: group.todasOperativas.size,
                    tensionadaRetrasos: group.tensionadaRetrasos.size,
                    tensionadaLlegada: group.tensionadaLlegada.size,
                    holguraTiempo: group.holguraTiempo.size,
                    holguraTiempoVolumen: group.holguraTiempoVolumen.size,
                    rutasDiaTotal: Math.round(rutasDiaTotalByColmena[colmena] || 0)
                };
            });
            
            createSummaryTable(finalColmenaGroups, operativesByColmenaAndAction, selectedValue);
        }

        function createSummaryTable(colmenaGroups, operativesByColmenaAndAction, selectedView = 'all') {
            const colmenas = Object.keys(colmenaGroups).sort();
            
            if (colmenas.length === 0) {
                document.getElementById('summaryTable').innerHTML = 
                    '<div style="padding: 2rem; text-align: center; color: #6b7280;">No hay datos por colmena</div>';
                return;
            }
            
            function getColmenaColor(colmena) {
                const colmenaLower = colmena.toLowerCase();
                switch(colmenaLower) {
                    case 'vlc1': return '#d6e2c3';
                    case 'bcn1': return '#c7d4de';
                    case 'mad1': return '#f0cec6';
                    case 'alc1': return '#fcf7c8';
                    case 'svq1': return '#e1c4df';
                    case 'mad2': return '#e7c0d0';
                    default: return '#374151';
                }
            }

            function createTooltipCell(content, operativas, title, color) {
                const displayValue = content === 0 ? '--' : content;
                
                if (operativas && operativas.length > 0) {
                    const uniqueOperativas = [...new Set(operativas)];
                    const operativasText = uniqueOperativas.join('|');
                    return `<td class="tooltip-cell" data-operativas="${operativasText}" data-title="${title}" style="color: ${color}; font-weight: 600;">${displayValue}</td>`;
                } else {
                    return `<td style="color: ${color}; font-weight: 600;">--</td>`;
                }
            }

            let headerContent = '';
            if (selectedView === 'all') {
                const datasetsCount = getLoadedDatasetsCount();
                const analysisCount = analysisResultsByDataset.filter(results => results && results.length > 0).length;
                const currentDate = new Date().toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    year: '2-digit'
                });
                headerContent = `<span style="font-size: 0.8125rem;">${currentDate}<br>${analysisCount} de ${datasetsCount} archivo${datasetsCount !== 1 ? 's' : ''} analizados</span>`;
            } else {
                const datasetIndex = parseInt(selectedView);
                const currentDate = new Date().toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    year: '2-digit'
                });
                const fileName = datasetNames[datasetIndex] || `Archivo ${datasetIndex + 1}`;
                headerContent = `<span style="font-size: 0.8125rem;">${currentDate}<br>${fileName}</span>`;
            }
            
            let tableHTML = `
                <div class="summary-table-container">
                    <table class="summary-table">
                        <thead>
                            <tr>
                                <th style="background: #374151; color: #e5e7eb; width: 175px;">
                                    ${headerContent}
                                </th>
                                ${colmenas.map(colmena => 
                                    `<th style="background: ${getColmenaColor(colmena)}; color: #1f2937;">${colmena.toUpperCase()}</th>`
                                ).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="background: #374151; color: #e5e7eb; text-align: center; font-weight: 600;">
                                    Operativas Totales
                                </td>
                                ${colmenas.map(colmena => 
                                    `<td style="color: #e5e7eb; font-weight: 600;">${colmenaGroups[colmena].total}</td>`
                                ).join('')}
                            </tr>
                            <tr>
                                <td style="background: #374151; color: #e5e7eb; text-align: center; font-weight: 600;">
                                    <span class="status-badge status-danger">Tensionadas Retrasos</span>
                                </td>
                                ${colmenas.map(colmena => {
                                    const count = colmenaGroups[colmena].tensionadaRetrasos;
                                    return createTooltipCell(
                                        count,
                                        operativesByColmenaAndAction[colmena]?.tensionadaRetrasos,
                                        `Operativas √∫nicas tensionadas por retrasos en ${colmena.toUpperCase()}`,
                                        '#ef4444'
                                    );
                                }).join('')}
                            </tr>
                            <tr>
                                <td style="background: #374151; color: #e5e7eb; text-align: center; font-weight: 600;">
                                    <span class="status-badge status-warning">Tensionadas Llegada</span>
                                </td>
                                ${colmenas.map(colmena => {
                                    const count = colmenaGroups[colmena].tensionadaLlegada;
                                    return createTooltipCell(
                                        count,
                                        operativesByColmenaAndAction[colmena]?.tensionadaLlegada,
                                        `Operativas √∫nicas tensionadas por llegada en ${colmena.toUpperCase()}`,
                                        '#f59e0b'
                                    );
                                }).join('')}
                            </tr>
                            <tr>
                                <td style="background: #374151; color: #e5e7eb; text-align: center; font-weight: 600;">
                                    <span class="status-badge status-success">Holgura Tiempo</span>
                                </td>
                                ${colmenas.map(colmena => {
                                    const count = colmenaGroups[colmena].holguraTiempo;
                                    return createTooltipCell(
                                        count,
                                        operativesByColmenaAndAction[colmena]?.holguraTiempo,
                                        `Operativas √∫nicas con holgura de tiempo en ${colmena.toUpperCase()}`,
                                        '#10b981'
                                    );
                                }).join('')}
                            </tr>
                            <tr>
                                <td style="background: #374151; color: #e5e7eb; text-align: center; font-weight: 600;">
                                    <span class="status-badge status-info">Holgura Tiempo-Volumen</span>
                                </td>
                                ${colmenas.map(colmena => {
                                    const count = colmenaGroups[colmena].holguraTiempoVolumen;
                                    return createTooltipCell(
                                        count,
                                        operativesByColmenaAndAction[colmena]?.holguraTiempoVolumen,
                                        `Operativas √∫nicas con holgura tiempo-volumen en ${colmena.toUpperCase()}`,
                                        '#06b6d4'
                                    );
                                }).join('')}
                            </tr>
                            <tr>
                                <td style="background: #374151; color: #e5e7eb; text-align: center; font-weight: 600;">
                                    Rutas/d√≠a Promedio
                                </td>
                                ${colmenas.map(colmena => {
                                    const rutasTotal = colmenaGroups[colmena].rutasDiaTotal;
                                    const displayValue = rutasTotal > 0 ? rutasTotal : '--';
                                    return `<td style="color: #3b82f6; font-weight: 600;">${displayValue}</td>`;
                                }).join('')}
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('summaryTable').innerHTML = tableHTML;
            
            addTooltipListeners();
        }

        // Tooltip functions
        function addTooltipListeners() {
            const tooltipCells = document.querySelectorAll('.tooltip-cell');
            
            tooltipCells.forEach(cell => {
                cell.addEventListener('mouseenter', showTooltip);
                cell.addEventListener('mouseleave', hideTooltip);
                cell.addEventListener('mousemove', moveTooltip);
            });
        }

        function showTooltip(event) {
            const cell = event.target;
            const title = cell.getAttribute('data-title');
            const operativasText = cell.getAttribute('data-operativas');
            
            if (!title || !operativasText) return;
            
            const operativas = operativasText.split('|');
            
            let tooltip = document.getElementById('summary-tooltip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.id = 'summary-tooltip';
                tooltip.className = 'tooltip';
                document.body.appendChild(tooltip);
            }
            
            const operativasList = operativas.map(op => `<div class="tooltip-operativa">‚Ä¢ ${op}</div>`).join('');
            
            tooltip.innerHTML = `
                <div class="tooltip-title">${title}</div>
                <div class="tooltip-content">${operativasList}</div>
            `;
            
            moveTooltip(event);
            
            tooltip.classList.add('visible');
        }

        function hideTooltip() {
            const tooltip = document.getElementById('summary-tooltip');
            if (tooltip) {
                tooltip.classList.remove('visible');
            }
        }

        function moveTooltip(event) {
            const tooltip = document.getElementById('summary-tooltip');
            if (!tooltip) return;
            
            const mouseX = event.clientX;
            const mouseY = event.clientY;
            const tooltipRect = tooltip.getBoundingClientRect();
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            
            let left = mouseX + 15;
            let top = mouseY - 10;
            
            if (left + tooltipRect.width > windowWidth) {
                left = mouseX - tooltipRect.width - 15;
            }
            
            if (top + tooltipRect.height > windowHeight) {
                top = mouseY - tooltipRect.height - 10;
            }
            
            if (top < 0) {
                top = mouseY + 15;
            }
            
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
        }

        // Volume tooltip functions
        function addVolumeTooltipListeners() {
            const volumeCells = document.querySelectorAll('.volume-tooltip-cell');
            
            volumeCells.forEach(cell => {
                cell.addEventListener('mouseenter', showVolumeTooltip);
                cell.addEventListener('mouseleave', hideVolumeTooltip);
                cell.addEventListener('mousemove', moveVolumeTooltip);
            });
        }

        function showVolumeTooltip(event) {
            const cell = event.target.closest('.volume-tooltip-cell');
            const title = cell.getAttribute('data-title');
            const volumeInfo = cell.getAttribute('data-volume-info');
            
            if (!title || !volumeInfo) return;
            
            const volumeData = volumeInfo.split('|');
            
            let tooltip = document.getElementById('volume-tooltip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.id = 'volume-tooltip';
                tooltip.className = 'tooltip';
                document.body.appendChild(tooltip);
            }
            
            const volumeList = volumeData.map(data => `<div style="padding: 0.125rem 0; font-size: 0.6875rem;">‚Ä¢ ${data}</div>`).join('');
            
            tooltip.innerHTML = `
                <div class="tooltip-title">${title}</div>
                <div class="tooltip-content">${volumeList}</div>
            `;
            
            moveVolumeTooltip(event);
            
            tooltip.classList.add('visible');
        }

        function hideVolumeTooltip() {
            const tooltip = document.getElementById('volume-tooltip');
            if (tooltip) {
                tooltip.classList.remove('visible');
            }
        }

        function moveVolumeTooltip(event) {
            const tooltip = document.getElementById('volume-tooltip');
            if (!tooltip) return;
            
            const mouseX = event.clientX;
            const mouseY = event.clientY;
            const tooltipRect = tooltip.getBoundingClientRect();
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            
            let left = mouseX + 15;
            let top = mouseY - 10;
            
            if (left + tooltipRect.width > windowWidth) {
                left = mouseX - tooltipRect.width - 15;
            }
            
            if (top + tooltipRect.height > windowHeight) {
                top = mouseY - tooltipRect.height - 10;
            }
            
            if (top < 0) {
                top = mouseY + 15;
            }
            
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
        }

        // Funciones para tooltips de operativas repetidas
        function addRepetidaTooltipListeners() {
            const repetidaBadges = document.querySelectorAll('.repetida-badge');
            
            repetidaBadges.forEach(badge => {
                badge.addEventListener('mouseenter', showRepetidaTooltip);
                badge.addEventListener('mouseleave', hideRepetidaTooltip);
                badge.addEventListener('mousemove', moveRepetidaTooltip);
            });
        }

        function showRepetidaTooltip(event) {
            const badge = event.currentTarget;
            const comentario = badge.getAttribute('data-comentario');
            const semana = badge.getAttribute('data-semana');
            const accion = badge.getAttribute('data-accion');
            const salidaEnHora = badge.getAttribute('data-salida');
            const llegadaArea = badge.getAttribute('data-llegada-area');
            const retrasoArea = badge.getAttribute('data-retraso-area');
            const llegadaEnHora = badge.getAttribute('data-llegada-hora');
            
            if (!comentario) return;
            
            let tooltip = document.getElementById('repetida-tooltip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.id = 'repetida-tooltip';
                tooltip.className = 'tooltip';
                document.body.appendChild(tooltip);
            }
            
            tooltip.innerHTML = `
                <div class="tooltip-title" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: #000;">
                    <i class="fas fa-history"></i> Registro Semana ${semana}
                </div>
                <div class="tooltip-content">
                    <div style="padding: 0.5rem 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 0.5rem;">
                        <div style="font-size: 0.7rem; color: #9ca3af; margin-bottom: 0.5rem;">M√©tricas Anteriores:</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.75rem;">
                            <div>
                                <div style="color: #9ca3af; font-size: 0.7rem; margin-bottom: 0.25rem;">% Salida en Hora:</div>
                                <div style="font-weight: 600;">${salidaEnHora}%</div>
                            </div>
                            <div>
                                <div style="color: #9ca3af; font-size: 0.7rem; margin-bottom: 0.25rem;">% Llegada √Årea:</div>
                                <div style="font-weight: 600;">${llegadaArea}%</div>
                            </div>
                            <div>
                                <div style="color: #9ca3af; font-size: 0.7rem; margin-bottom: 0.25rem;">% Retraso en √Årea:</div>
                                <div style="font-weight: 600;">${retrasoArea}%</div>
                            </div>
                            <div>
                                <div style="color: #9ca3af; font-size: 0.7rem; margin-bottom: 0.25rem;">% Llegada en Hora:</div>
                                <div style="font-weight: 600;">${llegadaEnHora}%</div>
                            </div>
                        </div>
                    </div>
                    <div style="padding: 0.5rem 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 0.5rem;">
                        <div style="font-size: 0.7rem; color: #9ca3af; margin-bottom: 0.25rem;">Acci√≥n Tomada:</div>
                        <div style="display: inline-block; padding: 0.25rem 0.5rem; background: #3b82f6; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">${accion}</div>
                    </div>
                    <div style="padding: 0.5rem 0;">
                        <div style="font-size: 0.7rem; color: #9ca3af; margin-bottom: 0.25rem;">Comentario:</div>
                        <div style="font-size: 0.8rem; line-height: 1.4;">${comentario}</div>
                    </div>
                </div>
            `;
            
            moveRepetidaTooltip(event);
            
            tooltip.classList.add('visible');
        }

        function hideRepetidaTooltip() {
            const tooltip = document.getElementById('repetida-tooltip');
            if (tooltip) {
                tooltip.classList.remove('visible');
            }
        }

        function moveRepetidaTooltip(event) {
            const tooltip = document.getElementById('repetida-tooltip');
            if (!tooltip) return;
            
            const mouseX = event.clientX;
            const mouseY = event.clientY;
            const tooltipRect = tooltip.getBoundingClientRect();
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            
            let left = mouseX + 15;
            let top = mouseY - 10;
            
            if (left + tooltipRect.width > windowWidth) {
                left = mouseX - tooltipRect.width - 15;
            }
            
            if (top + tooltipRect.height > windowHeight) {
                top = mouseY - tooltipRect.height - 10;
            }
            
            if (top < 0) {
                top = mouseY + 15;
            }
            
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            switchTab('analysis');
            
            initializeSidebar();
            
            document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
            document.addEventListener('click', handleOutsideClick);
            window.addEventListener('resize', handleResize);
            
            document.querySelectorAll('[data-tab]').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    switchTab(this.dataset.tab);
                });
            });
        });

        // File upload para 4 archivos
        for (let i = 1; i <= 4; i++) {
            document.getElementById(`csvFile${i}`).addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        processCSV(e.target.result, i - 1, file.name);
                    };
                    reader.readAsText(file);
                }
            });
        }

        // Operative selection
        document.getElementById('selectAllBtn').addEventListener('click', function() {
            const currentData = datasets[currentActiveDataset];
            if (!currentData) return;
            
            const currentSelections = selectedOperativesByDataset[currentActiveDataset];
            const isSelectingAll = currentSelections.size < currentData.length;
            
            if (isSelectingAll) {
                currentData.forEach((_, index) => {
                    currentSelections.add(index);
                });
                this.innerHTML = '<i class="fas fa-square"></i> Deseleccionar Todas';
            } else {
                currentSelections.clear();
                this.innerHTML = '<i class="fas fa-check-square"></i> Seleccionar Todas';
            }
            
            renderOperatives(currentActiveDataset);
            updateSelectionInfo(currentActiveDataset);
        });

        document.getElementById('analyzeBtn').addEventListener('click', function() {
            const currentData = datasets[currentActiveDataset];
            if (!currentData || selectedOperativesByDataset[currentActiveDataset].size === 0) return;
            
            const selectedData = Array.from(selectedOperativesByDataset[currentActiveDataset]).map(index => currentData[index]);
            const results = selectedData.map(row => analyzeDelay(row));
            displayResults(results, currentActiveDataset);
        });

        document.getElementById('toggleSelectionBtn').addEventListener('click', toggleSelectionView);

        // Search and filter
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            const selectedColmena = document.getElementById('colmenaFilter').value;
            const currentData = datasets[currentActiveDataset];
            
            if (!currentData) return;
            
            filteredOperativesByDataset[currentActiveDataset] = currentData
                .map((row, index) => ({ ...row, originalIndex: index }))
                .filter(row => {
                    const matchesSearch = searchTerm === '' || 
                        (row.operativa || '').toLowerCase().includes(searchTerm);
                    
                    const operativaColmena = extractColmena(row.operativa);
                    const matchesColmena = selectedColmena === '' || operativaColmena === selectedColmena;
                    
                    return matchesSearch && matchesColmena;
                });
            
            renderOperatives(currentActiveDataset);
        });

        document.getElementById('colmenaFilter').addEventListener('change', function(e) {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const selectedColmena = e.target.value;
            const currentData = datasets[currentActiveDataset];
            
            if (!currentData) return;
            
            filteredOperativesByDataset[currentActiveDataset] = currentData
                .map((row, index) => ({ ...row, originalIndex: index }))
                .filter(row => {
                    const matchesSearch = searchTerm === '' || 
                        (row.operativa || '').toLowerCase().includes(searchTerm);
                    
                    const operativaColmena = extractColmena(row.operativa);
                    const matchesColmena = selectedColmena === '' || operativaColmena === selectedColmena;
                    
                    return matchesSearch && matchesColmena;
                });
            
            renderOperatives(currentActiveDataset);
        });

        // Results filters
        document.addEventListener('change', function(e) {
            if (e.target.id === 'salidaComparison') {
                activeFilters.salidaComparison = e.target.value;
                applyAllFilters();
            } else if (e.target.id === 'llegadaAreaComparison') {
                activeFilters.llegadaAreaComparison = e.target.value;
                applyAllFilters();
            } else if (e.target.id === 'retrasoAreaComparison') {
                activeFilters.retrasoAreaComparison = e.target.value;
                applyAllFilters();
            } else if (e.target.id === 'llegadaHoraComparison') {
                activeFilters.llegadaHoraComparison = e.target.value;
                applyAllFilters();
            } else if (e.target.id === 'retrasosComparisonFilter') {
                activeFilters.retrasosComparison = e.target.value;
                applyAllFilters();
            } else if (e.target.id === 'tiempoDireccionFilter') {
                activeFilters.tiempoDireccion = e.target.value;
                applyAllFilters();
            } else if (e.target.id === 'tiempoTipoFilter') {
                activeFilters.tiempoTipo = e.target.value;
                applyAllFilters();
            }
        });

        document.addEventListener('input', function(e) {
            if (e.target.id === 'salidaValue') {
                activeFilters.salidaValue = e.target.value;
                applyAllFilters();
            } else if (e.target.id === 'llegadaAreaValue') {
                activeFilters.llegadaAreaValue = e.target.value;
                applyAllFilters();
            } else if (e.target.id === 'retrasoAreaValue') {
                activeFilters.retrasoAreaValue = e.target.value;
                applyAllFilters();
            } else if (e.target.id === 'llegadaHoraValue') {
                activeFilters.llegadaHoraValue = e.target.value;
                applyAllFilters();
            } else if (e.target.id === 'retrasosThresholdFilter') {
                activeFilters.retrasosThreshold = e.target.value;
                applyAllFilters();
            } else if (e.target.id === 'tiempoDiferenciaFilter') {
                activeFilters.tiempoDiferencia = e.target.value;
                applyAllFilters();
            }
        });

        document.getElementById('clearFiltersBtn').addEventListener('click', clearAllFilters);

        // Settings
        ['tensionadaRetrasosInput', 'tensionadaLlegadaInput', 'holguraInput'].forEach(id => {
            document.getElementById(id).addEventListener('input', function() {
                document.getElementById('applyThreshold').disabled = false;
            });
        });

        document.getElementById('applyThreshold').addEventListener('click', function() {
            // Actualizar los valores de los umbrales
            tensionadaRetrasosThreshold = parseInt(document.getElementById('tensionadaRetrasosInput').value);
            tensionadaLlegadaThreshold = parseInt(document.getElementById('tensionadaLlegadaInput').value);
            holguraThreshold = parseInt(document.getElementById('holguraInput').value);
            
            console.log(`Aplicando nuevos umbrales: TR‚â§${tensionadaRetrasosThreshold}%, TL‚â§${tensionadaLlegadaThreshold}%, H‚â•${holguraThreshold}%`);
            
            // Re-analizar TODOS los datasets cargados (no solo las selecciones)
            let hasResults = false;
            datasets.forEach((data, index) => {
                if (data && data.length > 0) {
                    console.log(`Re-analizando dataset ${index} (${datasetNames[index]}) con ${data.length} operativas`);
                    // Re-analizar TODAS las operativas del dataset con los nuevos umbrales
                    const results = data.map(row => analyzeDelay(row));
                    analysisResultsByDataset[index] = results;
                    hasResults = true;
                }
            });
            
            // Mostrar los resultados del dataset activo
            if (hasResults && analysisResultsByDataset[currentActiveDataset] && analysisResultsByDataset[currentActiveDataset].length > 0) {
                displayResults(analysisResultsByDataset[currentActiveDataset], currentActiveDataset);
                console.log(`Mostrando resultados del dataset ${currentActiveDataset} con ${analysisResultsByDataset[currentActiveDataset].length} operativas`);
            }
            
            // Actualizar las pesta√±as para reflejar los nuevos an√°lisis
            showDatasetTabs();
            
            // Actualizar la informaci√≥n de umbrales en la UI
            updateThresholdInfo();
            
            // Feedback visual
            this.innerHTML = '<i class="fas fa-check"></i> Configuraci√≥n Aplicada ‚úì';
            this.disabled = true;
            this.style.background = '#059669';
            
            setTimeout(() => {
                this.innerHTML = '<i class="fas fa-save"></i> Aplicar Configuraci√≥n';
                this.disabled = false;
                this.style.background = '';
            }, 3000);
        });

        // Download Excel
        document.getElementById('downloadExcelBtn').addEventListener('click', function() {
            const allResults = [];
            datasets.forEach((data, index) => {
                if (data && analysisResultsByDataset[index].length > 0) {
                    allResults.push(...analysisResultsByDataset[index].map(result => ({
                        ...result,
                        dataset: datasetNames[index] || `Archivo ${index + 1}`
                    })));
                }
            });
            
            if (allResults.length === 0) {
                alert('No hay datos para descargar');
                return;
            }
            
            // Funci√≥n para calcular n√∫mero de semana del a√±o
            function getWeekNumber(date) {
                const d = new Date(date);
                d.setHours(0, 0, 0, 0);
                d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7);
                const week1 = new Date(d.getFullYear(), 0, 4);
                return 1 + Math.round(((d - week1) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
            }
            
            const fechaActual = new Date();
            const numeroSemana = getWeekNumber(fechaActual);
            
            const excelData = allResults.map(result => ({
                'Colmena': extractColmena(result.operativa) || '',
                'Operativa': result.operativa || '',
                'Rutas por D√≠a': formatValue(result.rutasDia),
                'D√≠as': formatValue(result.dias),
                'Columnas por Ruta': formatValue(result.colPorRuta),
                '% Retrasos': formatValue(result.porcRetrasos),
                '% Salida en Hora': formatValue(result.porcSalidaEnHora),
                '% Llegada √Årea': formatValue(result.porcLlegadaArea),
                '% Retraso en √Årea': formatValue(result.porcRetrasoEnArea),
                '% Llegada en Hora': formatValue(result.porcLlegadaEnHora),
                'Clasificaci√≥n': result.accion || '',
                'Problemas de Volumen': result.volumeProblems ? result.volumeProblems.message : '',
                'Posibles Acciones': createPlainTextRecommendations(result),
                'Comentarios': getComment(result.operativa),
                '': '', // Columna en blanco
                'Col Te√≥ricas': formatValue(result.colTeorica),
                'PD Te√≥rico': formatValue(result.pdTeorico),
                'UD Te√≥rico': formatValue(result.udTeorico),
                'Col Tempus': formatValue(result.colTempus),
                'PD Tempus': formatValue(result.pdTempus),
                'UD Tempus': formatValue(result.udTempus),
                'Col Volumen': formatValue(result.colVolumen),
                'Fecha An√°lisis': new Date().toLocaleDateString('es-ES'),
                'Semana': numeroSemana
            }));
            
            // Crear workbook de Excel
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(excelData);
            
            // Configurar ancho de columnas
            const columnWidths = [
                { wch: 10 }, // Colmena
                { wch: 25 }, // Operativa
                { wch: 12 }, // Rutas por D√≠a
                { wch: 8 },  // D√≠as
                { wch: 15 }, // Columnas por Ruta
                { wch: 10 }, // % Retrasos
                { wch: 15 }, // % Salida en Hora
                { wch: 15 }, // % Llegada √Årea
                { wch: 18 }, // % Retraso en √Årea
                { wch: 18 }, // % Llegada en Hora
                { wch: 18 }, // Clasificaci√≥n
                { wch: 20 }, // Problemas de Volumen
                { wch: 50 }, // Posibles Acciones
                { wch: 30 }, // Comentarios
                 { wch: 3 },  // Columna en blanco
                { wch: 12 }, // Col Te√≥ricas
                { wch: 12 }, // PD Te√≥rico
                { wch: 12 }, // UD Te√≥rico
                { wch: 12 }, // Col Tempus
                { wch: 12 }, // PD Tempus
                { wch: 12 }, // UD Tempus
                { wch: 12 }, // Col Volumen
                { wch: 15 }, // Fecha An√°lisis
                { wch: 8 }   // Semana
            ];
            ws['!cols'] = columnWidths;
            
            // Agregar hoja al workbook
            XLSX.utils.book_append_sheet(wb, ws, 'An√°lisis Operativo');
            
            // Descargar archivo
            const fechaArchivo = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `analisis_consolidado_${fechaArchivo}.xlsx`);
            
            // Visual feedback
            const btn = document.getElementById('downloadExcelBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> Descargado';
            
            setTimeout(() => {
                btn.innerHTML = originalText;
            }, 2000);
        });

        // ============================================
        // FUNCIONALIDAD DE REGISTRO EN JSONBIN
        // ============================================
        
        const JSONBIN_CONFIG = {
            binId: '68f263e843b1c97be96d4cd3',
            masterKey: '$2a$10$byEkgCiPtr6uA9j.sw5Uiuld00jGPRMT1Rn9TlhHYbPe3CFfaEu6G',
            apiUrl: 'https://api.jsonbin.io/v3'
        };

        // Funci√≥n para calcular n√∫mero de semana del a√±o
        function getWeekNumber(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7);
            const week1 = new Date(d.getFullYear(), 0, 4);
            return 1 + Math.round(((d - week1) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
        }

        // Funci√≥n para verificar si una operativa est√° repetida de la semana anterior
        async function verificarOperativaRepetida(operativa, semanaActual) {
            try {
                const response = await fetch(`${JSONBIN_CONFIG.apiUrl}/b/${JSONBIN_CONFIG.binId}/latest`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': JSONBIN_CONFIG.masterKey,
                        'X-Bin-Meta': 'false'
                    }
                });

                if (!response.ok) {
                    return false;
                }

                const data = await response.json();
                const registros = data.record?.registros || data.registros || [];
                
                // Buscar si existe la misma operativa en la semana anterior
                const semanaAnterior = semanaActual - 1;
                const existe = registros.some(reg => 
                    reg.operativa === operativa && reg.semana == semanaAnterior
                );
                
                return existe;
            } catch (error) {
                console.error('Error al verificar operativa repetida:', error);
                return false;
            }
        }

        // Funci√≥n para verificar todas las operativas de una vez (m√°s eficiente)
        async function verificarTodasOperativasRepetidas(results, semanaActual) {
            try {
                const response = await fetch(`${JSONBIN_CONFIG.apiUrl}/b/${JSONBIN_CONFIG.binId}/latest`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': JSONBIN_CONFIG.masterKey,
                        'X-Bin-Meta': 'false'
                    }
                });

                if (!response.ok) {
                    return {};
                }

                const data = await response.json();
                const registros = data.record?.registros || data.registros || [];
                
                // Crear un mapa de operativas repetidas con sus comentarios
                const semanaAnterior = semanaActual - 1;
                const repetidas = {};
                
                results.forEach(result => {
                    const registroEncontrado = registros.find(reg => 
                        reg.operativa === result.operativa && reg.semana == semanaAnterior
                    );
                    
                    if (registroEncontrado) {
                        repetidas[result.operativa] = {
                            esRepetida: true,
                            comentario: registroEncontrado.comentario || 'Sin comentario',
                            fecha: registroEncontrado.fechaFormateada || '',
                            semana: registroEncontrado.semana,
                            accion: registroEncontrado.accion || 'Sin acci√≥n',
                            metricas: {
                                porcSalidaEnHora: registroEncontrado.metricas?.porcSalidaEnHora || 'N/A',
                                porcLlegadaArea: registroEncontrado.metricas?.porcLlegadaArea || 'N/A',
                                porcRetrasoEnArea: registroEncontrado.metricas?.porcRetrasoEnArea || 'N/A',
                                porcLlegadaEnHora: registroEncontrado.metricas?.porcLlegadaEnHora || 'N/A'
                            }
                        };
                    } else {
                        repetidas[result.operativa] = {
                            esRepetida: false,
                            comentario: '',
                            fecha: '',
                            semana: null,
                            accion: '',
                            metricas: null
                        };
                    }
                });
                
                return repetidas;
            } catch (error) {
                console.error('Error al verificar operativas repetidas:', error);
                return {};
            }
        }

        // Cache para operativas repetidas
        let operativasRepetidas = {};

        // Funci√≥n para guardar registro en JSONBin
async function saveRegistroToJsonBin() {
    try {
        // Recopilar todas las operativas con comentarios
        const registros = [];
        
        // Funci√≥n para calcular n√∫mero de semana del a√±o
        function getWeekNumber(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7);
            const week1 = new Date(d.getFullYear(), 0, 4);
            return 1 + Math.round(((d - week1) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
        }
        
        const fechaActual = new Date();
        const numeroSemana = getWeekNumber(fechaActual);
        
        // Verificar TODAS las operativas repetidas de una vez ANTES de guardar
        let todasLasOperativas = [];
        datasets.forEach((data, index) => {
            if (data && analysisResultsByDataset[index] && analysisResultsByDataset[index].length > 0) {
                analysisResultsByDataset[index].forEach(result => {
                    todasLasOperativas.push(result);
                });
            }
        });
        
        // Obtener informaci√≥n de repetidas
        const operativasRepetidasInfo = await verificarTodasOperativasRepetidas(todasLasOperativas, numeroSemana);
        
        datasets.forEach((data, index) => {
            if (data && analysisResultsByDataset[index] && analysisResultsByDataset[index].length > 0) {
                analysisResultsByDataset[index].forEach(result => {
                    const comment = operativeComments[result.operativa];
                    if (comment && comment.trim()) {
                        const action = operativeActions[result.operativa] || '';
                        
                        // Obtener informaci√≥n de operativa repetida desde el cache
                        const infoRepetida = operativasRepetidasInfo[result.operativa] || { esRepetida: false };
                        
                        registros.push({
                            operativa: result.operativa,
                            colmena: extractColmena(result.operativa),
                            comentario: comment,
                            accion: action,
                            fecha: new Date().toISOString(),
                            fechaFormateada: new Date().toLocaleDateString('es-ES'),
                            semana: numeroSemana,
                            clasificacion: result.accion,
                            // Informaci√≥n de operativa repetida
                            esRepetida: infoRepetida.esRepetida,
                            infoRepetida: infoRepetida.esRepetida ? {
                                fechaAnterior: infoRepetida.fecha,
                                semanaAnterior: infoRepetida.semana,
                                comentarioAnterior: infoRepetida.comentario,
                                accionAnterior: infoRepetida.accion,
                                metricasAnteriores: infoRepetida.metricas
                            } : null,
                            metricas: {
                                rutasDia: result.rutasDia,
                                dias: result.dias,
                                colPorRuta: result.colPorRuta,
                                porcRetrasos: result.porcRetrasos,
                                porcSinRetraso: result.porcSinRetraso,
                                porcSalidaEnHora: result.porcSalidaEnHora,
                                porcLlegadaArea: result.porcLlegadaArea,
                                porcRetrasoEnArea: result.porcRetrasoEnArea,
                                porcLlegadaEnHora: result.porcLlegadaEnHora,
                                colTeorica: result.colTeorica,
                                pdTeorico: result.pdTeorico,
                                udTeorico: result.udTeorico,
                                colTempus: result.colTempus,
                                pdTempus: result.pdTempus,
                                udTempus: result.udTempus,
                                colVolumen: result.colVolumen
                            },
                            volumeProblems: result.volumeProblems,
                            recomendaciones: result.recomendaciones,
                            dataset: datasetNames[index]
                        });
                    }
                });
            }
        });

        if (registros.length === 0) {
            alert('No hay operativas con comentarios para guardar');
            return;
        }

        console.log('Intentando guardar', registros.length, 'registros');
        console.log('Registros con informaci√≥n de repetidas:', registros.filter(r => r.esRepetida).length);

        // Obtener registros existentes
        let existingData = { registros: [] };
        
        try {
            const response = await fetch(`${JSONBIN_CONFIG.apiUrl}/b/${JSONBIN_CONFIG.binId}/latest`, {
                method: 'GET',
                headers: {
                    'X-Master-Key': JSONBIN_CONFIG.masterKey,
                    'X-Bin-Meta': 'false'
                }
            });

            if (response.ok) {
                const data = await response.json();
                // Intentar obtener los datos de diferentes formas seg√∫n la respuesta de JSONBin
                if (data.record && data.record.registros) {
                    existingData = data.record;
                } else if (data.record && Array.isArray(data.record)) {
                    existingData = { registros: data.record };
                } else if (data.registros) {
                    existingData = data;
                } else if (Array.isArray(data)) {
                    existingData = { registros: data };
                } else {
                    existingData = { registros: [] };
                }
                console.log('Datos existentes cargados:', existingData.registros?.length || 0, 'registros');
            } else {
                console.warn('No se pudieron cargar datos existentes, iniciando con array vac√≠o');
            }
        } catch (fetchError) {
            console.warn('Error al obtener datos existentes:', fetchError);
        }

        // Agregar nuevos registros al final (preservando los anteriores)
        const existingRegistros = Array.isArray(existingData.registros) ? existingData.registros : [];
        existingData.registros = [...existingRegistros, ...registros];

        console.log('Total de registros a guardar:', existingData.registros.length);

        // Guardar en JSONBin
        const saveResponse = await fetch(`${JSONBIN_CONFIG.apiUrl}/b/${JSONBIN_CONFIG.binId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-Master-Key': JSONBIN_CONFIG.masterKey,
                'X-Bin-Versioning': 'false'
            },
            body: JSON.stringify(existingData)
        });

        const responseData = await saveResponse.json();
        console.log('Respuesta del servidor:', responseData);

        if (saveResponse.ok) {
            const repetidasCount = registros.filter(r => r.esRepetida).length;
            alert(`‚úì Se guardaron ${registros.length} operativa(s) con comentarios en el registro\n${repetidasCount > 0 ? `(${repetidasCount} operativa(s) repetida(s) detectada(s))` : ''}`);
            
            // Feedback visual en el bot√≥n
            const btn = document.getElementById('saveRegistroBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> Guardado';
            btn.disabled = true;
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 2000);
        } else {
            throw new Error(responseData.message || 'Error al guardar en JSONBin');
        }

    } catch (error) {
        console.error('Error completo al guardar registro:', error);
        alert('Error al guardar el registro: ' + error.message + '\n\nRevisa la consola del navegador (F12) para m√°s detalles.');
    }
}

        // Funci√≥n para cargar y mostrar el registro
        let allRegistros = []; // Variable global para almacenar todos los registros
        
        async function loadRegistro(aplicarFiltros = false) {
            const container = document.getElementById('registroContainer');
            
            if (!aplicarFiltros) {
                // Mostrar indicador de carga solo si no es filtrado
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #6b7280;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: #3b82f6; margin-bottom: 1rem;"></i>
                        <h3>Cargando registros...</h3>
                    </div>
                `;
            }
            
            try {
                if (!aplicarFiltros) {
                    console.log('=== INICIANDO CARGA DE REGISTROS ===');
                    console.log('URL:', `${JSONBIN_CONFIG.apiUrl}/b/${JSONBIN_CONFIG.binId}/latest`);
                    console.log('Bin ID:', JSONBIN_CONFIG.binId);
                    
                    const response = await fetch(`${JSONBIN_CONFIG.apiUrl}/b/${JSONBIN_CONFIG.binId}/latest`, {
                        method: 'GET',
                        headers: {
                            'X-Master-Key': JSONBIN_CONFIG.masterKey,
                            'X-Bin-Meta': 'false'
                        }
                    });

                    console.log('Status de respuesta:', response.status);
                    console.log('Status text:', response.statusText);

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Error response body:', errorText);
                        
                        let errorMsg = `Error ${response.status}: ${response.statusText}`;
                        try {
                            const errorJson = JSON.parse(errorText);
                            errorMsg += `\n${errorJson.message || ''}`;
                        } catch (e) {
                            errorMsg += `\n${errorText}`;
                        }
                        
                        throw new Error(errorMsg);
                    }

                    const data = await response.json();
                    console.log('Datos recibidos:', data);
                    
                    allRegistros = data.record?.registros || data.registros || [];
                    console.log('Total de registros encontrados:', allRegistros.length);
                }

                // Aplicar filtros
                const filtroSemana = document.getElementById('filtroSemana')?.value || '';
                const filtroColmena = document.getElementById('filtroColmena')?.value || '';
                const filtroArea = document.getElementById('filtroArea')?.value || '';
                
                let registrosFiltrados = [...allRegistros];
                
                if (filtroSemana) {
                    registrosFiltrados = registrosFiltrados.filter(reg => reg.semana == filtroSemana);
                }
                
                if (filtroColmena) {
                    registrosFiltrados = registrosFiltrados.filter(reg => 
                        (reg.colmena || extractColmena(reg.operativa)) === filtroColmena
                    );
                }
                
                if (filtroArea) {
                    registrosFiltrados = registrosFiltrados.filter(reg => 
                        extractArea(reg.operativa) === filtroArea
                    );
                }

                if (registrosFiltrados.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #6b7280;">
                            <i class="fas fa-clipboard-list" style="font-size: 3rem; color: #374151; margin-bottom: 1rem;"></i>
                            <h3>Sin registros</h3>
                            <p>${allRegistros.length > 0 ? 'No hay registros que coincidan con los filtros aplicados' : 'Los registros guardados aparecer√°n aqu√≠'}</p>
                            ${allRegistros.length > 0 ? '<p style="font-size: 0.75rem; margin-top: 1rem; color: #9ca3af;">Intenta limpiar los filtros</p>' : '<p style="font-size: 0.75rem; margin-top: 1rem; color: #9ca3af;">Conexi√≥n exitosa con JSONBin</p>'}
                        </div>
                    `;
                    
                    // Actualizar filtros aunque no haya resultados filtrados
                    if (!aplicarFiltros && allRegistros.length > 0) {
                        actualizarFiltros(allRegistros);
                    }
                    return;
                }

                // Ordenar por fecha descendente
                registrosFiltrados.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

                // Actualizar los selectores de filtros (siempre, para que sean dependientes)
                actualizarFiltros(allRegistros);

                // Crear tabla con el mismo formato que an√°lisis
                container.innerHTML = `
                    <div class="table-container">
                        <table id="registroTable" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #374151;">
                                    <th style="padding: 12px; text-align: left; color: #f9fafb; font-weight: 600; border-bottom: 2px solid #4b5563; width: 60px;">Acci√≥n</th>
                                    <th style="padding: 12px; text-align: left; color: #f9fafb; font-weight: 600; border-bottom: 2px solid #4b5563;">Fecha / Semana</th>
                                    <th style="padding: 12px; text-align: left; color: #f9fafb; font-weight: 600; border-bottom: 2px solid #4b5563;">Operativa</th>
                                    <th style="padding: 12px; text-align: center; color: #f9fafb; font-weight: 600; border-bottom: 2px solid #4b5563; width: 100px;">Repetida</th>
                                    <th style="padding: 12px; text-align: left; color: #f9fafb; font-weight: 600; border-bottom: 2px solid #4b5563;">Rutas/D√≠a</th>
                                    <th style="padding: 12px; text-align: left; color: #f9fafb; font-weight: 600; border-bottom: 2px solid #4b5563;">D√≠as</th>
                                    <th style="padding: 12px; text-align: left; color: #f9fafb; font-weight: 600; border-bottom: 2px solid #4b5563;">Col/Ruta</th>
                                    <th style="padding: 12px; text-align: left; color: #f9fafb; font-weight: 600; border-bottom: 2px solid #4b5563;">% Retrasos</th>
                                    <th style="padding: 12px; text-align: left; color: #f9fafb; font-weight: 600; border-bottom: 2px solid #4b5563;">% Salida en Hora</th>
                                    <th style="padding: 12px; text-align: left; color: #f9fafb; font-weight: 600; border-bottom: 2px solid #4b5563;">% Llegada √Årea</th>
                                    <th style="padding: 12px; text-align: left; color: #f9fafb; font-weight: 600; border-bottom: 2px solid #4b5563;">% Retraso en √Årea</th>
                                    <th style="padding: 12px; text-align: left; color: #f9fafb; font-weight: 600; border-bottom: 2px solid #4b5563;">% Llegada en Hora</th>
                                    <th style="padding: 12px; text-align: left; color: #f9fafb; font-weight: 600; border-bottom: 2px solid #4b5563;">Clasificaci√≥n</th>
                                    <th style="padding: 12px; text-align: left; color: #f9fafb; font-weight: 600; border-bottom: 2px solid #4b5563;">Acci√≥n Tomada</th>
                                    <th style="padding: 12px; text-align: left; color: #f9fafb; font-weight: 600; border-bottom: 2px solid #4b5563;">Comentarios</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${registrosFiltrados.map((reg, index) => {
                                    // Calcular valores para las clases de porcentaje
                                    const salidaValue = parseFloat(formatValue(reg.metricas?.porcSalidaEnHora)) || 0;
                                    const llegadaAreaValue = parseFloat(formatValue(reg.metricas?.porcLlegadaArea)) || 0;
                                    const retrasoAreaValue = parseFloat(formatValue(reg.metricas?.porcRetrasoEnArea)) || 0;
                                    const llegadaHoraValue = parseFloat(formatValue(reg.metricas?.porcLlegadaEnHora)) || 0;
                                    
                                    // Crear un ID √∫nico basado en la fecha y operativa
                                    const registroId = `${reg.fecha}_${reg.operativa}`.replace(/[^a-zA-Z0-9]/g, '_');
                                    
                                    // Preparar tooltip para operativa repetida
                                    const tooltipRepetida = reg.esRepetida && reg.infoRepetida ? 
                                        `Anterior: ${reg.infoRepetida.fechaAnterior || 'N/A'} (Semana ${reg.infoRepetida.semanaAnterior || 'N/A'})\\nComentario: ${(reg.infoRepetida.comentarioAnterior || 'Sin comentario').replace(/"/g, '&quot;')}\\nAcci√≥n: ${reg.infoRepetida.accionAnterior || 'Sin acci√≥n'}` 
                                        : '';
                                    
                                    return `
                                        <tr id="row_${registroId}" style="border-bottom: 1px solid #374151; transition: background 0.2s;" 
                                            onmouseover="this.style.background='rgba(55, 65, 81, 0.3)'" 
                                            onmouseout="this.style.background=''">
                                            <td style="padding: 12px; text-align: center;">
                                                <button onclick="eliminarRegistro('${registroId}', '${reg.fecha}', '${reg.operativa.replace(/'/g, "\\'")}', '${registrosFiltrados.length}')" 
                                                        class="icon-btn" style="color: #ef4444;" title="Eliminar registro">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                            <td style="padding: 12px; color: #e5e7eb; font-size: 0.875rem;">
                                                ${reg.fechaFormateada || 'Sin fecha'}
                                                <!-- CAMPO EDITABLE DE SEMANA -->
                                                <div style="margin-top: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                                    <span style="color: #9ca3af; font-size: 0.75rem;">Semana:</span>
                                                    <input type="number" 
                                                           class="semana-input-registro" 
                                                           data-registro-id="${registroId}"
                                                           data-fecha="${reg.fecha}"
                                                           data-operativa="${reg.operativa}"
                                                           value="${reg.semana || ''}"
                                                           min="1"
                                                           max="53"
                                                           style="width: 60px; padding: 0.25rem 0.5rem; background: #1a1f2e; border: 1px solid #4b5563; border-radius: 0.375rem; color: #e5e7eb; font-size: 0.75rem; text-align: center;"
                                                           title="Editar semana">
                                                </div>
                                            </td>
                                            <td style="padding: 12px; color: #e5e7eb; font-size: 0.875rem;">${reg.operativa || 'Sin operativa'}</td>
                                            <td style="padding: 12px; text-align: center;">
                                                ${reg.esRepetida ? 
                                                    `<span class="repetida-badge-registro" 
                                                          title="${tooltipRepetida}"
                                                          style="display: inline-flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: #000; padding: 6px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; cursor: help;">
                                                        <i class="fas fa-history"></i>
                                                    </span>` 
                                                    : '<span style="color: #6b7280; font-size: 0.75rem;">‚Äî</span>'}
                                            </td>
                                            <td style="padding: 12px; color: #e5e7eb; font-size: 0.875rem; text-align: center;">${formatValue(reg.metricas?.rutasDia)}</td>
                                            <td style="padding: 12px; color: #e5e7eb; font-size: 0.875rem; text-align: center;">${formatValue(reg.metricas?.dias)}</td>
                                            <td style="padding: 12px; color: #e5e7eb; font-size: 0.875rem; text-align: center;">${formatValue(reg.metricas?.colPorRuta)}</td>
                                            <td style="padding: 12px; color: #e5e7eb; font-size: 0.875rem; text-align: center;">${formatValue(reg.metricas?.porcRetrasos)}%</td>
                                            <td style="padding: 12px; text-align: center;">
                                                <span class="percentage-badge ${getPercentageBadgeClass(salidaValue)}">${formatValue(reg.metricas?.porcSalidaEnHora)}%</span>
                                            </td>
                                            <td style="padding: 12px; text-align: center;">
                                                <span class="percentage-badge ${getPercentageBadgeClass(llegadaAreaValue)}">${formatValue(reg.metricas?.porcLlegadaArea)}%</span>
                                            </td>
                                            <td style="padding: 12px; text-align: center;">
                                                <span class="percentage-badge ${getPercentageBadgeClass(retrasoAreaValue, true)}">${formatValue(reg.metricas?.porcRetrasoEnArea)}%</span>
                                            </td>
                                            <td style="padding: 12px; text-align: center;">
                                                <span class="percentage-badge ${getPercentageBadgeClass(llegadaHoraValue)}">${formatValue(reg.metricas?.porcLlegadaEnHora)}%</span>
                                            </td>
                                            <td style="padding: 12px;">
                                                <span class="status-badge ${getStatusClass(reg.clasificacion || 'Sin Clasificar')}">${reg.clasificacion || 'Sin Clasificar'}</span>
                                            </td>
                                            <td style="padding: 8px;">
                                                <select class="action-select-registro" 
                                                        data-registro-id="${registroId}"
                                                        data-fecha="${reg.fecha}"
                                                        data-operativa="${reg.operativa}"
                                                        style="width: 100%; padding: 0.375rem 0.5rem; background: #1a1f2e; border: 1px solid #4b5563; border-radius: 0.375rem; color: #e5e7eb; font-size: 0.8125rem; cursor: pointer;">
                                                    <option value="">Seleccionar...</option>
                                                    <option value="Ajuste tiempo" ${(reg.accion === 'Ajuste tiempo') ? 'selected' : ''}>Ajuste tiempo</option>
                                                    <option value="Ajuste productividad" ${(reg.accion === 'Ajuste productividad') ? 'selected' : ''}>Ajuste productividad</option>
                                                    <option value="Ajuste productividad/tiempo" ${(reg.accion === 'Ajuste productividad/tiempo') ? 'selected' : ''}>Ajuste productividad/tiempo</option>
                                                    <option value="Sin acci√≥n" ${(reg.accion === 'Sin acci√≥n') ? 'selected' : ''}>Sin acci√≥n</option>
                                                </select>
                                            </td>
                                            <td style="padding: 8px;">
                                                <textarea class="comment-input-registro" 
                                                          data-registro-id="${registroId}"
                                                          data-fecha="${reg.fecha}"
                                                          data-operativa="${reg.operativa}"
                                                          style="width: 100%; min-height: 60px; max-height: 100px; padding: 0.5rem; background: #1a1f2e; border: 1px solid #4b5563; border-radius: 0.375rem; color: #e5e7eb; font-size: 0.8125rem; resize: vertical;"
                                                          placeholder="Editar comentario...">${reg.comentario || ''}</textarea>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                console.log('=== REGISTROS CARGADOS EXITOSAMENTE ===');

            } catch (error) {
                console.error('=== ERROR AL CARGAR REGISTRO ===');
                console.error('Tipo de error:', error.name);
                console.error('Mensaje:', error.message);
                console.error('Stack:', error.stack);
                
                container.innerHTML = `
                    <div style="background: #dc2626; border-radius: 0.5rem; padding: 1.5rem; color: white; margin: 1rem 0;">
                        <div style="display: flex; align-items: start; gap: 1rem;">
                            <i class="fas fa-exclamation-circle" style="font-size: 2rem; margin-top: 0.25rem;"></i>
                            <div style="flex: 1;">
                                <h3 style="margin-bottom: 0.5rem; font-size: 1.125rem;">Error al cargar registros</h3>
                                <p style="margin-bottom: 0.5rem; font-size: 0.875rem; opacity: 0.9;">${error.message}</p>
                                <details style="margin-top: 1rem; background: rgba(0,0,0,0.2); padding: 0.75rem; border-radius: 0.25rem; font-size: 0.75rem;">
                                    <summary style="cursor: pointer; font-weight: 600; margin-bottom: 0.5rem;">Detalles t√©cnicos</summary>
                                    <div style="margin-top: 0.5rem; font-family: monospace; white-space: pre-wrap; word-break: break-all;">
Bin ID: ${JSONBIN_CONFIG.binId}
URL: ${JSONBIN_CONFIG.apiUrl}/b/${JSONBIN_CONFIG.binId}/latest
Error: ${error.name}
Mensaje: ${error.message}

Verifica en la consola del navegador (F12) para m√°s informaci√≥n.

Posibles causas:
1. La Master Key no es v√°lida
2. El Bin ID no existe o no tienes permisos
3. Problemas de CORS
4. El bin no tiene la estructura correcta

Soluci√≥n:
1. Verifica tus credenciales en JSONBin.io
2. Aseg√∫rate de que el bin existe y est√° activo
3. Revisa los permisos del bin
                                    </div>
                                </details>
                                <button onclick="loadRegistro()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: white; color: #dc2626; border: none; border-radius: 0.25rem; cursor: pointer; font-weight: 600;">
                                    <i class="fas fa-redo"></i> Reintentar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        // Funci√≥n para actualizar los selectores de filtros de manera inteligente
        function actualizarFiltros(registros) {
            // Obtener valores actuales de los filtros
            const semanaActual = document.getElementById('filtroSemana')?.value || '';
            const colmenaActual = document.getElementById('filtroColmena')?.value || '';
            const areaActual = document.getElementById('filtroArea')?.value || '';
            
            // Filtrar registros seg√∫n los filtros ya aplicados (para actualizar los otros filtros)
            let registrosFiltradosParaSemana = [...registros];
            let registrosFiltradosParaColmena = [...registros];
            let registrosFiltradosParaArea = [...registros];
            
            // Para semanas: aplicar filtro de colmena y √°rea si est√°n activos
            if (colmenaActual) {
                registrosFiltradosParaSemana = registrosFiltradosParaSemana.filter(reg => 
                    (reg.colmena || extractColmena(reg.operativa)) === colmenaActual
                );
            }
            if (areaActual) {
                registrosFiltradosParaSemana = registrosFiltradosParaSemana.filter(reg => 
                    extractArea(reg.operativa) === areaActual
                );
            }
            
            // Para colmenas: aplicar filtro de semana y √°rea si est√°n activos
            if (semanaActual) {
                registrosFiltradosParaColmena = registrosFiltradosParaColmena.filter(reg => 
                    reg.semana == semanaActual
                );
            }
            if (areaActual) {
                registrosFiltradosParaColmena = registrosFiltradosParaColmena.filter(reg => 
                    extractArea(reg.operativa) === areaActual
                );
            }
            
            // Para √°reas: aplicar filtro de semana y colmena si est√°n activos
            if (semanaActual) {
                registrosFiltradosParaArea = registrosFiltradosParaArea.filter(reg => 
                    reg.semana == semanaActual
                );
            }
            if (colmenaActual) {
                registrosFiltradosParaArea = registrosFiltradosParaArea.filter(reg => 
                    (reg.colmena || extractColmena(reg.operativa)) === colmenaActual
                );
            }
            
            // Recopilar valores √∫nicos seg√∫n los filtros aplicados
            const semanas = new Set();
            const colmenas = new Set();
            const areas = new Set();
            
            registrosFiltradosParaSemana.forEach(reg => {
                if (reg.semana) semanas.add(reg.semana);
            });
            
            registrosFiltradosParaColmena.forEach(reg => {
                const colmena = reg.colmena || extractColmena(reg.operativa);
                if (colmena) colmenas.add(colmena);
            });
            
            registrosFiltradosParaArea.forEach(reg => {
                const area = extractArea(reg.operativa);
                if (area) areas.add(area);
            });
            
            // Actualizar selector de semanas
            const filtroSemana = document.getElementById('filtroSemana');
            filtroSemana.innerHTML = '<option value="">Todas las semanas</option>' +
                Array.from(semanas).sort((a, b) => b - a).map(s => 
                    `<option value="${s}" ${s == semanaActual ? 'selected' : ''}>Semana ${s}</option>`
                ).join('');
            
            // Actualizar selector de colmenas
            const filtroColmena = document.getElementById('filtroColmena');
            filtroColmena.innerHTML = '<option value="">Todas las colmenas</option>' +
                Array.from(colmenas).sort().map(c => 
                    `<option value="${c}" ${c === colmenaActual ? 'selected' : ''}>${c}</option>`
                ).join('');
            
            // Actualizar selector de √°reas
            const filtroArea = document.getElementById('filtroArea');
            filtroArea.innerHTML = '<option value="">Todas las √°reas</option>' +
                Array.from(areas).sort().map(a => 
                    `<option value="${a}" ${a === areaActual ? 'selected' : ''}>${a}</option>`
                ).join('');
        }
        
        // Funci√≥n para eliminar un registro
        async function eliminarRegistro(registroId, fecha, operativa, cantidadFiltrada) {
            if (!confirm(`¬øEst√°s seguro de eliminar el registro de "${operativa}"?`)) {
                return;
            }
            
            try {
                console.log('Eliminando registro:', fecha, operativa);
                
                // Filtrar el registro a eliminar
                const registrosActualizados = allRegistros.filter(reg => 
                    !(reg.fecha === fecha && reg.operativa === operativa)
                );
                
                console.log('Registros antes:', allRegistros.length);
                console.log('Registros despu√©s:', registrosActualizados.length);
                
                if (registrosActualizados.length === allRegistros.length) {
                    alert('No se pudo encontrar el registro para eliminar');
                    return;
                }
                
                // Guardar en JSONBin
                const saveResponse = await fetch(`${JSONBIN_CONFIG.apiUrl}/b/${JSONBIN_CONFIG.binId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': JSONBIN_CONFIG.masterKey,
                        'X-Bin-Versioning': 'false'
                    },
                    body: JSON.stringify({ registros: registrosActualizados })
                });

                if (!saveResponse.ok) {
                    throw new Error('Error al guardar cambios en JSONBin');
                }
                
                // Actualizar la variable global
                allRegistros = registrosActualizados;
                
                // Recargar la tabla con los filtros actuales
                loadRegistro(true);
                
                alert('Registro eliminado correctamente');
                
            } catch (error) {
                console.error('Error al eliminar registro:', error);
                alert('Error al eliminar el registro: ' + error.message);
            }
        }

        // Funci√≥n para guardar comentario editado en el registro
        async function guardarComentarioEditado(fecha, operativa, nuevoComentario) {
            try {
                // Buscar y actualizar el registro
                const registroIndex = allRegistros.findIndex(reg => 
                    reg.fecha === fecha && reg.operativa === operativa
                );
                
                if (registroIndex === -1) {
                    console.error('No se encontr√≥ el registro');
                    return;
                }
                
                // Actualizar el comentario
                allRegistros[registroIndex].comentario = nuevoComentario;
                
                // Guardar en JSONBin
                const saveResponse = await fetch(`${JSONBIN_CONFIG.apiUrl}/b/${JSONBIN_CONFIG.binId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': JSONBIN_CONFIG.masterKey,
                        'X-Bin-Versioning': 'false'
                    },
                    body: JSON.stringify({ registros: allRegistros })
                });

                if (!saveResponse.ok) {
                    throw new Error('Error al guardar cambios en JSONBin');
                }
                
                console.log('Comentario actualizado correctamente');
                
            } catch (error) {
                console.error('Error al guardar comentario:', error);
                alert('Error al guardar el comentario: ' + error.message);
            }
        }

        // Funci√≥n para guardar acci√≥n editada en el registro
        async function guardarAccionEditada(fecha, operativa, nuevaAccion) {
            try {
                // Buscar y actualizar el registro
                const registroIndex = allRegistros.findIndex(reg => 
                    reg.fecha === fecha && reg.operativa === operativa
                );
                
                if (registroIndex === -1) {
                    console.error('No se encontr√≥ el registro');
                    return;
                }
                
                // Actualizar la acci√≥n
                allRegistros[registroIndex].accion = nuevaAccion;
                
                // Guardar en JSONBin
                const saveResponse = await fetch(`${JSONBIN_CONFIG.apiUrl}/b/${JSONBIN_CONFIG.binId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': JSONBIN_CONFIG.masterKey,
                        'X-Bin-Versioning': 'false'
                    },
                    body: JSON.stringify({ registros: allRegistros })
                });

                if (!saveResponse.ok) {
                    throw new Error('Error al guardar cambios en JSONBin');
                }
                
                console.log('Acci√≥n actualizada correctamente');
                
            } catch (error) {
                console.error('Error al guardar acci√≥n:', error);
                alert('Error al guardar la acci√≥n: ' + error.message);
            }
        }

        // Funci√≥n para guardar semana editada en el registro
        async function guardarSemanaEditada(fecha, operativa, nuevaSemana) {
            try {
                // Buscar y actualizar el registro
                const registroIndex = allRegistros.findIndex(reg => 
                    reg.fecha === fecha && reg.operativa === operativa
                );
                
                if (registroIndex === -1) {
                    console.error('No se encontr√≥ el registro');
                    return;
                }
                
                // Validar la semana
                const semanaNum = parseInt(nuevaSemana);
                if (isNaN(semanaNum) || semanaNum < 1 || semanaNum > 53) {
                    alert('La semana debe ser un n√∫mero entre 1 y 53');
                    return;
                }
                
                // Actualizar la semana
                allRegistros[registroIndex].semana = semanaNum;
                
                // Guardar en JSONBin
                const saveResponse = await fetch(`${JSONBIN_CONFIG.apiUrl}/b/${JSONBIN_CONFIG.binId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': JSONBIN_CONFIG.masterKey,
                        'X-Bin-Versioning': 'false'
                    },
                    body: JSON.stringify({ registros: allRegistros })
                });

                if (!saveResponse.ok) {
                    throw new Error('Error al guardar cambios en JSONBin');
                }
                
                console.log('Semana actualizada correctamente a:', semanaNum);
                
                // Actualizar los filtros (por si la nueva semana no exist√≠a antes)
                actualizarFiltros(allRegistros);
                
                // Mostrar feedback visual
                const input = document.querySelector(`input[data-fecha="${fecha}"][data-operativa="${operativa}"].semana-input-registro`);
                if (input) {
                    const originalBorder = input.style.borderColor;
                    input.style.borderColor = '#10b981';
                    input.style.boxShadow = '0 0 0 2px rgba(16, 185, 129, 0.2)';
                    
                    setTimeout(() => {
                        input.style.borderColor = originalBorder;
                        input.style.boxShadow = '';
                    }, 1000);
                }
                
            } catch (error) {
                console.error('Error al guardar semana:', error);
                alert('Error al guardar la semana: ' + error.message);
            }
        }

        // Event listener para detectar cambios en los comentarios del registro
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('comment-input-registro')) {
                const fecha = e.target.getAttribute('data-fecha');
                const operativa = e.target.getAttribute('data-operativa');
                const nuevoComentario = e.target.value;
                
                // Debounce - guardar despu√©s de 1 segundo sin escribir
                clearTimeout(e.target.saveTimeout);
                e.target.saveTimeout = setTimeout(() => {
                    guardarComentarioEditado(fecha, operativa, nuevoComentario);
                }, 1000);
            }
        });

        // Event listener para detectar cambios en el dropdown de acciones del registro
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('action-select-registro')) {
                const fecha = e.target.getAttribute('data-fecha');
                const operativa = e.target.getAttribute('data-operativa');
                const nuevaAccion = e.target.value;
                
                guardarAccionEditada(fecha, operativa, nuevaAccion);
            }
            
            // Event listener para detectar cambios en el n√∫mero de semana del registro
            if (e.target.classList.contains('semana-input-registro')) {
                const fecha = e.target.getAttribute('data-fecha');
                const operativa = e.target.getAttribute('data-operativa');
                const nuevaSemana = e.target.value;
                
                if (nuevaSemana) {
                    guardarSemanaEditada(fecha, operativa, nuevaSemana);
                }
            }
        });

        // ==================== FUNCIONES INFORME MENSUAL ====================
        
        // Funci√≥n para actualizar el enlace de Metabase
        function actualizarEnlaceMetabase() {
            const fechaInicio = document.getElementById('metabaseFechaInicio').value;
            const fechaFin = document.getElementById('metabaseFechaFin').value;
            const metabaseLink = document.getElementById('metabaseLink');
            
            if (fechaInicio && fechaFin) {
                const url = `https://metabase.prod.monline/question/29112-contrastacion-operativas?hive_code=&area=&llegada_en_hora_holgura=&llegada_en_hora_tensionada=&retraso_area_tensionada=&shift=&fecha_inicio=${fechaInicio}&retraso_holgura=&volumen_ok=&fecha_fin=${fechaFin}`;
                metabaseLink.href = url;
                metabaseLink.style.opacity = '1';
                metabaseLink.style.pointerEvents = 'auto';
            } else {
                metabaseLink.href = '#';
                metabaseLink.style.opacity = '0.5';
                metabaseLink.style.pointerEvents = 'none';
            }
        }
        
        // Inicializar fechas por defecto (√∫ltimos 7 d√≠as)
        function inicializarFechasMetabase() {
            const hoy = new Date();
            const hace7dias = new Date();
            hace7dias.setDate(hoy.getDate() - 7);
            
            const formatoFecha = (fecha) => {
                const a√±o = fecha.getFullYear();
                const mes = String(fecha.getMonth() + 1).padStart(2, '0');
                const dia = String(fecha.getDate()).padStart(2, '0');
                return `${a√±o}-${mes}-${dia}`;
            };
            
            document.getElementById('metabaseFechaInicio').value = formatoFecha(hace7dias);
            document.getElementById('metabaseFechaFin').value = formatoFecha(hoy);
            
            actualizarEnlaceMetabase();
        }
        
        async function inicializarInforme() {
            try {
                const response = await fetch(`${JSONBIN_CONFIG.apiUrl}/b/${JSONBIN_CONFIG.binId}/latest`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': JSONBIN_CONFIG.masterKey,
                        'X-Bin-Meta': 'false'
                    }
                });

                if (!response.ok) return;

                const data = await response.json();
                const registros = data.record?.registros || data.registros || [];
                
                // Obtener semanas √∫nicas
                const semanas = [...new Set(registros.map(r => r.semana))].filter(s => s).sort((a, b) => b - a);
                
                // Poblar los selectores
                const selectDesde = document.getElementById('informeSemanaDesde');
                const selectHasta = document.getElementById('informeSemanaHasta');
                
                selectDesde.innerHTML = '<option value="">Seleccionar...</option>' + 
                    semanas.map(s => `<option value="${s}">Semana ${s}</option>`).join('');
                selectHasta.innerHTML = '<option value="">Seleccionar...</option>' + 
                    semanas.map(s => `<option value="${s}">Semana ${s}</option>`).join('');
                
            } catch (error) {
                console.error('Error al inicializar informe:', error);
            }
        }

        async function generarInforme() {
            const semanaDesde = parseInt(document.getElementById('informeSemanaDesde').value);
            const semanaHasta = parseInt(document.getElementById('informeSemanaHasta').value);
            
            if (!semanaDesde || !semanaHasta) {
                alert('Por favor selecciona ambas semanas');
                return;
            }
            
            if (semanaDesde > semanaHasta) {
                alert('La semana inicial debe ser menor o igual a la semana final');
                return;
            }
            
            try {
                const response = await fetch(`${JSONBIN_CONFIG.apiUrl}/b/${JSONBIN_CONFIG.binId}/latest`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': JSONBIN_CONFIG.masterKey,
                        'X-Bin-Meta': 'false'
                    }
                });

                if (!response.ok) {
                    throw new Error('Error al cargar registros');
                }

                const data = await response.json();
                const registros = data.record?.registros || data.registros || [];
                
                // Filtrar por rango de semanas
                const registrosFiltrados = registros.filter(r => 
                    r.semana >= semanaDesde && r.semana <= semanaHasta
                );
                
                if (registrosFiltrados.length === 0) {
                    document.getElementById('informeContainer').innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #6b7280;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #f59e0b; margin-bottom: 1rem;"></i>
                            <h3>Sin datos</h3>
                            <p>No hay registros en el rango de semanas seleccionado</p>
                        </div>
                    `;
                    return;
                }
                
                // Calcular estad√≠sticas
                const stats = calcularEstadisticasInforme(registrosFiltrados);
                
                // Mostrar informe
                mostrarInforme(stats, semanaDesde, semanaHasta, registrosFiltrados);
                
            } catch (error) {
                console.error('Error al generar informe:', error);
                alert('Error al generar el informe: ' + error.message);
            }
        }

        function calcularEstadisticasInforme(registros) {
            const stats = {
                totalOperativas: registros.length,
                porClasificacion: {},
                porAccion: {},
                porAccionTensionadas: {}, // Solo tensionadas
                porColmena: {},
                porColmenaTensionadas: {}, // Solo tensionadas
                clasificacionVsAccion: {}, // Nueva matriz de relaci√≥n
                operativasRecurrentes: [],
                mejorasPorcentuales: {
                    salida: [],
                    llegada: []
                },
                distribucionSemanal: {}
            };
            
            // Contadores
            let sumaSalida = 0, sumaLlegadaArea = 0, sumaRetrasoArea = 0, sumaLlegadaHora = 0;
            let conteoMetricas = 0;
            
            // Agrupar por operativa para detectar recurrentes
            const operativasPorNombre = {};
            
            registros.forEach(reg => {
                // Por clasificaci√≥n
                const clasificacion = reg.clasificacion || 'Sin Clasificar';
                const esTensionada = clasificacion.includes('Tensionada');
                stats.porClasificacion[clasificacion] = (stats.porClasificacion[clasificacion] || 0) + 1;
                
                // Por acci√≥n (todos)
                const accion = reg.accion || 'Sin acci√≥n';
                stats.porAccion[accion] = (stats.porAccion[accion] || 0) + 1;
                
                // Por acci√≥n (solo tensionadas)
                if (esTensionada) {
                    stats.porAccionTensionadas[accion] = (stats.porAccionTensionadas[accion] || 0) + 1;
                }
                
                // Relaci√≥n Clasificaci√≥n vs Acci√≥n
                if (!stats.clasificacionVsAccion[clasificacion]) {
                    stats.clasificacionVsAccion[clasificacion] = {};
                }
                stats.clasificacionVsAccion[clasificacion][accion] = 
                    (stats.clasificacionVsAccion[clasificacion][accion] || 0) + 1;
                
                // Por colmena (todos)
                const colmena = reg.colmena || 'Sin colmena';
                stats.porColmena[colmena] = (stats.porColmena[colmena] || 0) + 1;
                
                // Por colmena (solo tensionadas)
                if (esTensionada) {
                    stats.porColmenaTensionadas[colmena] = (stats.porColmenaTensionadas[colmena] || 0) + 1;
                }
                
                // Distribuci√≥n semanal
                const semana = reg.semana || 0;
                if (!stats.distribucionSemanal[semana]) {
                    stats.distribucionSemanal[semana] = {
                        total: 0,
                        tensionadas: 0,
                        conHolgura: 0
                    };
                }
                stats.distribucionSemanal[semana].total++;
                if (clasificacion.includes('Tensionada')) {
                    stats.distribucionSemanal[semana].tensionadas++;
                }
                if (clasificacion.includes('Holgura')) {
                    stats.distribucionSemanal[semana].conHolgura++;
                }
                
                // Operativas recurrentes
                if (!operativasPorNombre[reg.operativa]) {
                    operativasPorNombre[reg.operativa] = [];
                }
                operativasPorNombre[reg.operativa].push(reg);
                
                // M√©tricas
                if (reg.metricas) {
                    const salida = parseFloat(reg.metricas.porcSalidaEnHora?.replace(',', '.')) || 0;
                    const llegadaHora = parseFloat(reg.metricas.porcLlegadaEnHora?.replace(',', '.')) || 0;
                    
                    if (salida > 0) {
                        stats.mejorasPorcentuales.salida.push(salida);
                        stats.mejorasPorcentuales.llegada.push(llegadaHora);
                    }
                }
            });
            
            // Detectar operativas recurrentes (aparecen m√°s de 1 vez)
            Object.entries(operativasPorNombre).forEach(([nombre, apariciones]) => {
                if (apariciones.length > 1) {
                    stats.operativasRecurrentes.push({
                        operativa: nombre,
                        veces: apariciones.length,
                        semanas: apariciones.map(a => a.semana).sort((a, b) => a - b),
                        clasificaciones: apariciones.map(a => a.clasificacion),
                        acciones: apariciones.map(a => a.accion || 'Sin acci√≥n')
                    });
                }
            });
            
            // Ordenar recurrentes por n√∫mero de apariciones
            stats.operativasRecurrentes.sort((a, b) => b.veces - a.veces);
            
            return stats;
        }

        function mostrarInforme(stats, semanaDesde, semanaHasta, registros) {
            const container = document.getElementById('informeContainer');
            
            const html = `
                <!-- Relaci√≥n Clasificaci√≥n vs Acciones -->
                <div style="background: #1f2937; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 2rem;">
                    <h3 style="color: #f9fafb; font-size: 1.125rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-network-wired"></i>
                        Relaci√≥n: Clasificaci√≥n ‚Üí Acciones Tomadas
                    </h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #374151;">
                                    <th style="padding: 0.75rem; text-align: left; color: #f9fafb; font-size: 0.875rem; border: 1px solid #4b5563;">Clasificaci√≥n</th>
                                    <th style="padding: 0.75rem; text-align: center; color: #f9fafb; font-size: 0.875rem; border: 1px solid #4b5563;">Ajuste tiempo</th>
                                    <th style="padding: 0.75rem; text-align: center; color: #f9fafb; font-size: 0.875rem; border: 1px solid #4b5563;">Ajuste productividad</th>
                                    <th style="padding: 0.75rem; text-align: center; color: #f9fafb; font-size: 0.875rem; border: 1px solid #4b5563;">Ajuste prod/tiempo</th>
                                    <th style="padding: 0.75rem; text-align: center; color: #f9fafb; font-size: 0.875rem; border: 1px solid #4b5563;">Sin acci√≥n</th>
                                    <th style="padding: 0.75rem; text-align: center; color: #f9fafb; font-size: 0.875rem; border: 1px solid #4b5563;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(stats.clasificacionVsAccion).map(([clasificacion, acciones]) => {
                                    const total = Object.values(acciones).reduce((sum, val) => sum + val, 0);
                                    return `
                                        <tr style="border-bottom: 1px solid #374151;">
                                            <td style="padding: 0.75rem; color: #e5e7eb; font-size: 0.875rem; border: 1px solid #4b5563;">
                                                <span class="status-badge ${getStatusClass(clasificacion)}" style="font-size: 0.75rem;">${clasificacion}</span>
                                            </td>
                                            <td style="padding: 0.75rem; text-align: center; color: #d1d5db; font-size: 0.875rem; border: 1px solid #4b5563;">
                                                ${acciones['Ajuste tiempo'] || 0} ${acciones['Ajuste tiempo'] ? `<span style="font-size: 0.75rem; color: #9ca3af;">(${((acciones['Ajuste tiempo']/total)*100).toFixed(0)}%)</span>` : ''}
                                            </td>
                                            <td style="padding: 0.75rem; text-align: center; color: #d1d5db; font-size: 0.875rem; border: 1px solid #4b5563;">
                                                ${acciones['Ajuste productividad'] || 0} ${acciones['Ajuste productividad'] ? `<span style="font-size: 0.75rem; color: #9ca3af;">(${((acciones['Ajuste productividad']/total)*100).toFixed(0)}%)</span>` : ''}
                                            </td>
                                            <td style="padding: 0.75rem; text-align: center; color: #d1d5db; font-size: 0.875rem; border: 1px solid #4b5563;">
                                                ${acciones['Ajuste productividad/tiempo'] || 0} ${acciones['Ajuste productividad/tiempo'] ? `<span style="font-size: 0.75rem; color: #9ca3af;">(${((acciones['Ajuste productividad/tiempo']/total)*100).toFixed(0)}%)</span>` : ''}
                                            </td>
                                            <td style="padding: 0.75rem; text-align: center; color: #d1d5db; font-size: 0.875rem; border: 1px solid #4b5563;">
                                                ${acciones['Sin acci√≥n'] || 0} ${acciones['Sin acci√≥n'] ? `<span style="font-size: 0.75rem; color: #9ca3af;">(${((acciones['Sin acci√≥n']/total)*100).toFixed(0)}%)</span>` : ''}
                                            </td>
                                            <td style="padding: 0.75rem; text-align: center; color: #f9fafb; font-weight: 600; font-size: 0.875rem; border: 1px solid #4b5563; background: #374151;">
                                                ${total}
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Evoluci√≥n Semanal - Gr√°fico de L√≠nea -->
                <div style="background: #1f2937; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 2rem;">
                    <h3 style="color: #f9fafb; font-size: 1.125rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-chart-line"></i>
                        Evoluci√≥n de Operativas Tensionadas
                    </h3>
                    ${generarGraficoLinea(stats.distribucionSemanal)}
                </div>

                <!-- Gr√°ficos de Dona: Acciones por Tipo de Tensionada -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    <!-- Tensionada Llegada -->
                    <div style="background: #1f2937; padding: 1.5rem; border-radius: 0.5rem;">
                        <h3 style="color: #f9fafb; font-size: 1.125rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-clock" style="color: #f59e0b;"></i>
                            Tensionada Llegada ‚Üí Acciones
                        </h3>
                        ${generarGraficoDona(stats.clasificacionVsAccion['Tensionada Llegada'], 'Tensionada Llegada')}
                    </div>

                    <!-- Tensionada Retrasos -->
                    <div style="background: #1f2937; padding: 1.5rem; border-radius: 0.5rem;">
                        <h3 style="color: #f9fafb; font-size: 1.125rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i>
                            Tensionada Retrasos ‚Üí Acciones
                        </h3>
                        ${generarGraficoDona(stats.clasificacionVsAccion['Tensionada Retrasos'], 'Tensionada Retrasos')}
                    </div>
                </div>

                <!-- Por Colmena - Solo Tensionadas -->
                <div style="background: #1f2937; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 2rem;">
                    <h3 style="color: #f9fafb; font-size: 1.125rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-building"></i>
                        Tensionadas por Colmena
                    </h3>
                    ${Object.entries(stats.porColmenaTensionadas).length > 0 ?
                        `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            ${Object.entries(stats.porColmenaTensionadas).map(([colmena, count]) => {
                                const totalTensionadas = Object.values(stats.porColmenaTensionadas).reduce((sum, val) => sum + val, 0);
                                const porcentaje = ((count / totalTensionadas) * 100).toFixed(1);
                                return `
                                    <div style="text-align: center; padding: 1rem; background: #374151; border-radius: 0.375rem;">
                                        <div style="font-size: 2.5rem; font-weight: 700; color: #ef4444; margin-bottom: 0.25rem;">${porcentaje}%</div>
                                        <div style="font-size: 0.875rem; color: #d1d5db; margin-bottom: 0.25rem;">${colmena.toUpperCase()}</div>
                                        <div style="font-size: 0.75rem; color: #9ca3af;">${count} casos</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>`
                        : '<div style="text-align: center; padding: 2rem; color: #9ca3af; font-size: 0.875rem;">No hay operativas tensionadas en este per√≠odo</div>'
                    }
                </div>
            `;
            
            container.innerHTML = html;
        }

        function generarGraficoLinea(distribucionSemanal) {
            const semanas = Object.keys(distribucionSemanal).map(s => parseInt(s)).sort((a, b) => a - b);
            const datos = semanas.map(s => distribucionSemanal[s].tensionadas);
            
            const maxValor = Math.max(...datos);
            const alturaGrafico = 250;
            const anchoTotal = 800;
            const margenIzq = 40;
            const margenDer = 20;
            const margenArriba = 20;
            const margenAbajo = 40;
            
            const anchoDisponible = anchoTotal - margenIzq - margenDer;
            const alturaDisponible = alturaGrafico - margenArriba - margenAbajo;
            const espacioEntrePuntos = anchoDisponible / (semanas.length - 1 || 1);
            
            // Generar puntos del gr√°fico
            const puntos = semanas.map((semana, i) => {
                const x = margenIzq + (i * espacioEntrePuntos);
                const y = margenArriba + alturaDisponible - ((datos[i] / maxValor) * alturaDisponible);
                return { x, y, valor: datos[i], semana };
            });
            
            // Generar path de la l√≠nea
            const pathData = puntos.map((p, i) => 
                `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`
            ).join(' ');
            
            return `
                <div style="position: relative; width: 100%; padding: 1rem; background: #111827; border-radius: 0.5rem;">
                    <svg width="100%" height="${alturaGrafico}" viewBox="0 0 ${anchoTotal} ${alturaGrafico}" style="overflow: visible;">
                        <!-- L√≠neas de fondo (grid) -->
                        ${[0, 0.25, 0.5, 0.75, 1].map(factor => {
                            const y = margenArriba + alturaDisponible * (1 - factor);
                            const valor = Math.round(maxValor * factor);
                            return `
                                <line x1="${margenIzq}" y1="${y}" x2="${anchoTotal - margenDer}" y2="${y}" 
                                      stroke="#374151" stroke-width="1" stroke-dasharray="4,4"/>
                                <text x="${margenIzq - 10}" y="${y + 4}" fill="#9ca3af" font-size="12" text-anchor="end">${valor}</text>
                            `;
                        }).join('')}
                        
                        <!-- L√≠nea principal -->
                        <path d="${pathData}" fill="none" stroke="#ef4444" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                        
                        <!-- √Årea bajo la l√≠nea -->
                        <path d="${pathData} L ${puntos[puntos.length-1].x} ${margenArriba + alturaDisponible} L ${margenIzq} ${margenArriba + alturaDisponible} Z" 
                              fill="url(#gradient)" opacity="0.2"/>
                        
                        <!-- Puntos -->
                        ${puntos.map(p => `
                            <circle cx="${p.x}" cy="${p.y}" r="5" fill="#ef4444" stroke="#1f2937" stroke-width="2"/>
                            <circle cx="${p.x}" cy="${p.y}" r="8" fill="transparent" class="hover-point" style="cursor: pointer;">
                                <title>Semana ${p.semana}: ${p.valor} tensionadas</title>
                            </circle>
                        `).join('')}
                        
                        <!-- Etiquetas del eje X -->
                        ${puntos.map(p => `
                            <text x="${p.x}" y="${alturaGrafico - 15}" fill="#d1d5db" font-size="12" text-anchor="middle">S${p.semana}</text>
                            <text x="${p.x}" y="${p.y - 15}" fill="#ef4444" font-size="11" font-weight="600" text-anchor="middle">${p.valor}</text>
                        `).join('')}
                        
                        <!-- Gradiente -->
                        <defs>
                            <linearGradient id="gradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#ef4444;stop-opacity:0.6" />
                                <stop offset="100%" style="stop-color:#ef4444;stop-opacity:0" />
                            </linearGradient>
                        </defs>
                    </svg>
                    
                    <div style="text-align: center; margin-top: 0.5rem; color: #9ca3af; font-size: 0.75rem;">
                        Eje Y: N√∫mero de operativas tensionadas | Eje X: Semanas
                    </div>
                </div>
            `;
        }

        function generarGraficoDona(acciones, tipoTensionada) {
            if (!acciones || Object.keys(acciones).length === 0) {
                return `<div style="text-align: center; padding: 3rem; color: #9ca3af; font-size: 0.875rem;">No hay datos de ${tipoTensionada} en este per√≠odo</div>`;
            }
            
            const total = Object.values(acciones).reduce((sum, val) => sum + val, 0);
            const colores = {
                'Ajuste tiempo': '#3b82f6',
                'Ajuste productividad': '#10b981',
                'Ajuste productividad/tiempo': '#8b5cf6',
                'Sin acci√≥n': '#6b7280'
            };
            
            // Calcular √°ngulos para cada segmento
            let anguloActual = -90; // Empezar desde arriba
            const segmentos = Object.entries(acciones).map(([accion, count]) => {
                const porcentaje = (count / total) * 100;
                const angulo = (count / total) * 360;
                const anguloInicio = anguloActual;
                const anguloMedio = anguloActual + (angulo / 2);
                anguloActual += angulo;
                
                return {
                    accion,
                    count,
                    porcentaje,
                    anguloInicio,
                    anguloFin: anguloActual,
                    anguloMedio,
                    color: colores[accion] || '#6b7280'
                };
            });
            
            // Funci√≥n para calcular coordenadas de arco SVG
            const polarACartesiano = (centroX, centroY, radio, angulo) => {
                const radianes = (angulo - 90) * Math.PI / 180.0;
                return {
                    x: centroX + (radio * Math.cos(radianes)),
                    y: centroY + (radio * Math.sin(radianes))
                };
            };
            
            const descripcionArco = (x, y, radio, anguloInicio, anguloFin) => {
                const inicio = polarACartesiano(x, y, radio, anguloFin);
                const fin = polarACartesiano(x, y, radio, anguloInicio);
                const largeArcFlag = anguloFin - anguloInicio <= 180 ? "0" : "1";
                
                return [
                    "M", inicio.x, inicio.y,
                    "A", radio, radio, 0, largeArcFlag, 0, fin.x, fin.y,
                    "L", x, y,
                    "Z"
                ].join(" ");
            };
            
            const centroX = 150;
            const centroY = 150;
            const radioExterno = 120;
            const radioInterno = 70;
            const radioEtiqueta = 95;
            
            return `
                <div style="display: flex; flex-direction: column; align-items: center;">
                    <!-- Gr√°fico de Dona -->
                    <svg width="300" height="300" viewBox="0 0 300 300" style="margin-bottom: 1rem;">
                        ${segmentos.map(seg => {
                            // Calcular posici√≥n de la etiqueta de porcentaje
                            const posEtiqueta = polarACartesiano(centroX, centroY, radioEtiqueta, seg.anguloMedio);
                            return `
                            <g>
                                <!-- Segmento externo -->
                                <path d="${descripcionArco(centroX, centroY, radioExterno, seg.anguloInicio, seg.anguloFin)}"
                                      fill="${seg.color}" opacity="0.9" stroke="#1f2937" stroke-width="2">
                                    <title>${seg.accion}: ${seg.count} (${seg.porcentaje.toFixed(1)}%)</title>
                                </path>
                                
                                <!-- Etiqueta de porcentaje en el segmento -->
                                ${seg.porcentaje >= 8 ? `
                                    <text x="${posEtiqueta.x}" y="${posEtiqueta.y}" 
                                          text-anchor="middle" 
                                          fill="#ffffff" 
                                          font-size="14" 
                                          font-weight="700"
                                          style="pointer-events: none;">
                                        ${seg.porcentaje.toFixed(0)}%
                                    </text>
                                ` : ''}
                            </g>
                        `}).join('')}
                        
                        <!-- Agujero interno para efecto dona -->
                        <circle cx="${centroX}" cy="${centroY}" r="${radioInterno}" fill="#1f2937"/>
                        
                        <!-- Texto central con porcentaje del total de tensionadas -->
                        <text x="${centroX}" y="${centroY - 10}" text-anchor="middle" fill="#f9fafb" font-size="32" font-weight="700">${total}</text>
                        <text x="${centroX}" y="${centroY + 15}" text-anchor="middle" fill="#9ca3af" font-size="14">casos</text>
                    </svg>
                    
                    <!-- Leyenda -->
                    <div style="display: grid; grid-template-columns: 1fr; gap: 0.5rem; width: 100%;">
                        ${segmentos.map(seg => `
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.5rem; background: #374151; border-radius: 0.375rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div style="width: 12px; height: 12px; background: ${seg.color}; border-radius: 2px;"></div>
                                    <span style="font-size: 0.875rem; color: #d1d5db;">${seg.accion}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <span style="font-size: 0.875rem; font-weight: 600; color: #f9fafb;">${seg.count}</span>
                                    <span style="font-size: 0.75rem; color: #9ca3af; min-width: 45px; text-align: right;">${seg.porcentaje.toFixed(1)}%</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Event listeners para los botones del registro - usar setTimeout para asegurar que existan
        setTimeout(() => {
            const saveBtn = document.getElementById('saveRegistroBtn');
            const reloadBtn = document.getElementById('reloadRegistroBtn');
            const filtroSemana = document.getElementById('filtroSemana');
            const filtroColmena = document.getElementById('filtroColmena');
            const filtroArea = document.getElementById('filtroArea');
            const limpiarBtn = document.getElementById('limpiarFiltrosBtn');
            const generarInformeBtn = document.getElementById('generarInformeBtn');
            const fechaInicioMetabase = document.getElementById('metabaseFechaInicio');
            const fechaFinMetabase = document.getElementById('metabaseFechaFin');
            
            if (saveBtn) saveBtn.addEventListener('click', saveRegistroToJsonBin);
            if (reloadBtn) reloadBtn.addEventListener('click', () => loadRegistro(false));
            if (filtroSemana) filtroSemana.addEventListener('change', () => loadRegistro(true));
            if (filtroColmena) filtroColmena.addEventListener('change', () => loadRegistro(true));
            if (filtroArea) filtroArea.addEventListener('change', () => loadRegistro(true));
            if (limpiarBtn) {
                limpiarBtn.addEventListener('click', () => {
                    if (filtroSemana) filtroSemana.value = '';
                    if (filtroColmena) filtroColmena.value = '';
                    if (filtroArea) filtroArea.value = '';
                    loadRegistro(true);
                });
            }
            if (generarInformeBtn) {
                generarInformeBtn.addEventListener('click', generarInforme);
            }
            
            // Event listeners para fechas de Metabase
            if (fechaInicioMetabase) {
                fechaInicioMetabase.addEventListener('change', actualizarEnlaceMetabase);
            }
            if (fechaFinMetabase) {
                fechaFinMetabase.addEventListener('change', actualizarEnlaceMetabase);
            }
            
            // Inicializar fechas por defecto
            inicializarFechasMetabase();
        }, 100);

        // Funci√≥n para descargar Excel del Registro
        document.getElementById('downloadRegistroExcelBtn').addEventListener('click', async function() {
            try {
                // Cargar registros desde JSONBin
                const response = await fetch(`${JSONBIN_CONFIG.apiUrl}/b/${JSONBIN_CONFIG.binId}/latest`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': JSONBIN_CONFIG.masterKey,
                        'X-Bin-Meta': 'false'
                    }
                });

                if (!response.ok) {
                    throw new Error('Error al cargar registros');
                }

                const data = await response.json();
                let registros = [];
                
                if (data.record && data.record.registros) {
                    registros = data.record.registros;
                } else if (data.record && Array.isArray(data.record)) {
                    registros = data.record;
                } else if (data.registros) {
                    registros = data.registros;
                } else if (Array.isArray(data)) {
                    registros = data;
                }

                if (registros.length === 0) {
                    alert('No hay registros para descargar');
                    return;
                }

                // Funci√≥n auxiliar para crear texto de recomendaciones
                function createPlainTextRecommendations(reg) {
                    if (reg.recomendaciones && Array.isArray(reg.recomendaciones)) {
                        return reg.recomendaciones.join('; ');
                    }
                    return '';
                }

                // Preparar datos en el mismo formato que el Excel de an√°lisis
                const excelData = registros.map(reg => ({
                    'Colmena': reg.colmena || extractColmena(reg.operativa) || '',
                    'Operativa': reg.operativa || '',
                    'Repetida': reg.esRepetida ? 'S√ç' : 'NO',
                    'Fecha Anterior': reg.esRepetida && reg.infoRepetida ? reg.infoRepetida.fechaAnterior : '',
                    'Semana Anterior': reg.esRepetida && reg.infoRepetida ? reg.infoRepetida.semanaAnterior : '',
                    'Comentario Anterior': reg.esRepetida && reg.infoRepetida ? reg.infoRepetida.comentarioAnterior : '',
                    'Acci√≥n Anterior': reg.esRepetida && reg.infoRepetida ? reg.infoRepetida.accionAnterior : '',
                    'Rutas por D√≠a': formatValue(reg.metricas?.rutasDia),
                    'D√≠as': formatValue(reg.metricas?.dias),
                    'Columnas por Ruta': formatValue(reg.metricas?.colPorRuta),
                    '% Retrasos': formatValue(reg.metricas?.porcRetrasos),
                    '% Salida en Hora': formatValue(reg.metricas?.porcSalidaEnHora),
                    '% Llegada √Årea': formatValue(reg.metricas?.porcLlegadaArea),
                    '% Retraso en √Årea': formatValue(reg.metricas?.porcRetrasoEnArea),
                    '% Llegada en Hora': formatValue(reg.metricas?.porcLlegadaEnHora),
                    'Clasificaci√≥n': reg.clasificacion || '',
                    'Problemas de Volumen': reg.volumeProblems ? reg.volumeProblems.message : '',
                    'Posibles Acciones': createPlainTextRecommendations(reg),
                    'Acci√≥n Tomada': reg.accion || '',
                    'Comentarios': reg.comentario || '',
                    '': '', // Columna en blanco
                    'Col Te√≥ricas': formatValue(reg.metricas?.colTeorica),
                    'PD Te√≥rico': formatValue(reg.metricas?.pdTeorico),
                    'UD Te√≥rico': formatValue(reg.metricas?.udTeorico),
                    'Col Tempus': formatValue(reg.metricas?.colTempus),
                    'PD Tempus': formatValue(reg.metricas?.pdTempus),
                    'UD Tempus': formatValue(reg.metricas?.udTempus),
                    'Col Volumen': formatValue(reg.metricas?.colVolumen),
                    'Fecha An√°lisis': reg.fechaFormateada || '',
                    'Semana': reg.semana || ''
                }));

                // Crear workbook de Excel
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);
                
                // Configurar ancho de columnas
                const columnWidths = [
                    { wch: 10 }, // Colmena
                    { wch: 25 }, // Operativa
                    { wch: 10 }, // Repetida
                    { wch: 15 }, // Fecha Anterior
                    { wch: 15 }, // Semana Anterior
                    { wch: 30 }, // Comentario Anterior
                    { wch: 20 }, // Acci√≥n Anterior
                    { wch: 12 }, // Rutas por D√≠a
                    { wch: 8 },  // D√≠as
                    { wch: 15 }, // Columnas por Ruta
                    { wch: 10 }, // % Retrasos
                    { wch: 15 }, // % Salida en Hora
                    { wch: 15 }, // % Llegada √Årea
                    { wch: 18 }, // % Retraso en √Årea
                    { wch: 18 }, // % Llegada en Hora
                    { wch: 18 }, // Clasificaci√≥n
                    { wch: 20 }, // Problemas de Volumen
                    { wch: 50 }, // Posibles Acciones
                    { wch: 20 }, // Acci√≥n Tomada
                    { wch: 30 }, // Comentarios
                    { wch: 3 },  // Columna en blanco
                    { wch: 12 }, // Col Te√≥ricas
                    { wch: 12 }, // PD Te√≥rico
                    { wch: 12 }, // UD Te√≥rico
                    { wch: 12 }, // Col Tempus
                    { wch: 12 }, // PD Tempus
                    { wch: 12 }, // UD Tempus
                    { wch: 12 }, // Col Volumen
                    { wch: 15 }, // Fecha An√°lisis
                    { wch: 8 }   // Semana
                ];
                ws['!cols'] = columnWidths;
                
                // Agregar hoja al workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Registro Operativo');
                
                // Descargar archivo
                const fechaArchivo = new Date().toISOString().split('T')[0];
                XLSX.writeFile(wb, `registro_operativo_${fechaArchivo}.xlsx`);
                
                // Visual feedback
                const btn = document.getElementById('downloadRegistroExcelBtn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Descargado';
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                }, 2000);

            } catch (error) {
                console.error('Error al descargar Excel del registro:', error);
                alert('Error al descargar el Excel: ' + error.message);
            }
        });

        // Funci√≥n para descargar Excel del Informe Mensual
        document.getElementById('downloadInformeExcelBtn').addEventListener('click', async function() {
            const semanaDesde = parseInt(document.getElementById('informeSemanaDesde').value);
            const semanaHasta = parseInt(document.getElementById('informeSemanaHasta').value);
            
            if (!semanaDesde || !semanaHasta) {
                alert('Por favor genera primero el informe seleccionando las semanas');
                return;
            }
            
            try {
                const response = await fetch(`${JSONBIN_CONFIG.apiUrl}/b/${JSONBIN_CONFIG.binId}/latest`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': JSONBIN_CONFIG.masterKey,
                        'X-Bin-Meta': 'false'
                    }
                });

                if (!response.ok) {
                    throw new Error('Error al cargar registros');
                }

                const data = await response.json();
                const registros = data.record?.registros || data.registros || [];
                
                // Filtrar por rango de semanas
                const registrosFiltrados = registros.filter(r => 
                    r.semana >= semanaDesde && r.semana <= semanaHasta
                );
                
                if (registrosFiltrados.length === 0) {
                    alert('No hay datos en el rango de semanas seleccionado');
                    return;
                }
                
                // Calcular estad√≠sticas
                const stats = calcularEstadisticasInforme(registrosFiltrados);
                
                // Crear workbook de Excel
                const wb = XLSX.utils.book_new();
                
                // HOJA 1: Resumen General
                const resumenData = [
                    ['INFORME MENSUAL DE OPERATIVAS'],
                    [`Per√≠odo: Semana ${semanaDesde} a Semana ${semanaHasta}`],
                    [`Fecha de generaci√≥n: ${new Date().toLocaleDateString('es-ES')}`],
                    [],
                    ['RESUMEN GENERAL'],
                    ['Total de Operativas Analizadas', stats.totalOperativas],
                    [],
                    ['DISTRIBUCI√ìN POR CLASIFICACI√ìN'],
                    ['Clasificaci√≥n', 'Cantidad', 'Porcentaje'],
                    ...Object.entries(stats.porClasificacion).map(([clas, count]) => 
                        [clas, count, `${((count/stats.totalOperativas)*100).toFixed(1)}%`]
                    ),
                    [],
                    ['ACCIONES TOMADAS (TODAS LAS OPERATIVAS)'],
                    ['Acci√≥n', 'Cantidad', 'Porcentaje'],
                    ...Object.entries(stats.porAccion).map(([accion, count]) => 
                        [accion, count, `${((count/stats.totalOperativas)*100).toFixed(1)}%`]
                    ),
                    [],
                    ['ACCIONES EN OPERATIVAS TENSIONADAS'],
                    ['Acci√≥n', 'Cantidad', 'Porcentaje'],
                    ...Object.entries(stats.porAccionTensionadas).map(([accion, count]) => {
                        const totalTensionadas = Object.values(stats.porAccionTensionadas).reduce((sum, val) => sum + val, 0);
                        return [accion, count, `${((count/totalTensionadas)*100).toFixed(1)}%`];
                    }),
                    [],
                    ['DISTRIBUCI√ìN POR COLMENA (TODAS)'],
                    ['Colmena', 'Total Operativas', 'Porcentaje'],
                    ...Object.entries(stats.porColmena).map(([colmena, count]) => 
                        [colmena, count, `${((count/stats.totalOperativas)*100).toFixed(1)}%`]
                    ),
                    [],
                    ['TENSIONADAS POR COLMENA'],
                    ['Colmena', 'Tensionadas', 'Porcentaje del Total'],
                    ...Object.entries(stats.porColmenaTensionadas).map(([colmena, count]) => {
                        const totalTensionadas = Object.values(stats.porColmenaTensionadas).reduce((sum, val) => sum + val, 0);
                        return [colmena, count, `${((count/totalTensionadas)*100).toFixed(1)}%`];
                    })
                ];
                
                const wsResumen = XLSX.utils.aoa_to_sheet(resumenData);
                wsResumen['!cols'] = [{ wch: 40 }, { wch: 20 }, { wch: 15 }];
                XLSX.utils.book_append_sheet(wb, wsResumen, 'Resumen General');
                
                // HOJA 2: Relaci√≥n Clasificaci√≥n vs Acci√≥n
                const relacionData = [
                    ['RELACI√ìN: CLASIFICACI√ìN ‚Üí ACCIONES TOMADAS'],
                    [],
                    ['Clasificaci√≥n', 'Ajuste tiempo', 'Ajuste productividad', 'Ajuste prod/tiempo', 'Sin acci√≥n', 'Total']
                ];
                
                Object.entries(stats.clasificacionVsAccion).forEach(([clasificacion, acciones]) => {
                    const total = Object.values(acciones).reduce((sum, val) => sum + val, 0);
                    relacionData.push([
                        clasificacion,
                        acciones['Ajuste tiempo'] || 0,
                        acciones['Ajuste productividad'] || 0,
                        acciones['Ajuste productividad/tiempo'] || 0,
                        acciones['Sin acci√≥n'] || 0,
                        total
                    ]);
                });
                
                const wsRelacion = XLSX.utils.aoa_to_sheet(relacionData);
                wsRelacion['!cols'] = [{ wch: 25 }, { wch: 15 }, { wch: 20 }, { wch: 20 }, { wch: 12 }, { wch: 10 }];
                XLSX.utils.book_append_sheet(wb, wsRelacion, 'Clasificaci√≥n vs Acci√≥n');
                
                // HOJA 3: Evoluci√≥n Semanal
                const evolucionData = [
                    ['EVOLUCI√ìN DE OPERATIVAS POR SEMANA'],
                    [],
                    ['Semana', 'Total', 'Tensionadas', 'Con Holgura', '% Tensionadas']
                ];
                
                Object.entries(stats.distribucionSemanal).forEach(([semana, datos]) => {
                    evolucionData.push([
                        `Semana ${semana}`,
                        datos.total,
                        datos.tensionadas,
                        datos.conHolgura,
                        `${((datos.tensionadas/datos.total)*100).toFixed(1)}%`
                    ]);
                });
                
                const wsEvolucion = XLSX.utils.aoa_to_sheet(evolucionData);
                wsEvolucion['!cols'] = [{ wch: 15 }, { wch: 10 }, { wch: 15 }, { wch: 15 }, { wch: 15 }];
                XLSX.utils.book_append_sheet(wb, wsEvolucion, 'Evoluci√≥n Semanal');
                
                // HOJA 4: Operativas Recurrentes
                if (stats.operativasRecurrentes.length > 0) {
                    const recurrentesData = [
                        ['OPERATIVAS RECURRENTES (aparecen m√∫ltiples veces)'],
                        [],
                        ['Operativa', 'Veces', 'Semanas', 'Clasificaciones', 'Acciones']
                    ];
                    
                    stats.operativasRecurrentes.forEach(op => {
                        recurrentesData.push([
                            op.operativa,
                            op.veces,
                            op.semanas.join(', '),
                            op.clasificaciones.join(', '),
                            op.acciones.join(', ')
                        ]);
                    });
                    
                    const wsRecurrentes = XLSX.utils.aoa_to_sheet(recurrentesData);
                    wsRecurrentes['!cols'] = [{ wch: 30 }, { wch: 8 }, { wch: 15 }, { wch: 30 }, { wch: 30 }];
                    XLSX.utils.book_append_sheet(wb, wsRecurrentes, 'Operativas Recurrentes');
                }
                
                // HOJA 5: Detalle Completo
                const detalleData = registrosFiltrados.map(reg => ({
                    'Semana': reg.semana || '',
                    'Fecha': reg.fechaFormateada || '',
                    'Colmena': reg.colmena || extractColmena(reg.operativa) || '',
                    'Operativa': reg.operativa || '',
                    'Clasificaci√≥n': reg.clasificacion || '',
                    'Acci√≥n Tomada': reg.accion || '',
                    '% Salida en Hora': formatValue(reg.metricas?.porcSalidaEnHora),
                    '% Llegada √Årea': formatValue(reg.metricas?.porcLlegadaArea),
                    '% Retraso en √Årea': formatValue(reg.metricas?.porcRetrasoEnArea),
                    '% Llegada en Hora': formatValue(reg.metricas?.porcLlegadaEnHora),
                    'Repetida': reg.esRepetida ? 'S√ç' : 'NO',
                    'Comentarios': reg.comentario || ''
                }));
                
                const wsDetalle = XLSX.utils.json_to_sheet(detalleData);
                wsDetalle['!cols'] = [
                    { wch: 8 }, { wch: 12 }, { wch: 10 }, { wch: 25 }, { wch: 20 },
                    { wch: 20 }, { wch: 15 }, { wch: 15 }, { wch: 18 }, { wch: 18 },
                    { wch: 10 }, { wch: 40 }
                ];
                XLSX.utils.book_append_sheet(wb, wsDetalle, 'Detalle Completo');
                
                // Descargar archivo
                const fechaArchivo = new Date().toISOString().split('T')[0];
                XLSX.writeFile(wb, `informe_mensual_S${semanaDesde}-S${semanaHasta}_${fechaArchivo}.xlsx`);
                
                // Visual feedback
                const btn = document.getElementById('downloadInformeExcelBtn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Descargado';
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                }, 2000);

            } catch (error) {
                console.error('Error al descargar Excel del informe:', error);
                alert('Error al descargar el Excel: ' + error.message);
            }
        });
    </script>
</body>
</html>
